<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>XPU-DSAM7S: src/inc/sam7xpud.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_c3cf2c74c7940f3e35baf1198f30407c.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_0ac38a7dae44175058684dd30d12e64d.html">inc</a>
  </div>
</div>
</div>
<h1>sam7xpud.hpp</h1><a href="sam7xpud_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifndef _SAM7XPUD_H_INCLUDED</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#define _SAM7XPUD_H_INCLUDED</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span>
<a name="l00004"></a>00004 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00005"></a>00005 <span class="comment">//      Common, hardware description and trace includes</span>
<a name="l00006"></a>00006 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="common_8h.html">common.h</a>"</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include "<a class="code" href="device_8h.html">device.h</a>"</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include "<a class="code" href="board_8h.html">board.h</a>"</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="trace_8h.html">trace.h</a>"</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00013"></a>00013 <span class="comment">//      FPGA hardware description</span>
<a name="l00014"></a>00014 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="fpga_8hpp.html">fpga.hpp</a>"</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00018"></a>00018 <span class="comment">//      USB Framework includes</span>
<a name="l00019"></a>00019 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="usb_framework_8hpp.html">usbFramework.hpp</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="usb_c_d_c_8hpp.html">usbCDC.hpp</a>"</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00024"></a>00024 <span class="comment">//      Scheduler includes</span>
<a name="l00025"></a>00025 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "FreeRTOS.h"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "task.h"</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include "queue.h"</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include "<a class="code" href="sema_8hpp.html">sema.hpp</a>"</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00033"></a>00033 <span class="comment">//      Backplane interface</span>
<a name="l00034"></a>00034 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include "<a class="code" href="xpi_8hpp.html">xpi.hpp</a>"</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00038"></a>00038 <span class="comment">//      External references &amp; defines</span>
<a name="l00039"></a>00039 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="sam7xpud_8hpp.html#596afaa6febf8a04aff566a536312863">cpu_usage</a>;
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="keyword">extern</span> <a class="code" href="class_u_s_b_1_1_c_c_d_c.html" title="CDC class driver structure.">USB::CCDC</a> <a class="code" href="sam7xpud_8hpp.html#52ff81f95efae6ffb5a185293c19eaf8">sSer</a>;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="sam7xpud_8hpp.html#4df31879215aaf385fd158740b6c0f01">vPortGetMaxHeap</a>( <span class="keywordtype">void</span> );
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">extern</span> <span class="keyword">volatile</span> portBASE_TYPE <a class="code" href="sam7xpud_8hpp.html#8016362bfba98bf35c540ad23a34843e">isTaskWokenByPostInUsbIrq</a>;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="sam7xpud_8hpp.html#3ffbef8314ccf9023edcd7219e79787c">sysDumpStatus</a>( <span class="keywordtype">void</span> );
<a name="l00050"></a>00050 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="xsvf_player_8cpp.html#e93c6daae7373770742d882ffff7db8a">xsvfExecute</a>( <span class="keywordtype">int</span> dbgLevel, <span class="keywordtype">bool</span> parseOnly );
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="sam7xpud_8hpp.html#409e918fc805f7946dff7e20e5887005">us1_putc</a>( <span class="keywordtype">int</span> ch );
<a name="l00053"></a>00053 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="sam7xpud_8hpp.html#04af8901fc5c1015eb79acb36ba38ad6">usb_putc</a>( <span class="keywordtype">int</span> ch );
<a name="l00054"></a>00054 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="sam7xpud_8hpp.html#8afa8c69746a9bd9a2b2bd3ddf0dcae6">null_putc</a>( <span class="keywordtype">int</span> ch );
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="keyword">extern</span> <span class="keyword">volatile</span> <a class="code" href="common_8h.html#718b4eb2652c286f4d42dc18a8e71a1a">ulong</a> <a class="code" href="sam7xpud_8hpp.html#462cea72d27d305f0a70d0b4b37a173f">dTimerTick</a>;
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="sam7xpud_8hpp.html#229662cd89f1a727fd0358c81b4c4f83">00058</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="sam7xpud_8hpp.html#e0854ad0e6228254bc61ac94de01a1a3">verMajor</a>, <a class="code" href="sam7xpud_8hpp.html#229662cd89f1a727fd0358c81b4c4f83">verMinor</a>, <a class="code" href="sam7xpud_8hpp.html#84748cc0956abd727608de67ebeeeffc">verBuild</a>;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00061"></a>00061 <span class="comment">//      USB TRANSMITTER Class</span>
<a name="l00062"></a>00062 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="keyword">enum</span> 
<a name="l00065"></a>00065 { 
<a name="l00066"></a><a class="code" href="sam7xpud_8hpp.html#dc29c2ff13d900c2f185ee95427fb06cc23bc9cc0574415f0a22ed2389bb1f02">00066</a>     <a class="code" href="sam7xpud_8hpp.html#dc29c2ff13d900c2f185ee95427fb06cc23bc9cc0574415f0a22ed2389bb1f02">USB_XMTR_BUF_SIZE</a> = 4096 + 256, 
<a name="l00067"></a><a class="code" href="sam7xpud_8hpp.html#dc29c2ff13d900c2f185ee95427fb06caba55b767751b29a84e8acb3797a5cf5">00067</a>     <a class="code" href="sam7xpud_8hpp.html#dc29c2ff13d900c2f185ee95427fb06caba55b767751b29a84e8acb3797a5cf5">USB_RCVR_BUF_SIZE</a> = 4096, 
<a name="l00068"></a>00068     };
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="class_u_s_b_x_m_t_r.html">00070</a> <span class="keyword">class </span><a class="code" href="class_u_s_b_x_m_t_r.html">USBXMTR</a>
<a name="l00071"></a>00071 {
<a name="l00072"></a><a class="code" href="class_u_s_b_x_m_t_r.html#1e94f3be10e61745a8ad8462e7a55738">00072</a>     <a class="code" href="classx_m_u_t_e_x.html">xMUTEX</a> <a class="code" href="class_u_s_b_x_m_t_r.html#1e94f3be10e61745a8ad8462e7a55738">semaMutex</a>;
<a name="l00073"></a><a class="code" href="class_u_s_b_x_m_t_r.html#ec3970652da3b907f4bbc539662c94a1">00073</a>     <a class="code" href="classx_s_e_m_a.html">xSEMA</a> <a class="code" href="class_u_s_b_x_m_t_r.html#ec3970652da3b907f4bbc539662c94a1">semaFull</a>;
<a name="l00074"></a><a class="code" href="class_u_s_b_x_m_t_r.html#66b4fc1585c7eba3b3f509c5ce5ce20b">00074</a>     <a class="code" href="classx_s_e_m_a.html">xSEMA</a> <a class="code" href="class_u_s_b_x_m_t_r.html#66b4fc1585c7eba3b3f509c5ce5ce20b">semaEmpty</a>;
<a name="l00075"></a><a class="code" href="class_u_s_b_x_m_t_r.html#0c7380741c8b5b4af8b868b4107e0809">00075</a>     <a class="code" href="classx_s_e_m_a.html">xSEMA</a> <a class="code" href="class_u_s_b_x_m_t_r.html#0c7380741c8b5b4af8b868b4107e0809">semaSent</a>;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="comment">// Circular buffer of MSGBUF packets.</span>
<a name="l00078"></a>00078     <span class="comment">//</span>
<a name="l00079"></a>00079     <span class="comment">// MSGBUF Packet format:</span>
<a name="l00080"></a>00080     <span class="comment">//    Header:</span>
<a name="l00081"></a>00081     <span class="comment">//       uint8 len_MSB</span>
<a name="l00082"></a>00082     <span class="comment">//       uint8 len_LSB</span>
<a name="l00083"></a>00083     <span class="comment">//    Body:</span>
<a name="l00084"></a>00084     <span class="comment">//       uint8 data[len]</span>
<a name="l00085"></a>00085     <span class="comment">//</span>
<a name="l00086"></a><a class="code" href="class_u_s_b_x_m_t_r.html#060ed241f71578162097f86d7571d383">00086</a>     <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>  <a class="code" href="class_u_s_b_x_m_t_r.html#060ed241f71578162097f86d7571d383">buf</a>[ <a class="code" href="sam7xpud_8hpp.html#dc29c2ff13d900c2f185ee95427fb06cc23bc9cc0574415f0a22ed2389bb1f02">USB_XMTR_BUF_SIZE</a> ];
<a name="l00087"></a><a class="code" href="class_u_s_b_x_m_t_r.html#234c4e6e5ca3006b7eb3dc2921bc65ca">00087</a>     <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>   <a class="code" href="class_u_s_b_x_m_t_r.html#234c4e6e5ca3006b7eb3dc2921bc65ca">bufSize</a>;
<a name="l00088"></a>00088  
<a name="l00089"></a><a class="code" href="class_u_s_b_x_m_t_r.html#d185796d123768412fb1bd6a9a3b1920">00089</a>     <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>* <a class="code" href="class_u_s_b_x_m_t_r.html#d185796d123768412fb1bd6a9a3b1920">pRead</a>;
<a name="l00090"></a><a class="code" href="class_u_s_b_x_m_t_r.html#f3c368649fcfaaddf034773b9336c9ac">00090</a>     <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>* <a class="code" href="class_u_s_b_x_m_t_r.html#f3c368649fcfaaddf034773b9336c9ac">pWrite</a>;
<a name="l00091"></a><a class="code" href="class_u_s_b_x_m_t_r.html#5ebbd1a851b22570b8a3c7212e8ea049">00091</a>     <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>* <a class="code" href="class_u_s_b_x_m_t_r.html#5ebbd1a851b22570b8a3c7212e8ea049">pMax</a>;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093     <span class="comment">// CCDC::Write callback status</span>
<a name="l00094"></a><a class="code" href="class_u_s_b_x_m_t_r.html#ef974a6c2900d398319240f8e8f47693">00094</a>     <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="class_u_s_b_x_m_t_r.html#ef974a6c2900d398319240f8e8f47693">bStatus</a>;
<a name="l00095"></a><a class="code" href="class_u_s_b_x_m_t_r.html#02bde5735862ed62571c598eefbeb07e">00095</a>     <span class="keyword">volatile</span> <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_u_s_b_x_m_t_r.html#02bde5735862ed62571c598eefbeb07e">dBytesTransferred</a>;
<a name="l00096"></a><a class="code" href="class_u_s_b_x_m_t_r.html#3a1d8837cf787aa4d784ea7a030096ba">00096</a>     <span class="keyword">volatile</span> <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_u_s_b_x_m_t_r.html#3a1d8837cf787aa4d784ea7a030096ba">dBytesRemaining</a>;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="class_u_s_b_x_m_t_r.html#0f021ea11f20d04321548526f2313291">OnSendCompleted</a>
<a name="l00099"></a><a class="code" href="class_u_s_b_x_m_t_r.html#0f021ea11f20d04321548526f2313291">00099</a>     (
<a name="l00100"></a>00100         <a class="code" href="class_u_s_b_x_m_t_r.html">USBXMTR</a>* pThis,
<a name="l00101"></a>00101         <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a> <a class="code" href="class_u_s_b_x_m_t_r.html#ef974a6c2900d398319240f8e8f47693">bStatus</a>,
<a name="l00102"></a>00102         <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_u_s_b_x_m_t_r.html#02bde5735862ed62571c598eefbeb07e">dBytesTransferred</a>,
<a name="l00103"></a>00103         <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_u_s_b_x_m_t_r.html#3a1d8837cf787aa4d784ea7a030096ba">dBytesRemaining</a>
<a name="l00104"></a>00104         )
<a name="l00105"></a>00105     {
<a name="l00106"></a>00106         pThis-&gt;<a class="code" href="class_u_s_b_x_m_t_r.html#ef974a6c2900d398319240f8e8f47693">bStatus</a> = bStatus;
<a name="l00107"></a>00107         pThis-&gt;<a class="code" href="class_u_s_b_x_m_t_r.html#02bde5735862ed62571c598eefbeb07e">dBytesTransferred</a> = dBytesTransferred;
<a name="l00108"></a>00108         pThis-&gt;<a class="code" href="class_u_s_b_x_m_t_r.html#3a1d8837cf787aa4d784ea7a030096ba">dBytesRemaining</a> = dBytesRemaining;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <span class="keywordflow">if</span> ( pThis-&gt;<a class="code" href="class_u_s_b_x_m_t_r.html#0c7380741c8b5b4af8b868b4107e0809">semaSent</a>.<a class="code" href="classx_s_e_m_a.html#138c0f59a8444912bb8d1c083bad64ed">ReleaseFromISR</a>( 1, <a class="code" href="sam7xpud_8hpp.html#8016362bfba98bf35c540ad23a34843e">isTaskWokenByPostInUsbIrq</a> ) )
<a name="l00111"></a>00111         {
<a name="l00112"></a>00112             <a class="code" href="sam7xpud_8hpp.html#8016362bfba98bf35c540ad23a34843e">isTaskWokenByPostInUsbIrq</a> = pdTRUE;
<a name="l00113"></a>00113             }
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="keyword">public</span>:
<a name="l00117"></a>00117     
<a name="l00118"></a><a class="code" href="class_u_s_b_x_m_t_r.html#185fd9de48282e096a95fe3dae547b8e">00118</a>     <a class="code" href="class_u_s_b_x_m_t_r.html#185fd9de48282e096a95fe3dae547b8e">USBXMTR</a>( <span class="keywordtype">void</span> )
<a name="l00119"></a>00119         : <a class="code" href="class_u_s_b_x_m_t_r.html#ec3970652da3b907f4bbc539662c94a1">semaFull</a>( <a class="code" href="sam7xpud_8hpp.html#dc29c2ff13d900c2f185ee95427fb06cc23bc9cc0574415f0a22ed2389bb1f02">USB_XMTR_BUF_SIZE</a> )
<a name="l00120"></a>00120         , <a class="code" href="class_u_s_b_x_m_t_r.html#66b4fc1585c7eba3b3f509c5ce5ce20b">semaEmpty</a>( 0 )
<a name="l00121"></a>00121         , <a class="code" href="class_u_s_b_x_m_t_r.html#0c7380741c8b5b4af8b868b4107e0809">semaSent</a>( 0 )
<a name="l00122"></a>00122     {
<a name="l00123"></a>00123         <a class="code" href="class_u_s_b_x_m_t_r.html#234c4e6e5ca3006b7eb3dc2921bc65ca">bufSize</a> = <a class="code" href="sam7xpud_8hpp.html#dc29c2ff13d900c2f185ee95427fb06cc23bc9cc0574415f0a22ed2389bb1f02">USB_XMTR_BUF_SIZE</a>;
<a name="l00124"></a>00124         <a class="code" href="class_u_s_b_x_m_t_r.html#d185796d123768412fb1bd6a9a3b1920">pRead</a>   = <a class="code" href="class_u_s_b_x_m_t_r.html#060ed241f71578162097f86d7571d383">buf</a>;
<a name="l00125"></a>00125         <a class="code" href="class_u_s_b_x_m_t_r.html#f3c368649fcfaaddf034773b9336c9ac">pWrite</a>  = <a class="code" href="class_u_s_b_x_m_t_r.html#060ed241f71578162097f86d7571d383">buf</a>;
<a name="l00126"></a>00126         <a class="code" href="class_u_s_b_x_m_t_r.html#5ebbd1a851b22570b8a3c7212e8ea049">pMax</a>    = <a class="code" href="class_u_s_b_x_m_t_r.html#060ed241f71578162097f86d7571d383">buf</a> + <a class="code" href="class_u_s_b_x_m_t_r.html#234c4e6e5ca3006b7eb3dc2921bc65ca">bufSize</a>;
<a name="l00127"></a>00127         }
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="class_u_s_b_x_m_t_r.html#5b3288a40b83cc95885029c3401581db">00129</a>     <span class="keywordtype">void</span> <a class="code" href="class_u_s_b_x_m_t_r.html#5b3288a40b83cc95885029c3401581db">Initialize</a>( <span class="keywordtype">void</span> )
<a name="l00130"></a>00130     {
<a name="l00131"></a>00131 <span class="preprocessor">#ifdef TR_INFO        </span>
<a name="l00132"></a>00132 <span class="preprocessor"></span>        taskENTER_CRITICAL ();
<a name="l00133"></a>00133         <a class="code" href="trace_8h.html#7339bfd784193a5c79efcef2eeb2d6df">TRACE_INFO</a>( <span class="stringliteral">"USBXMTR: Initialize(): Size=%u\n"</span>, <a class="code" href="class_u_s_b_x_m_t_r.html#234c4e6e5ca3006b7eb3dc2921bc65ca">bufSize</a> );
<a name="l00134"></a>00134         taskEXIT_CRITICAL ();
<a name="l00135"></a>00135 <span class="preprocessor">#endif</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>        }
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="class_u_s_b_x_m_t_r.html#70384f142454df09c3600680cff40274">00138</a>     <span class="keywordtype">void</span> <a class="code" href="class_u_s_b_x_m_t_r.html#70384f142454df09c3600680cff40274">LockWrite</a>( <span class="keywordtype">void</span> )
<a name="l00139"></a>00139     {
<a name="l00140"></a>00140         <span class="comment">// Lock pWrite mutex</span>
<a name="l00141"></a>00141         <span class="comment">//</span>
<a name="l00142"></a>00142         do ; <span class="keywordflow">while</span>( ! <a class="code" href="class_u_s_b_x_m_t_r.html#1e94f3be10e61745a8ad8462e7a55738">semaMutex</a>.<a class="code" href="classx_m_u_t_e_x.html#529d57424fe4f58d9a13dea66e40ecfa">Lock</a>( 100 ) );
<a name="l00143"></a>00143         }
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="class_u_s_b_x_m_t_r.html#421fa0d0a2a7d807d6d9c84b6e0304f8">00145</a>     <span class="keywordtype">void</span> <a class="code" href="class_u_s_b_x_m_t_r.html#421fa0d0a2a7d807d6d9c84b6e0304f8">UnlockWrite</a>( <span class="keywordtype">void</span> )
<a name="l00146"></a>00146     {
<a name="l00147"></a>00147         <span class="comment">// Unlock pWrite mutex</span>
<a name="l00148"></a>00148         <span class="comment">//</span>
<a name="l00149"></a>00149         <a class="code" href="class_u_s_b_x_m_t_r.html#1e94f3be10e61745a8ad8462e7a55738">semaMutex</a>.<a class="code" href="classx_m_u_t_e_x.html#5f693de60fd054e78ef201118bc54a5f">Unlock</a> ();
<a name="l00150"></a>00150         }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     <span class="keywordtype">bool</span> <a class="code" href="class_u_s_b_x_m_t_r.html#149d280fef7548a52d67fcb5c5ac3ea6">Put</a>( <span class="keywordtype">void</span>* data, <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> len, portTickType xTicksToWait );
<a name="l00153"></a>00153     <span class="keywordtype">void</span> <a class="code" href="class_u_s_b_x_m_t_r.html#3bf2078741857a3f8d71871b8eda79fd">Transmitter</a>( <span class="keywordtype">void</span> );
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="keyword">static</span> <a class="code" href="class_u_s_b_x_m_t_r.html#1006c0116e079528ed15905c6a33ec78">portTASK_FUNCTION</a>( MainTask, pvParameters );
<a name="l00156"></a>00156     };
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00159"></a>00159 <span class="comment">//      USB RECEIVER Class</span>
<a name="l00160"></a>00160 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00161"></a>00161 
<a name="l00162"></a><a class="code" href="class_u_s_b_r_c_v_r.html">00162</a> <span class="keyword">class </span><a class="code" href="class_u_s_b_r_c_v_r.html">USBRCVR</a>
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164 <span class="keyword">private</span>:
<a name="l00165"></a>00165     
<a name="l00166"></a>00166     <span class="comment">// Buffer for receiving data from the USB</span>
<a name="l00167"></a>00167     <span class="comment">//</span>
<a name="l00168"></a><a class="code" href="class_u_s_b_r_c_v_r.html#5c3658f422a2d05b586fbde8e60c3f2e">00168</a>     <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_u_s_b_r_c_v_r.html#5c3658f422a2d05b586fbde8e60c3f2e">bufSize</a>;
<a name="l00169"></a>00169     <span class="keyword">union</span>
<a name="l00170"></a>00170     {
<a name="l00171"></a><a class="code" href="class_u_s_b_r_c_v_r.html#f1adb81cf89bf94db9264eed04a6d8a6">00171</a>         <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a> <a class="code" href="class_u_s_b_r_c_v_r.html#f1adb81cf89bf94db9264eed04a6d8a6">buf</a>[ <a class="code" href="sam7xpud_8hpp.html#dc29c2ff13d900c2f185ee95427fb06caba55b767751b29a84e8acb3797a5cf5">USB_RCVR_BUF_SIZE</a> ];
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <span class="keyword">struct </span>: <span class="keyword">public</span> <a class="code" href="struct_x_p_i___o_m_s_g___h_e_a_d_e_r.html">XPI_OMSG_HEADER</a>
<a name="l00174"></a>00174         {
<a name="l00175"></a><a class="code" href="class_u_s_b_r_c_v_r.html#314787643fcecf9da63b6f4ffa2208f5">00175</a>             <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a> <a class="code" href="class_u_s_b_r_c_v_r.html#314787643fcecf9da63b6f4ffa2208f5">data</a>[ 0 ];
<a name="l00176"></a>00176             } <a class="code" href="common_8h.html#9065c9586e08a82c23abce9b0bbacd4c">ATTR_PACKED</a> <a class="code" href="class_u_s_b_r_c_v_r.html#2f237caab2ca42b2264e15b3f22e4930">sMsg</a> ;
<a name="l00177"></a>00177         };
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="comment">// CCDC::Read callback status</span>
<a name="l00180"></a><a class="code" href="class_u_s_b_r_c_v_r.html#be8494d0581b59e769dfbe1a9f095a28">00180</a>     <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="class_u_s_b_r_c_v_r.html#be8494d0581b59e769dfbe1a9f095a28">bStatus</a>;
<a name="l00181"></a><a class="code" href="class_u_s_b_r_c_v_r.html#36d3af3eed732b8f113e94be2233c69b">00181</a>     <span class="keyword">volatile</span> <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_u_s_b_r_c_v_r.html#36d3af3eed732b8f113e94be2233c69b">dBytesTransferred</a>;
<a name="l00182"></a><a class="code" href="class_u_s_b_r_c_v_r.html#e11c88a0de1828a7b0e7a11b1f380750">00182</a>     <span class="keyword">volatile</span> <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_u_s_b_r_c_v_r.html#e11c88a0de1828a7b0e7a11b1f380750">dBytesRemaining</a>;
<a name="l00183"></a>00183     
<a name="l00184"></a>00184     <span class="comment">// Queue used to pass message between the USB callback and the task</span>
<a name="l00185"></a>00185     <span class="comment">//</span>
<a name="l00186"></a><a class="code" href="class_u_s_b_r_c_v_r.html#a4d0a9f5f141767eceec755624addf04">00186</a>     <a class="code" href="classx_s_e_m_a.html">xSEMA</a> <a class="code" href="class_u_s_b_r_c_v_r.html#a4d0a9f5f141767eceec755624addf04">semaReceived</a>; 
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="comment">// Forwards data receiving from the USB host through the USART</span>
<a name="l00189"></a>00189     <span class="comment">// This function operates asynchronously.</span>
<a name="l00190"></a>00190     <span class="comment">//</span>
<a name="l00191"></a>00191     <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="class_u_s_b_r_c_v_r.html#343cfd733e1e9da5317e6432cd3ea720">OnReceiveUSB</a>
<a name="l00192"></a><a class="code" href="class_u_s_b_r_c_v_r.html#343cfd733e1e9da5317e6432cd3ea720">00192</a>     (
<a name="l00193"></a>00193         <a class="code" href="class_u_s_b_r_c_v_r.html">USBRCVR</a>* pThis,
<a name="l00194"></a>00194         <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a> <a class="code" href="class_u_s_b_r_c_v_r.html#be8494d0581b59e769dfbe1a9f095a28">bStatus</a>,
<a name="l00195"></a>00195         <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_u_s_b_r_c_v_r.html#36d3af3eed732b8f113e94be2233c69b">dBytesTransferred</a>,
<a name="l00196"></a>00196         <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_u_s_b_r_c_v_r.html#e11c88a0de1828a7b0e7a11b1f380750">dBytesRemaining</a>
<a name="l00197"></a>00197         )
<a name="l00198"></a>00198     {
<a name="l00199"></a>00199         pThis-&gt;<a class="code" href="class_u_s_b_r_c_v_r.html#be8494d0581b59e769dfbe1a9f095a28">bStatus</a> = bStatus;
<a name="l00200"></a>00200         pThis-&gt;<a class="code" href="class_u_s_b_r_c_v_r.html#36d3af3eed732b8f113e94be2233c69b">dBytesTransferred</a> = dBytesTransferred;
<a name="l00201"></a>00201         pThis-&gt;<a class="code" href="class_u_s_b_r_c_v_r.html#e11c88a0de1828a7b0e7a11b1f380750">dBytesRemaining</a> = dBytesRemaining;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         <span class="keywordflow">if</span> ( bStatus == <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf559ef442426e3d388d43f11e453ac54e">USB::USB_STATUS_IMMEDREAD</a> )
<a name="l00204"></a>00204             <span class="keywordflow">return</span>; <span class="comment">// Must not call ReleaseFromISR() out of ISR</span>
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="keywordflow">if</span> ( pThis-&gt;<a class="code" href="class_u_s_b_r_c_v_r.html#a4d0a9f5f141767eceec755624addf04">semaReceived</a>.<a class="code" href="classx_s_e_m_a.html#138c0f59a8444912bb8d1c083bad64ed">ReleaseFromISR</a>( 1, <a class="code" href="sam7xpud_8hpp.html#8016362bfba98bf35c540ad23a34843e">isTaskWokenByPostInUsbIrq</a> ) )
<a name="l00207"></a>00207         {
<a name="l00208"></a>00208             <a class="code" href="sam7xpud_8hpp.html#8016362bfba98bf35c540ad23a34843e">isTaskWokenByPostInUsbIrq</a> = pdTRUE;
<a name="l00209"></a>00209             }
<a name="l00210"></a>00210         }
<a name="l00211"></a>00211     
<a name="l00212"></a>00212 <span class="keyword">public</span>:
<a name="l00213"></a>00213     
<a name="l00214"></a><a class="code" href="class_u_s_b_r_c_v_r.html#482d96fcc94967bc8f507094676dce12">00214</a>     <a class="code" href="class_u_s_b_r_c_v_r.html#482d96fcc94967bc8f507094676dce12">USBRCVR</a>( <span class="keywordtype">void</span> )
<a name="l00215"></a>00215         : <a class="code" href="class_u_s_b_r_c_v_r.html#a4d0a9f5f141767eceec755624addf04">semaReceived</a>( 0 )
<a name="l00216"></a>00216     {
<a name="l00217"></a>00217         <a class="code" href="class_u_s_b_r_c_v_r.html#5c3658f422a2d05b586fbde8e60c3f2e">bufSize</a> = <a class="code" href="sam7xpud_8hpp.html#dc29c2ff13d900c2f185ee95427fb06caba55b767751b29a84e8acb3797a5cf5">USB_RCVR_BUF_SIZE</a>;
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="class_u_s_b_r_c_v_r.html#5b07e0cb5d3512ecd929fb3592db2658">00220</a>     <span class="keywordtype">void</span> <a class="code" href="class_u_s_b_r_c_v_r.html#5b07e0cb5d3512ecd929fb3592db2658">Initialize</a>( <span class="keywordtype">void</span> )
<a name="l00221"></a>00221     {
<a name="l00222"></a>00222 <span class="preprocessor">#ifdef TR_INFO        </span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>        taskENTER_CRITICAL ();
<a name="l00224"></a>00224         <a class="code" href="trace_8h.html#7339bfd784193a5c79efcef2eeb2d6df">TRACE_INFO</a>( <span class="stringliteral">"USBRCVR: Initialize(): Size=%u\n"</span>, <a class="code" href="class_u_s_b_r_c_v_r.html#5c3658f422a2d05b586fbde8e60c3f2e">bufSize</a> );
<a name="l00225"></a>00225         taskEXIT_CRITICAL ();
<a name="l00226"></a>00226 <span class="preprocessor">#endif</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span>
<a name="l00228"></a>00228         <span class="comment">// Wait a bit for USB endpoint to be ready</span>
<a name="l00229"></a>00229         vTaskDelay( 100 );
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         bStatus = <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf7201cca4c6fe2ac04a449c4a3c9310dc" title="Method was aborted because of abnormal status.">USB::USB_STATUS_ABORTED</a>;
<a name="l00232"></a>00232         
<a name="l00233"></a>00233         <span class="keywordflow">for</span>( ;; ) 
<a name="l00234"></a>00234         {
<a name="l00235"></a>00235             taskENTER_CRITICAL ();
<a name="l00236"></a>00236             <span class="keywordtype">int</span> rc = sSer.<a class="code" href="class_u_s_b_1_1_c_c_d_c.html#09bd23b7c7f88d05382e708c9f101552" title="Reads data from the Data OUT endpoint.">Read</a>( <a class="code" href="class_u_s_b_r_c_v_r.html#f1adb81cf89bf94db9264eed04a6d8a6">buf</a>, <a class="code" href="class_u_s_b_r_c_v_r.html#5c3658f422a2d05b586fbde8e60c3f2e">bufSize</a>, <a class="code" href="common_8h.html#a2b4c1da14449a039464b0a1703fb21b">Callback_f</a>( <a class="code" href="class_u_s_b_r_c_v_r.html#343cfd733e1e9da5317e6432cd3ea720">OnReceiveUSB</a> ), <span class="keyword">this</span> );
<a name="l00237"></a>00237             taskEXIT_CRITICAL ();
<a name="l00238"></a>00238             
<a name="l00239"></a>00239             <span class="keywordflow">if</span> ( rc == <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB::USB_STATUS_SUCCESS</a> )
<a name="l00240"></a>00240                 <span class="keywordflow">break</span>;
<a name="l00241"></a>00241             
<a name="l00242"></a>00242             <span class="comment">// USB endopoint is not ready; wait and retry</span>
<a name="l00243"></a>00243             vTaskDelay( 10 );
<a name="l00244"></a>00244             }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="preprocessor">#ifdef TR_INFO</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span>        taskENTER_CRITICAL ();
<a name="l00248"></a>00248         <a class="code" href="trace_8h.html#7339bfd784193a5c79efcef2eeb2d6df">TRACE_INFO</a>( <span class="stringliteral">"USBRCVR: Posted initial CCDC::Read\n"</span> );
<a name="l00249"></a>00249         taskEXIT_CRITICAL ();
<a name="l00250"></a>00250 <span class="preprocessor">#endif</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>        }
<a name="l00252"></a>00252 
<a name="l00253"></a><a class="code" href="class_u_s_b_r_c_v_r.html#aa847e4e71760b636d2890a3521febc3">00253</a>     <span class="keywordtype">void</span> <a class="code" href="class_u_s_b_r_c_v_r.html#aa847e4e71760b636d2890a3521febc3">ReadMoreData</a>( <span class="keywordtype">void</span> )
<a name="l00254"></a>00254     {
<a name="l00255"></a>00255         bStatus = <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf7201cca4c6fe2ac04a449c4a3c9310dc" title="Method was aborted because of abnormal status.">USB::USB_STATUS_ABORTED</a>;
<a name="l00256"></a>00256         
<a name="l00257"></a>00257         <span class="keywordflow">for</span>( ;; ) 
<a name="l00258"></a>00258         {
<a name="l00259"></a>00259             taskENTER_CRITICAL ();
<a name="l00260"></a>00260             <span class="keywordtype">int</span> rc = sSer.<a class="code" href="class_u_s_b_1_1_c_c_d_c.html#09bd23b7c7f88d05382e708c9f101552" title="Reads data from the Data OUT endpoint.">Read</a>( <a class="code" href="class_u_s_b_r_c_v_r.html#f1adb81cf89bf94db9264eed04a6d8a6">buf</a>, <a class="code" href="class_u_s_b_r_c_v_r.html#5c3658f422a2d05b586fbde8e60c3f2e">bufSize</a>, <a class="code" href="common_8h.html#a2b4c1da14449a039464b0a1703fb21b">Callback_f</a>( <a class="code" href="class_u_s_b_r_c_v_r.html#343cfd733e1e9da5317e6432cd3ea720">OnReceiveUSB</a> ), <span class="keyword">this</span> );
<a name="l00261"></a>00261             taskEXIT_CRITICAL ();
<a name="l00262"></a>00262             
<a name="l00263"></a>00263             <span class="keywordflow">if</span> ( rc == <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB::USB_STATUS_SUCCESS</a> )
<a name="l00264"></a>00264                 <span class="keywordflow">break</span>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266             <span class="comment">// USB endopoint is not ready; wait and retry</span>
<a name="l00267"></a>00267             <a class="code" href="trace_8h.html#af9a5c67ad0ffd97cfca6d77c6af536f">TRACE_ERROR</a>( <span class="stringliteral">"!R "</span> );
<a name="l00268"></a>00268             vTaskDelay( 1 );
<a name="l00269"></a>00269             }
<a name="l00270"></a>00270         }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="keywordtype">void</span> <a class="code" href="class_u_s_b_r_c_v_r.html#f8361a896588ddbb643a4b79b59129b5">Receiver</a>( <span class="keywordtype">void</span> );
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keyword">static</span> <a class="code" href="class_u_s_b_r_c_v_r.html#0470b854d786704120a34caebb74b242">portTASK_FUNCTION</a>( MainTask, pvParameters );
<a name="l00275"></a>00275     };
<a name="l00276"></a>00276     
<a name="l00277"></a>00277 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00278"></a>00278 <span class="comment">//     XSVF Player Task Class</span>
<a name="l00279"></a>00279 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00280"></a><a class="code" href="class_x_s_v_f___player.html">00280</a> <span class="keyword">class </span><a class="code" href="class_x_s_v_f___player.html">XSVF_Player</a>
<a name="l00281"></a>00281 {
<a name="l00282"></a><a class="code" href="class_x_s_v_f___player.html#3aefe2d2dcd6fbe9ada23d757aad6a14">00282</a>     <span class="keywordtype">bool</span> <a class="code" href="class_x_s_v_f___player.html#3aefe2d2dcd6fbe9ada23d757aad6a14">enabled</a>;
<a name="l00283"></a>00283 
<a name="l00284"></a><a class="code" href="class_x_s_v_f___player.html#5535a2bc3a43afb5d530c8e47e34220d">00284</a>     <a class="code" href="classx_s_e_m_a.html">xSEMA</a> <a class="code" href="class_x_s_v_f___player.html#5535a2bc3a43afb5d530c8e47e34220d">semaFull</a>;
<a name="l00285"></a><a class="code" href="class_x_s_v_f___player.html#48a0fcb4371299590c53c86d047bb94b">00285</a>     <a class="code" href="classx_s_e_m_a.html">xSEMA</a> <a class="code" href="class_x_s_v_f___player.html#48a0fcb4371299590c53c86d047bb94b">semaEmpty</a>;
<a name="l00286"></a><a class="code" href="class_x_s_v_f___player.html#9a1c022dedffdea366609123e463dc98">00286</a>     <span class="keyword">volatile</span> <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>* <a class="code" href="class_x_s_v_f___player.html#9a1c022dedffdea366609123e463dc98">datap</a>;
<a name="l00287"></a><a class="code" href="class_x_s_v_f___player.html#6e3e4286228e60ae8643759086baea7f">00287</a>     <span class="keyword">volatile</span> <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_x_s_v_f___player.html#6e3e4286228e60ae8643759086baea7f">datac</a>;
<a name="l00288"></a><a class="code" href="class_x_s_v_f___player.html#191e5f1694d7e574a6ffcec8d02f7f36">00288</a>     <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="class_x_s_v_f___player.html#191e5f1694d7e574a6ffcec8d02f7f36">firstByte</a>;
<a name="l00289"></a><a class="code" href="class_x_s_v_f___player.html#b6a58012fc157d5e5e3295ff30fd4389">00289</a>     <span class="keywordtype">int</span> <a class="code" href="class_x_s_v_f___player.html#b6a58012fc157d5e5e3295ff30fd4389">traceLevel</a>;
<a name="l00290"></a><a class="code" href="class_x_s_v_f___player.html#4240cc984cad1b2ca628b1ee899b3eaa">00290</a>     <span class="keywordtype">bool</span> <a class="code" href="class_x_s_v_f___player.html#4240cc984cad1b2ca628b1ee899b3eaa">parseOnly</a>;
<a name="l00291"></a><a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">00291</a>     <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a>;
<a name="l00292"></a><a class="code" href="class_x_s_v_f___player.html#f0a26fd81953129d60064ee6ce0d12c7">00292</a>     <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="class_x_s_v_f___player.html#f0a26fd81953129d60064ee6ce0d12c7">byteCount</a>;
<a name="l00293"></a><a class="code" href="class_x_s_v_f___player.html#5c13f8adff80d497bb6f24f0381a58c3">00293</a>     <span class="keywordtype">int</span> <a class="code" href="class_x_s_v_f___player.html#5c13f8adff80d497bb6f24f0381a58c3">xsvfRC</a>;
<a name="l00294"></a>00294     
<a name="l00295"></a><a class="code" href="class_x_s_v_f___player.html#f3c0dd498b3ca86c7aa46decaf4f07fd">00295</a>     <a class="code" href="struct_x_p_i___l_o_n_g___m_s_g.html">XPI_LONG_MSG</a> <a class="code" href="class_x_s_v_f___player.html#f3c0dd498b3ca86c7aa46decaf4f07fd">sMsg</a>;    
<a name="l00296"></a>00296     
<a name="l00297"></a>00297     <span class="comment">// Update the CRC for transmitted and received data using</span>
<a name="l00298"></a>00298     <span class="comment">// the CCITT 16-bit algorithm (X^16 + X^12 + X^5 + 1).</span>
<a name="l00299"></a>00299     <span class="comment">//</span>
<a name="l00300"></a><a class="code" href="class_x_s_v_f___player.html#493d16eed95c4ea70c1026758c45bcf9">00300</a>     <span class="keywordtype">void</span> <a class="code" href="class_x_s_v_f___player.html#493d16eed95c4ea70c1026758c45bcf9">CRC16</a>( <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a> ser_data )
<a name="l00301"></a>00301     {
<a name="l00302"></a>00302         <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a>  = <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>( <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a> &gt;&gt; 8 ) | ( <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a> &lt;&lt; 8 );
<a name="l00303"></a>00303         <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a> ^= ser_data;
<a name="l00304"></a>00304         <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a> ^= <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>( <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a> &amp; 0xff ) &gt;&gt; 4;
<a name="l00305"></a>00305         <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a> ^= ( <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a> &lt;&lt; 8 ) &lt;&lt; 4;
<a name="l00306"></a>00306         <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a> ^= ( ( <a class="code" href="class_x_s_v_f___player.html#22f05d7733562051b71e168ee418737d">crc</a> &amp; 0xFF ) &lt;&lt; 4 ) &lt;&lt; 1;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         ++<a class="code" href="class_x_s_v_f___player.html#f0a26fd81953129d60064ee6ce0d12c7">byteCount</a>;
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="keywordtype">void</span> <a class="code" href="class_x_s_v_f___player.html#7c68cab8bc1c8d4a40a5a14c7e389a9d">MainLoop</a>( <span class="keywordtype">void</span> );
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="keyword">public</span>:    
<a name="l00314"></a>00314 
<a name="l00315"></a><a class="code" href="class_x_s_v_f___player.html#74333102cfc8b940d1add4ad6cf0c994">00315</a>     <a class="code" href="class_x_s_v_f___player.html#74333102cfc8b940d1add4ad6cf0c994">XSVF_Player</a>( <span class="keywordtype">void</span> )
<a name="l00316"></a>00316         : <a class="code" href="class_x_s_v_f___player.html#5535a2bc3a43afb5d530c8e47e34220d">semaFull</a>( 0 )
<a name="l00317"></a>00317         , <a class="code" href="class_x_s_v_f___player.html#48a0fcb4371299590c53c86d047bb94b">semaEmpty</a>( 0 )
<a name="l00318"></a>00318     {
<a name="l00319"></a>00319         <a class="code" href="class_x_s_v_f___player.html#3aefe2d2dcd6fbe9ada23d757aad6a14">enabled</a>    = <span class="keyword">false</span>;
<a name="l00320"></a>00320         <a class="code" href="class_x_s_v_f___player.html#5c13f8adff80d497bb6f24f0381a58c3">xsvfRC</a>     = -1; <span class="comment">// undefined error</span>
<a name="l00321"></a>00321         <a class="code" href="class_x_s_v_f___player.html#9a1c022dedffdea366609123e463dc98">datap</a>      = NULL;
<a name="l00322"></a>00322         <a class="code" href="class_x_s_v_f___player.html#6e3e4286228e60ae8643759086baea7f">datac</a>      = 0;
<a name="l00323"></a>00323         <a class="code" href="class_x_s_v_f___player.html#191e5f1694d7e574a6ffcec8d02f7f36">firstByte</a>  = -1;
<a name="l00324"></a>00324         <a class="code" href="class_x_s_v_f___player.html#b6a58012fc157d5e5e3295ff30fd4389">traceLevel</a> = 0;
<a name="l00325"></a>00325         <a class="code" href="class_x_s_v_f___player.html#4240cc984cad1b2ca628b1ee899b3eaa">parseOnly</a>  = <span class="keyword">false</span>;
<a name="l00326"></a>00326         }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     <span class="keywordtype">void</span> <a class="code" href="class_x_s_v_f___player.html#ab49a062790f0a95e08d6f246b2a71b4">Enable</a>( <span class="keywordtype">int</span> trace_level, <span class="keywordtype">bool</span> parse_only );
<a name="l00329"></a>00329 
<a name="l00330"></a><a class="code" href="class_x_s_v_f___player.html#6fa3bf4ec56d838ad09c3f0e43a8342e">00330</a>     <span class="keywordtype">int</span> <a class="code" href="class_x_s_v_f___player.html#6fa3bf4ec56d838ad09c3f0e43a8342e">GetLastRC</a>( <span class="keywordtype">void</span> )<span class="keyword"> const</span>
<a name="l00331"></a>00331 <span class="keyword">    </span>{
<a name="l00332"></a>00332         <span class="keywordflow">return</span> <a class="code" href="class_x_s_v_f___player.html#3aefe2d2dcd6fbe9ada23d757aad6a14">enabled</a> ? -1 : <a class="code" href="class_x_s_v_f___player.html#5c13f8adff80d497bb6f24f0381a58c3">xsvfRC</a>;
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334 
<a name="l00335"></a><a class="code" href="class_x_s_v_f___player.html#30c853edaf50b1a4d677131bdb78d277">00335</a>     <span class="keywordtype">int</span> <a class="code" href="class_x_s_v_f___player.html#30c853edaf50b1a4d677131bdb78d277">getc</a>( <span class="keywordtype">void</span> )
<a name="l00336"></a>00336     {
<a name="l00337"></a>00337         <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a> data;
<a name="l00338"></a>00338         
<a name="l00339"></a>00339         <span class="comment">// Emit first byte that was previously peek by the player</span>
<a name="l00340"></a>00340         <span class="comment">//</span>
<a name="l00341"></a>00341         <span class="keywordflow">if</span> ( <a class="code" href="class_x_s_v_f___player.html#191e5f1694d7e574a6ffcec8d02f7f36">firstByte</a> &gt;= 0 )
<a name="l00342"></a>00342         {
<a name="l00343"></a>00343             data = <a class="code" href="class_x_s_v_f___player.html#191e5f1694d7e574a6ffcec8d02f7f36">firstByte</a>;
<a name="l00344"></a>00344             <a class="code" href="class_x_s_v_f___player.html#191e5f1694d7e574a6ffcec8d02f7f36">firstByte</a> = -1;
<a name="l00345"></a>00345             <a class="code" href="class_x_s_v_f___player.html#493d16eed95c4ea70c1026758c45bcf9">CRC16</a>( data );
<a name="l00346"></a>00346             <span class="keywordflow">return</span> data;
<a name="l00347"></a>00347             }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         <span class="comment">// Get next XSVF data. Consider end of XSVF stream on timeout.</span>
<a name="l00350"></a>00350         <span class="comment">//</span>
<a name="l00351"></a>00351         <span class="keywordflow">if</span> ( <a class="code" href="class_x_s_v_f___player.html#6e3e4286228e60ae8643759086baea7f">datac</a> == 0 )
<a name="l00352"></a>00352         {
<a name="l00353"></a>00353             <span class="keywordflow">if</span> ( ! <a class="code" href="class_x_s_v_f___player.html#5535a2bc3a43afb5d530c8e47e34220d">semaFull</a>.<a class="code" href="classx_s_e_m_a.html#d398bc33f1c28f28c33ce1796b0e4ca7">Wait</a>( 1, 2000 ) )
<a name="l00354"></a>00354                 <span class="keywordflow">return</span> -1;
<a name="l00355"></a>00355             
<a name="l00356"></a>00356             <span class="keywordflow">if</span> ( <a class="code" href="class_x_s_v_f___player.html#6e3e4286228e60ae8643759086baea7f">datac</a> == 0 )
<a name="l00357"></a>00357                 <span class="keywordflow">return</span> -1;
<a name="l00358"></a>00358             }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         data = *<a class="code" href="class_x_s_v_f___player.html#9a1c022dedffdea366609123e463dc98">datap</a>++;
<a name="l00361"></a>00361         --<a class="code" href="class_x_s_v_f___player.html#6e3e4286228e60ae8643759086baea7f">datac</a>;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="keywordflow">if</span> ( <a class="code" href="class_x_s_v_f___player.html#6e3e4286228e60ae8643759086baea7f">datac</a> == 0 )
<a name="l00364"></a>00364         {
<a name="l00365"></a>00365             <a class="code" href="class_x_s_v_f___player.html#9a1c022dedffdea366609123e463dc98">datap</a> = NULL;
<a name="l00366"></a>00366             <a class="code" href="class_x_s_v_f___player.html#48a0fcb4371299590c53c86d047bb94b">semaEmpty</a>.<a class="code" href="classx_s_e_m_a.html#21e114e5918da00fc1d5ce9b285f5e2b">Release</a>( 1 );
<a name="l00367"></a>00367             }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         <a class="code" href="class_x_s_v_f___player.html#493d16eed95c4ea70c1026758c45bcf9">CRC16</a>( data );
<a name="l00370"></a>00370         <span class="keywordflow">return</span> data;
<a name="l00371"></a>00371         }
<a name="l00372"></a>00372 
<a name="l00373"></a><a class="code" href="class_x_s_v_f___player.html#4e412ad72e7bc50f79f431305ce0c62c">00373</a>     <span class="keywordtype">void</span> <a class="code" href="class_x_s_v_f___player.html#4e412ad72e7bc50f79f431305ce0c62c">LockBuffer</a>( <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>* buf, <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> len )
<a name="l00374"></a>00374     {
<a name="l00375"></a>00375         <span class="keywordflow">if</span> ( ! <a class="code" href="class_x_s_v_f___player.html#3aefe2d2dcd6fbe9ada23d757aad6a14">enabled</a> )
<a name="l00376"></a>00376             <span class="keywordflow">return</span>; <span class="comment">// ignore if not enabled</span>
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         <a class="code" href="class_x_s_v_f___player.html#9a1c022dedffdea366609123e463dc98">datap</a> = buf;
<a name="l00379"></a>00379         <a class="code" href="class_x_s_v_f___player.html#6e3e4286228e60ae8643759086baea7f">datac</a> = len;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <a class="code" href="class_x_s_v_f___player.html#5535a2bc3a43afb5d530c8e47e34220d">semaFull</a>.<a class="code" href="classx_s_e_m_a.html#21e114e5918da00fc1d5ce9b285f5e2b">Release</a>( 1 );
<a name="l00382"></a>00382         
<a name="l00383"></a>00383         do ; <span class="keywordflow">while</span>( ! <a class="code" href="class_x_s_v_f___player.html#48a0fcb4371299590c53c86d047bb94b">semaEmpty</a>.<a class="code" href="classx_s_e_m_a.html#d398bc33f1c28f28c33ce1796b0e4ca7">Wait</a>( 1, 100 ) );
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="keyword">static</span> <a class="code" href="class_x_s_v_f___player.html#52c124e52a2fe92a8c105061149bc870">portTASK_FUNCTION</a>( MainTask, pvParameters );
<a name="l00387"></a>00387     };
<a name="l00388"></a>00388 
<a name="l00389"></a>00389 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00390"></a>00390 <span class="comment">//     Exported Symbols</span>
<a name="l00391"></a>00391 <span class="comment">//---------------------------------------------------------------------------------------</span>
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <span class="keyword">extern</span> <a class="code" href="class_u_s_b_r_c_v_r.html">USBRCVR</a> <a class="code" href="sam7xpud_8hpp.html#6e9b432eef868fb6c7ac0759d919f5f4">usbIn</a>;
<a name="l00394"></a>00394 <span class="keyword">extern</span> <a class="code" href="class_u_s_b_x_m_t_r.html">USBXMTR</a> <a class="code" href="sam7xpud_8hpp.html#9700c6a3205c12058c9b82f9caca843f">usbOut</a>;
<a name="l00395"></a>00395 <span class="keyword">extern</span> <a class="code" href="class_x_s_v_f___player.html">XSVF_Player</a> <a class="code" href="xsvf_task_8cpp.html#2eae1c83f74a85332e67c8ecadb9603c">xsvf</a>;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 <span class="preprocessor">#endif // _SAM7XPUD_H_INCLUDED</span>
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Mar 10 02:42:32 2008 for XPU-DSAM7S by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
