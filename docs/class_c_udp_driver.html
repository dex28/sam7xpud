<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>XPU-DSAM7S: CUdpDriver Class Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>CUdpDriver Class Reference</h1><!-- doxytag: class="CUdpDriver" --><!-- doxytag: inherits="USB::CUsbDriver" --><div class="dynheader">
Inheritance diagram for CUdpDriver:</div>
<div class="dynsection">

<p><center><img src="class_c_udp_driver.png" usemap="#CUdpDriver_map" border="0" alt=""></center>
<map name="CUdpDriver_map">
<area href="class_u_s_b_1_1_c_usb_driver.html" alt="USB::CUsbDriver" shape="rect" coords="0,0,108,24">
</map>
</div>

<p>
<a href="class_c_udp_driver-members.html">List of all members.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#022fbd69657d2827d3e2c0885f7eefb3">CUdpDriver</a> (AT91PS_UDP controller, <a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> ctrlID, <a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> ctrlPMC)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">UDP driver object constructor.  <a href="#022fbd69657d2827d3e2c0885f7eefb3"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Private Types</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7e57cce2ad51b07679e039e128b2aa2ba5">UDP_STATE_SHOULD_RECONNECT</a> =  0x10000000, 
<a class="el" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7e7b0f1ed0d0742f3e9dfec61eeb9ab69b">UDP_EPTYPE_INDEX</a> =  8, 
<a class="el" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7ee7df67f50474e5dbb9a7c3b1e3175849">UDP_EPDIR_INDEX</a> =  10, 
<a class="el" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7ee4f8d15de5dc5195c6f80bf890a0d212">ISR_MASK</a> =  0x00003FFF
 }</td></tr>

<tr><td colspan="2"><br><h2>Private Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#1c4166268dbce6fad2de3eeb89aaf82d">ClearEndpointFlags</a> (int bEndpoint, <a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dFlags)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Clear flags in the UDP_CSR register and waits for synchronization.  <a href="#1c4166268dbce6fad2de3eeb89aaf82d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#6aa2661dfca334908398ec3a324f65f4">SetEndpointFlags</a> (int bEndpoint, <a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dFlags)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Set flags in the UDP_CSR register and waits for synchronization.  <a href="#6aa2661dfca334908398ec3a324f65f4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#57f192544cb44433586de297a23747ca">EnableMCK</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Enables the peripheral clock of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver.  <a href="#57f192544cb44433586de297a23747ca"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#649855193003a419cd39c5a66fa30503">DisableMCK</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Disables the peripheral clock of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver.  <a href="#649855193003a419cd39c5a66fa30503"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#473b05382c7ea862fdc3f195deed2f76">EnableUDPCK</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Enables the 48MHz clock of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver.  <a href="#473b05382c7ea862fdc3f195deed2f76"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#7bff10dc4515c32a205d274728ed7681">DisableUDPCK</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Disables the 48MHz clock of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver.  <a href="#7bff10dc4515c32a205d274728ed7681"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#7780c2dd587f40f5b4749b8de3e9cb16">EnableTransceiver</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Enables the transceiver of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver.  <a href="#7780c2dd587f40f5b4749b8de3e9cb16"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#5e1d3b5c810e5a6cc75b8b0e5038ec43">DisableTransceiver</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Disables the transceiver of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver.  <a href="#5e1d3b5c810e5a6cc75b8b0e5038ec43"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#37b567c9205c8d3e2bdb3259123fcb05">ClearRXFlag</a> (int bEndpoint)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Clears the correct RX flag in an endpoint status register.  <a href="#37b567c9205c8d3e2bdb3259123fcb05"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#aa4e67dd65350793ee1db8fde2f5cb7b">WritePayload</a> (int bEndpoint)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Transfers a data payload from the current tranfer buffer to the endpoint FIFO.  <a href="#aa4e67dd65350793ee1db8fde2f5cb7b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#fe791e9ab368f8413d2323b95a409460">GetPayload</a> (int bEndpoint, <a class="el" href="common_8h.html#b95f123a6c9bcfee6a343170ef8c5f69">ushort</a> wPacketSize)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Transfers a data payload from an endpoint FIFO to the current transfer buffer.  <a href="#fe791e9ab368f8413d2323b95a409460"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#2f1608a989f65367307faabb5e44f892">ResetEndpoints</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function reset all endpoint transfer descriptors.  <a href="#2f1608a989f65367307faabb5e44f892"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#0054634921075da975122a537e1b6bca">DisableEndpoints</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Disable all endpoints (except control endpoint 0), aborting current transfers if necessary.  <a href="#0054634921075da975122a537e1b6bca"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#2654684e8906700c508d3f10d133404a">EndpointHandler</a> (int bEndpoint)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Endpoint interrupt handler. Handle IN/OUT transfers, received SETUP packets and STALLing.  <a href="#2654684e8906700c508d3f10d133404a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#42223dfccbe074e52aa7d479673fe2eb">GetInterface</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns a pointer to the UDP controller interface used by an <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver. The pointer is cast to the correct type (AT91PS_UDP).  <a href="#42223dfccbe074e52aa7d479673fe2eb"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#b079ba266637f6b00d017388ba2610df">GetDriverID</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral ID of a <a class="el" href="class_c_udp_driver.html">CUdpDriver</a> instance.  <a href="#b079ba266637f6b00d017388ba2610df"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#470ca17d526df70db31441ef23325dd4">Init</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> API and the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller.  <a href="#470ca17d526df70db31441ef23325dd4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf">EnumStandardReturnValue</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#a7721b2c4e62455efceb0f3c29a24b2a">Write</a> (int bEndpoint, const void *pData, <a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dLength, <a class="el" href="common_8h.html#a2b4c1da14449a039464b0a1703fb21b">Callback_f</a> fCallback, void *pArgument, const void *pDataLowerBound, const void *pDataUpperBound)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Sends data through an <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> endpoint.  <a href="#a7721b2c4e62455efceb0f3c29a24b2a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf">EnumStandardReturnValue</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#26eb83a7a04131c8f7c529ee3fcad846">Read</a> (int bEndpoint, void *pData, <a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dLength, <a class="el" href="common_8h.html#a2b4c1da14449a039464b0a1703fb21b">Callback_f</a> fCallback, void *pArgument)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Receives data on the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> endpoint.  <a href="#26eb83a7a04131c8f7c529ee3fcad846"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf">EnumStandardReturnValue</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#cf2898cdd641b3c522a0f2c40b72206f">Stall</a> (int bEndpoint)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Sends a STALL handshake for the next received packet.  <a href="#cf2898cdd641b3c522a0f2c40b72206f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="common_8h.html#f6a258d8f3ee5206d682d799316314b1">bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#731233a0654277219ef0148319c0761e">Halt</a> (int bEndpoint, int bRequest)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Clears, sets or retrieves the halt state of the specified endpoint.  <a href="#731233a0654277219ef0148319c0761e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#e433e33b63d698c98ebbe7f97c4b4b11">RemoteWakeUp</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Starts a remote wakeup procedure.  <a href="#e433e33b63d698c98ebbe7f97c4b4b11"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="common_8h.html#f6a258d8f3ee5206d682d799316314b1">bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#f4d41ab77f6c6c68dbb0af8c548c726f">ConfigureEndpoint</a> (const <a class="el" href="struct_u_s_b_1_1_s__usb__endpoint__descriptor.html">S_usb_endpoint_descriptor</a> *pEpDesc)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Configures the specified endpoint using the provided endpoint descriptor.  <a href="#f4d41ab77f6c6c68dbb0af8c548c726f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="common_8h.html#f6a258d8f3ee5206d682d799316314b1">bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#39943265011f48c86d097afb2d1cf285">Attach</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handles the attachment or detachment of the device to or from the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a>.  <a href="#39943265011f48c86d097afb2d1cf285"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#292d51e33ec7a054206e69b3b9395ef4">SetAddress</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Sets the device address using the last received SETUP packet. This method must only be called after a SET_ADDRESS standard request has been received. This is because it uses the last received SETUP packet stored in the sSetup structure to determine which address the device should use.  <a href="#292d51e33ec7a054206e69b3b9395ef4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#53ff5988e2dc0f5e780d056e55e28283">SetConfiguration</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Sets the device configuration using the last received SETUP packet.  <a href="#53ff5988e2dc0f5e780d056e55e28283"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#df47754ef8128230c4cefa247265a305">EventHandler</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Event handler for the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral.  <a href="#df47754ef8128230c4cefa247265a305"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#9721403973d6af1963a444ab7c8ca162">Connect</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Connects the device to the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a>.  <a href="#9721403973d6af1963a444ab7c8ca162"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#a42ff5ccc0e5a31aee80d2d837ccf67f">Disconnect</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Disconnects the device from the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a>.  <a href="#a42ff5ccc0e5a31aee80d2d837ccf67f"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Private Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">AT91PS_UDP&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6">pInterface</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Pointer to the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral.  <a href="#7b61d216dd49652668d71bdb2b3c95d6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#6e21f491e8f4c50291fd14774509504c">dID</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">ID of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral.  <a href="#6e21f491e8f4c50291fd14774509504c"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_udp_driver.html#18f89c2f3a4637bd9b4f1cfdfcd2301e">dPMC</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">ID to enable the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral clock.  <a href="#18f89c2f3a4637bd9b4f1cfdfcd2301e"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00018">18</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>
<hr><h2>Member Enumeration Documentation</h2>
<a class="anchor" name="866f20c0f18912bec3c108d133b60a7e"></a><!-- doxytag: member="CUdpDriver::@26" ref="866f20c0f18912bec3c108d133b60a7e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum<code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<dl compact><dt><b>Enumerator: </b></dt><dd>
<table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" name="866f20c0f18912bec3c108d133b60a7e57cce2ad51b07679e039e128b2aa2ba5"></a><!-- doxytag: member="UDP_STATE_SHOULD_RECONNECT" ref="866f20c0f18912bec3c108d133b60a7e57cce2ad51b07679e039e128b2aa2ba5" args="" -->UDP_STATE_SHOULD_RECONNECT</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="866f20c0f18912bec3c108d133b60a7e7b0f1ed0d0742f3e9dfec61eeb9ab69b"></a><!-- doxytag: member="UDP_EPTYPE_INDEX" ref="866f20c0f18912bec3c108d133b60a7e7b0f1ed0d0742f3e9dfec61eeb9ab69b" args="" -->UDP_EPTYPE_INDEX</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="866f20c0f18912bec3c108d133b60a7ee7df67f50474e5dbb9a7c3b1e3175849"></a><!-- doxytag: member="UDP_EPDIR_INDEX" ref="866f20c0f18912bec3c108d133b60a7ee7df67f50474e5dbb9a7c3b1e3175849" args="" -->UDP_EPDIR_INDEX</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="866f20c0f18912bec3c108d133b60a7ee4f8d15de5dc5195c6f80bf890a0d212"></a><!-- doxytag: member="ISR_MASK" ref="866f20c0f18912bec3c108d133b60a7ee4f8d15de5dc5195c6f80bf890a0d212" args="" -->ISR_MASK</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00020">20</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00021"></a>00021     {
<a name="l00022"></a>00022         <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7e57cce2ad51b07679e039e128b2aa2ba5">UDP_STATE_SHOULD_RECONNECT</a>      = 0x10000000,
<a name="l00023"></a>00023         <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7e7b0f1ed0d0742f3e9dfec61eeb9ab69b">UDP_EPTYPE_INDEX</a>                = 8,
<a name="l00024"></a>00024         <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7ee7df67f50474e5dbb9a7c3b1e3175849">UDP_EPDIR_INDEX</a>                 = 10,
<a name="l00025"></a>00025 
<a name="l00026"></a>00026         <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7ee4f8d15de5dc5195c6f80bf890a0d212">ISR_MASK</a>                        = 0x00003FFF
<a name="l00027"></a>00027     };
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" name="022fbd69657d2827d3e2c0885f7eefb3"></a><!-- doxytag: member="CUdpDriver::CUdpDriver" ref="022fbd69657d2827d3e2c0885f7eefb3" args="(AT91PS_UDP controller, uint ctrlID, uint ctrlPMC)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">CUdpDriver::CUdpDriver           </td>
          <td>(</td>
          <td class="paramtype">AT91PS_UDP&nbsp;</td>
          <td class="paramname"> <em>controller</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td>
          <td class="paramname"> <em>ctrlID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td>
          <td class="paramname"> <em>ctrlPMC</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
UDP driver object constructor. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>controller</em>&nbsp;</td><td>Pointer to the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ctrlID</em>&nbsp;</td><td>ID of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ctrlPMC</em>&nbsp;</td><td>ID to enable the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral clock </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00048">48</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00034">dID</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00035">dPMC</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00049"></a>00049         : <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba5c3d1c32249103feef1fb1f3ae9022" title="Constructor. Just nullify/disable everything.">CUsbDriver</a> ()
<a name="l00050"></a>00050     {
<a name="l00051"></a>00051         <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a> = controller;
<a name="l00052"></a>00052         <a class="code" href="class_c_udp_driver.html#6e21f491e8f4c50291fd14774509504c" title="ID of the USB controller peripheral.">dID</a>        = ctrlID;
<a name="l00053"></a>00053         <a class="code" href="class_c_udp_driver.html#18f89c2f3a4637bd9b4f1cfdfcd2301e" title="ID to enable the USB controller peripheral clock.">dPMC</a>       = ctrlPMC;
<a name="l00054"></a>00054     };
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="1c4166268dbce6fad2de3eeb89aaf82d"></a><!-- doxytag: member="CUdpDriver::ClearEndpointFlags" ref="1c4166268dbce6fad2de3eeb89aaf82d" args="(int bEndpoint, uint dFlags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::ClearEndpointFlags           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td>
          <td class="paramname"> <em>dFlags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Clear flags in the UDP_CSR register and waits for synchronization. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dFlags</em>&nbsp;</td><td>Flags to clear </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00066">66</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00480">ClearRXFlag()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00559">EndpointHandler()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01222">Halt()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00067"></a>00067     {
<a name="l00068"></a>00068         AT91_REG&amp; UDP_CSR = <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_CSR[ bEndpoint ];
<a name="l00069"></a>00069         
<a name="l00070"></a>00070         <span class="keywordflow">if</span> ( ( UDP_CSR &amp; dFlags ) == 0 )
<a name="l00071"></a>00071             <span class="keywordflow">return</span>;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         UDP_CSR &amp;= ~dFlags;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         <span class="comment">// WARNING: Due to synchronization between MCK and UDPCK, the software </span>
<a name="l00076"></a>00076         <span class="comment">// application must wait for the end of the write operation before executing </span>
<a name="l00077"></a>00077         <span class="comment">// another write by polling the bits which must be set/cleared.</span>
<a name="l00078"></a>00078         <span class="comment">// \see Section 35.6.10 UDP Endpoint CSR in AT91SAM7 datasheet (doc6175.pdf)</span>
<a name="l00079"></a>00079         <span class="comment">//</span>
<a name="l00080"></a>00080         do ; <span class="keywordflow">while</span>( ( UDP_CSR &amp; dFlags ) != 0 );
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         <span class="comment">// Note: In a preemptive environment, set or clear the flag and wait for a time </span>
<a name="l00083"></a>00083         <span class="comment">// of 1 UDPCK clock cycle and 1 peripheral clock cycle. However, RX_DATA_BK0, </span>
<a name="l00084"></a>00084         <span class="comment">// TXPKTRDY, RX_DATA_BK1 require wait times of 3 UDPCK clock cycles and 3 </span>
<a name="l00085"></a>00085         <span class="comment">// peripheral clock cycles before accessing DPR.</span>
<a name="l00086"></a>00086     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="6aa2661dfca334908398ec3a324f65f4"></a><!-- doxytag: member="CUdpDriver::SetEndpointFlags" ref="6aa2661dfca334908398ec3a324f65f4" args="(int bEndpoint, uint dFlags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::SetEndpointFlags           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td>
          <td class="paramname"> <em>dFlags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Set flags in the UDP_CSR register and waits for synchronization. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dFlags</em>&nbsp;</td><td>Flags to clear </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00093">93</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00559">EndpointHandler()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01222">Halt()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01284">Stall()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01081">Write()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00094"></a>00094     {
<a name="l00095"></a>00095         AT91_REG&amp; UDP_CSR = <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_CSR[ bEndpoint ];
<a name="l00096"></a>00096 
<a name="l00097"></a>00097         <span class="keywordflow">if</span> ( ( UDP_CSR &amp; dFlags ) == dFlags )
<a name="l00098"></a>00098             <span class="keywordflow">return</span>;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         UDP_CSR |= dFlags;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         <span class="comment">// WARNING: Due to synchronization between MCK and UDPCK, the software </span>
<a name="l00103"></a>00103         <span class="comment">// application must wait for the end of the write operation before executing </span>
<a name="l00104"></a>00104         <span class="comment">// another write by polling the bits which must be set/cleared.</span>
<a name="l00105"></a>00105         <span class="comment">// \see Section 35.6.10 UDP Endpoint CSR in AT91SAM7 datasheet (doc6175.pdf)</span>
<a name="l00106"></a>00106         <span class="comment">//</span>
<a name="l00107"></a>00107         do ; <span class="keywordflow">while</span> ( ( UDP_CSR &amp; dFlags ) != dFlags );
<a name="l00108"></a>00108 
<a name="l00109"></a>00109         <span class="comment">// Note: In a preemptive environment, set or clear the flag and wait for a time </span>
<a name="l00110"></a>00110         <span class="comment">// of 1 UDPCK clock cycle and 1 peripheral clock cycle. However, RX_DATA_BK0, </span>
<a name="l00111"></a>00111         <span class="comment">// TXPKTRDY, RX_DATA_BK1 require wait times of 3 UDPCK clock cycles and 3 </span>
<a name="l00112"></a>00112         <span class="comment">// peripheral clock cycles before accessing DPR.</span>
<a name="l00113"></a>00113     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="57f192544cb44433586de297a23747ca"></a><!-- doxytag: member="CUdpDriver::EnableMCK" ref="57f192544cb44433586de297a23747ca" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::EnableMCK           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Enables the peripheral clock of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00119">119</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00034">dID</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">Attach()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01531">Init()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01306">RemoteWakeUp()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00120"></a>00120     {
<a name="l00121"></a>00121         AT91C_BASE_PMC-&gt;PMC_PCER = 1 &lt;&lt; <a class="code" href="class_c_udp_driver.html#6e21f491e8f4c50291fd14774509504c" title="ID of the USB controller peripheral.">dID</a>;
<a name="l00122"></a>00122     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="649855193003a419cd39c5a66fa30503"></a><!-- doxytag: member="CUdpDriver::DisableMCK" ref="649855193003a419cd39c5a66fa30503" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::DisableMCK           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Disables the peripheral clock of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00128">128</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00034">dID</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">Attach()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01531">Init()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00129"></a>00129     {
<a name="l00130"></a>00130         AT91C_BASE_PMC-&gt;PMC_PCDR = 1 &lt;&lt; <a class="code" href="class_c_udp_driver.html#6e21f491e8f4c50291fd14774509504c" title="ID of the USB controller peripheral.">dID</a>;
<a name="l00131"></a>00131     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="473b05382c7ea862fdc3f195deed2f76"></a><!-- doxytag: member="CUdpDriver::EnableUDPCK" ref="473b05382c7ea862fdc3f195deed2f76" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::EnableUDPCK           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Enables the 48MHz clock of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00137">137</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00035">dPMC</a>, and <a class="el" href="common_8h-source.html#l00056">SET</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">Attach()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01306">RemoteWakeUp()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00138"></a>00138     {
<a name="l00139"></a>00139         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( AT91C_BASE_PMC-&gt;PMC_SCER, <a class="code" href="class_c_udp_driver.html#18f89c2f3a4637bd9b4f1cfdfcd2301e" title="ID to enable the USB controller peripheral clock.">dPMC</a> );
<a name="l00140"></a>00140     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="7bff10dc4515c32a205d274728ed7681"></a><!-- doxytag: member="CUdpDriver::DisableUDPCK" ref="7bff10dc4515c32a205d274728ed7681" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::DisableUDPCK           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Disables the 48MHz clock of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00146">146</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00035">dPMC</a>, and <a class="el" href="common_8h-source.html#l00056">SET</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">Attach()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00147"></a>00147     {
<a name="l00148"></a>00148         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( AT91C_BASE_PMC-&gt;PMC_SCDR, <a class="code" href="class_c_udp_driver.html#18f89c2f3a4637bd9b4f1cfdfcd2301e" title="ID to enable the USB controller peripheral clock.">dPMC</a> );
<a name="l00149"></a>00149     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="7780c2dd587f40f5b4749b8de3e9cb16"></a><!-- doxytag: member="CUdpDriver::EnableTransceiver" ref="7780c2dd587f40f5b4749b8de3e9cb16" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::EnableTransceiver           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Enables the transceiver of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00155">155</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="common_8h-source.html#l00057">CLEAR</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01306">RemoteWakeUp()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00156"></a>00156     {
<a name="l00157"></a>00157         <a class="code" href="common_8h.html#e427fe9ee3c2843715dfbdb7d4c6cadc">CLEAR</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_TXVC, AT91C_UDP_TXVDIS );
<a name="l00158"></a>00158     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="5e1d3b5c810e5a6cc75b8b0e5038ec43"></a><!-- doxytag: member="CUdpDriver::DisableTransceiver" ref="5e1d3b5c810e5a6cc75b8b0e5038ec43" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::DisableTransceiver           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Disables the transceiver of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller associated with the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00164">164</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, and <a class="el" href="common_8h-source.html#l00056">SET</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">Attach()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01531">Init()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00165"></a>00165     {
<a name="l00166"></a>00166         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_TXVC, AT91C_UDP_TXVDIS );
<a name="l00167"></a>00167     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="37b567c9205c8d3e2bdb3259123fcb05"></a><!-- doxytag: member="CUdpDriver::ClearRXFlag" ref="37b567c9205c8d3e2bdb3259123fcb05" args="(int bEndpoint)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::ClearRXFlag           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Clears the correct RX flag in an endpoint status register. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
  </table>
</dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd>CEndpoint</dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
  </table>
</dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd>CEndpoint </dd></dl>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00480">480</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00066">ClearEndpointFlags()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00682">USB::CEndpoint::dFlag</a>, <a class="el" href="usb_framework_8hpp-source.html#l00683">USB::CEndpoint::dNumFIFO</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, and <a class="el" href="trace_8h-source.html#l00049">TRACE_DEBUG_M</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00559">EndpointHandler()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01148">Read()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00481"></a>00481 {
<a name="l00482"></a>00482     <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="comment">// Clear flag</span>
<a name="l00485"></a>00485     <span class="comment">//</span>
<a name="l00486"></a>00486     <a class="code" href="class_c_udp_driver.html#1c4166268dbce6fad2de3eeb89aaf82d" title="Clear flags in the UDP_CSR register and waits for synchronization.">ClearEndpointFlags</a>( bEndpoint, pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#59ae4ebd161f62369e2fed8be64d6e4c" title="Hardware flag to clear upon data reception.">dFlag</a> );
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">// Swap banks</span>
<a name="l00489"></a>00489     <span class="comment">//</span>
<a name="l00490"></a>00490     <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#59ae4ebd161f62369e2fed8be64d6e4c" title="Hardware flag to clear upon data reception.">dFlag</a> == AT91C_UDP_RX_DATA_BK0 ) 
<a name="l00491"></a>00491     {
<a name="l00492"></a>00492         <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#c01021c63dda573b4df6fe57b6522045" title="Number of FIFO buffers defined for this endpoint.">dNumFIFO</a> &gt; 1 ) 
<a name="l00493"></a>00493         {
<a name="l00494"></a>00494             <span class="comment">// Swap bank if in dual-fifo mode</span>
<a name="l00495"></a>00495             <span class="comment">//</span>
<a name="l00496"></a>00496             pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#59ae4ebd161f62369e2fed8be64d6e4c" title="Hardware flag to clear upon data reception.">dFlag</a> = AT91C_UDP_RX_DATA_BK1;
<a name="l00497"></a>00497             
<a name="l00498"></a>00498             <a class="code" href="trace_8h.html#e5a536c839faf35fa9396e29abf2a0ab">TRACE_DEBUG_M</a>( <span class="stringliteral">"F%d(2) "</span>, bEndpoint );
<a name="l00499"></a>00499         }
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501     <span class="keywordflow">else</span> 
<a name="l00502"></a>00502     {
<a name="l00503"></a>00503         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#59ae4ebd161f62369e2fed8be64d6e4c" title="Hardware flag to clear upon data reception.">dFlag</a> = AT91C_UDP_RX_DATA_BK0;
<a name="l00504"></a>00504         <a class="code" href="trace_8h.html#e5a536c839faf35fa9396e29abf2a0ab">TRACE_DEBUG_M</a>( <span class="stringliteral">"F%d(1) "</span>, bEndpoint );
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="aa4e67dd65350793ee1db8fde2f5cb7b"></a><!-- doxytag: member="CUdpDriver::WritePayload" ref="aa4e67dd65350793ee1db8fde2f5cb7b" args="(int bEndpoint)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> CUdpDriver::WritePayload           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Transfers a data payload from the current tranfer buffer to the endpoint FIFO. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Number of bytes transferred </dd></dl>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00182">182</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00667">USB::CEndpoint::dBytesBuffered</a>, <a class="el" href="usb_framework_8hpp-source.html#l00666">USB::CEndpoint::dBytesRemaining</a>, <a class="el" href="common_8h-source.html#l00103">min()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00662">USB::CEndpoint::pData</a>, <a class="el" href="usb_framework_8hpp-source.html#l00664">USB::CEndpoint::pDataLowerBound</a>, <a class="el" href="usb_framework_8hpp-source.html#l00665">USB::CEndpoint::pDataUpperBound</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00681">USB::CEndpoint::wMaxPacketSize</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00559">EndpointHandler()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01081">Write()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00183"></a>00183     {
<a name="l00184"></a>00184         <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l00185"></a>00185         AT91_REG&amp; FDR = <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_FDR[ bEndpoint ];
<a name="l00186"></a>00186 
<a name="l00187"></a>00187         <span class="comment">// Get the number of bytes to send</span>
<a name="l00188"></a>00188         <span class="comment">//</span>
<a name="l00189"></a>00189         <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dBytes = <a class="code" href="common_8h.html#97a6b31fa879f6c56a1122dcf6b25dfe">min</a>( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#37b26a371a87c2e20a0cba903b4ec1a4" title="Maximum packet size for this endpoint.">wMaxPacketSize</a>, pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a> );
<a name="l00190"></a>00190 
<a name="l00191"></a>00191         <span class="comment">// Are we doing flat transfer or transfer across circular buffer upper boundary?</span>
<a name="l00192"></a>00192         <span class="comment">//</span>
<a name="l00193"></a>00193         <span class="keywordflow">if</span> ( ! pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#1a44ff19f6522655c4dc65da06f1747c" title="Circular buffer lower bound; pData &amp;gt;= lower bound.">pDataLowerBound</a> 
<a name="l00194"></a>00194              || pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a> + dBytes &lt; pEndpoint-&gt;pDataUpperBound 
<a name="l00195"></a>00195             ) 
<a name="l00196"></a>00196         {
<a name="l00197"></a>00197             <span class="comment">// Send data from the flat buffer (or inner part of circular buffer)</span>
<a name="l00198"></a>00198             <span class="comment">//</span>
<a name="l00199"></a>00199             <span class="keywordflow">for</span>( <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dCtr = 0; dCtr &lt; dBytes; dCtr++ )
<a name="l00200"></a>00200                 FDR = *pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a>++;
<a name="l00201"></a>00201         }
<a name="l00202"></a>00202         <span class="keywordflow">else</span> 
<a name="l00203"></a>00203         {
<a name="l00204"></a>00204             <span class="comment">// Send data by crossing upper boundary of the circular buffer. Not so often. </span>
<a name="l00205"></a>00205             <span class="comment">//</span>
<a name="l00206"></a>00206             <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> len2 = pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a> + dBytes - pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#1b1dcbd2c7c13898ca682b10ddb755ea" title="Circular buffer upper bound; pData &amp;lt; upper bound.">pDataUpperBound</a>;
<a name="l00207"></a>00207             <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> len1 = dBytes - len2;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209             <span class="keywordflow">for</span>( <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i = 0; i &lt; len1; i++ )
<a name="l00210"></a>00210                 FDR = *pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a>++;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212             pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a> = pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#1a44ff19f6522655c4dc65da06f1747c" title="Circular buffer lower bound; pData &amp;gt;= lower bound.">pDataLowerBound</a>;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214             <span class="keywordflow">for</span>( <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> i = 0; i &lt; len2; i++ )
<a name="l00215"></a>00215                 FDR = *pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a>++;
<a name="l00216"></a>00216         }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a>  += dBytes;
<a name="l00219"></a>00219         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a> -= dBytes;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         <span class="keywordflow">return</span> dBytes;
<a name="l00222"></a>00222     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="fe791e9ab368f8413d2323b95a409460"></a><!-- doxytag: member="CUdpDriver::GetPayload" ref="fe791e9ab368f8413d2323b95a409460" args="(int bEndpoint, ushort wPacketSize)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> CUdpDriver::GetPayload           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="common_8h.html#b95f123a6c9bcfee6a343170ef8c5f69">ushort</a>&nbsp;</td>
          <td class="paramname"> <em>wPacketSize</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [inline, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Transfers a data payload from an endpoint FIFO to the current transfer buffer. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>wPacketSize</em>&nbsp;</td><td>Size of received data packet </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Number of bytes transferred </dd></dl>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00231">231</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00667">USB::CEndpoint::dBytesBuffered</a>, <a class="el" href="usb_framework_8hpp-source.html#l00666">USB::CEndpoint::dBytesRemaining</a>, <a class="el" href="usb_framework_8hpp-source.html#l00669">USB::CEndpoint::dBytesTransferred</a>, <a class="el" href="common_8h-source.html#l00103">min()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00662">USB::CEndpoint::pData</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, and <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00559">EndpointHandler()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01148">Read()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00232"></a>00232     {
<a name="l00233"></a>00233         <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l00234"></a>00234         AT91_REG&amp; FDR = <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_FDR[ bEndpoint ];
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"%d "</span>, wPacketSize );
<a name="l00237"></a>00237 
<a name="l00238"></a>00238         <span class="comment">// Get number of bytes to retrieve</span>
<a name="l00239"></a>00239         <span class="comment">//</span>
<a name="l00240"></a>00240         <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dBytes = <a class="code" href="common_8h.html#97a6b31fa879f6c56a1122dcf6b25dfe">min</a>( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a>, wPacketSize );
<a name="l00241"></a>00241 
<a name="l00242"></a>00242         <span class="comment">// Retrieve packet</span>
<a name="l00243"></a>00243         <span class="comment">//</span>
<a name="l00244"></a>00244         <span class="keywordflow">for</span>( <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dCtr = 0; dCtr &lt; dBytes; dCtr++ )
<a name="l00245"></a>00245         {
<a name="l00246"></a>00246             *pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a>++ = <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>( FDR );
<a name="l00247"></a>00247         }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a>   -= dBytes;
<a name="l00250"></a>00250         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#2710027db99b5ab7b0fcd12a18de2c89">dBytesTransferred</a> += dBytes;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252         <span class="comment">// For read operation dBytesBuffered contains number of bytes remaining </span>
<a name="l00253"></a>00253         <span class="comment">// in the FIFO, i.e. bytes in last packet that are received but not read.</span>
<a name="l00254"></a>00254         <span class="comment">// Next Read() operation should return them first.</span>
<a name="l00255"></a>00255         <span class="comment">//</span>
<a name="l00256"></a>00256         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a> = wPacketSize - dBytes;
<a name="l00257"></a>00257         
<a name="l00258"></a>00258         <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"(fifo %d, remain %d) "</span>, 
<a name="l00259"></a>00259                        pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a>, pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a> );
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         <span class="keywordflow">return</span> dBytes;
<a name="l00262"></a>00262     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="2f1608a989f65367307faabb5e44f892"></a><!-- doxytag: member="CUdpDriver::ResetEndpoints" ref="2f1608a989f65367307faabb5e44f892" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::ResetEndpoints           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function reset all endpoint transfer descriptors. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00511">511</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00667">USB::CEndpoint::dBytesBuffered</a>, <a class="el" href="usb_framework_8hpp-source.html#l00666">USB::CEndpoint::dBytesRemaining</a>, <a class="el" href="usb_framework_8hpp-source.html#l00669">USB::CEndpoint::dBytesTransferred</a>, <a class="el" href="usb_framework_8hpp-source.html#l00682">USB::CEndpoint::dFlag</a>, <a class="el" href="usb_framework_8hpp-source.html#l00769">USB::CUsbDriver::dNumEndpoints</a>, <a class="el" href="usb_framework_8hpp-source.html#l00684">USB::CEndpoint::dState</a>, <a class="el" href="usb_framework_8hpp-source.html#l00674">USB::CEndpoint::fCallback</a>, <a class="el" href="usb_framework_8hpp-source.html#l00676">USB::CEndpoint::pArgument</a>, <a class="el" href="usb_framework_8hpp-source.html#l00662">USB::CEndpoint::pData</a>, <a class="el" href="usb_framework_8hpp-source.html#l00664">USB::CEndpoint::pDataLowerBound</a>, <a class="el" href="usb_framework_8hpp-source.html#l00665">USB::CEndpoint::pDataUpperBound</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00512"></a>00512 {
<a name="l00513"></a>00513     <span class="comment">// Reset the transfer descriptor of every endpoint</span>
<a name="l00514"></a>00514     <span class="comment">//</span>
<a name="l00515"></a>00515     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> bEndpoint = 0; bEndpoint &lt; <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#0742d93f329309a1961871cca9d23ae0" title="Number of endpoints in list.">dNumEndpoints</a>; bEndpoint++ )
<a name="l00516"></a>00516     {
<a name="l00517"></a>00517         <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         <span class="comment">// Reset endpoint transfer descriptor</span>
<a name="l00520"></a>00520         <span class="comment">//</span>
<a name="l00521"></a>00521         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a> = 0;
<a name="l00522"></a>00522         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#1a44ff19f6522655c4dc65da06f1747c" title="Circular buffer lower bound; pData &amp;gt;= lower bound.">pDataLowerBound</a> = 0;
<a name="l00523"></a>00523         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#1b1dcbd2c7c13898ca682b10ddb755ea" title="Circular buffer upper bound; pData &amp;lt; upper bound.">pDataUpperBound</a> = 0;
<a name="l00524"></a>00524         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a> = 0;
<a name="l00525"></a>00525         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#2710027db99b5ab7b0fcd12a18de2c89">dBytesTransferred</a> = 0;
<a name="l00526"></a>00526         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a> = 0;
<a name="l00527"></a>00527         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#6ad4c0c47c2f507cc8e5a011424af3cf">fCallback</a> = 0;
<a name="l00528"></a>00528         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#81845347951e01a0a3cb70c07e2f6a34" title="Argument to pass to the callback function.">pArgument</a> = 0;
<a name="l00529"></a>00529 
<a name="l00530"></a>00530         <span class="comment">// Configure endpoint characteristics</span>
<a name="l00531"></a>00531         <span class="comment">//</span>
<a name="l00532"></a>00532         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#59ae4ebd161f62369e2fed8be64d6e4c" title="Hardware flag to clear upon data reception.">dFlag</a> = AT91C_UDP_RX_DATA_BK0;
<a name="l00533"></a>00533         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> = CEndpoint::StateDisabled;
<a name="l00534"></a>00534     }
<a name="l00535"></a>00535 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="0054634921075da975122a537e1b6bca"></a><!-- doxytag: member="CUdpDriver::DisableEndpoints" ref="0054634921075da975122a537e1b6bca" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::DisableEndpoints           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Disable all endpoints (except control endpoint 0), aborting current transfers if necessary. 
<p>
Disable all endpoints (except control endpoint 0), aborting current transfers if necessary. 
<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00541">541</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00769">USB::CUsbDriver::dNumEndpoints</a>, <a class="el" href="usb_framework_8hpp-source.html#l00684">USB::CEndpoint::dState</a>, <a class="el" href="usb_framework_8hpp-source.html#l00723">USB::CEndpoint::EndOfTransfer()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00335">USB::USB_STATUS_RESET</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">Attach()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01457">SetConfiguration()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00542"></a>00542 {
<a name="l00543"></a>00543     <span class="comment">// For each endpoint, if it is enabled, disable it and invoke the callback</span>
<a name="l00544"></a>00544     <span class="comment">// Control endpoint 0 is not disabled</span>
<a name="l00545"></a>00545     <span class="comment">//</span>
<a name="l00546"></a>00546     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> bEndpoint = 1; bEndpoint &lt; <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#0742d93f329309a1961871cca9d23ae0" title="Number of endpoints in list.">dNumEndpoints</a>; bEndpoint++ ) 
<a name="l00547"></a>00547     {
<a name="l00548"></a>00548         <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l00549"></a>00549         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3bd504d483b3e015cee4d1ebbc02dc1f" title="Invokes the callback associated with a finished transfer on an endpoint.">EndOfTransfer</a>( <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfdd5309c830cdf5d2c3d1e507448d25aa">USB_STATUS_RESET</a> );
<a name="l00550"></a>00550         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> = CEndpoint::StateDisabled;
<a name="l00551"></a>00551     }
<a name="l00552"></a>00552 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="2654684e8906700c508d3f10d133404a"></a><!-- doxytag: member="CUdpDriver::EndpointHandler" ref="2654684e8906700c508d3f10d133404a" args="(int bEndpoint)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::EndpointHandler           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Endpoint interrupt handler. Handle IN/OUT transfers, received SETUP packets and STALLing. 
<p>
Endpoint interrupt handler. Handle IN/OUT transfers, received SETUP packets and STALLing.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00559">559</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00671">USB::CEndpoint::bCompletePacket</a>, <a class="el" href="usb_framework_8hpp-source.html#l00374">USB::S_usb_request::bmRequestType</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00066">ClearEndpointFlags()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00480">ClearRXFlag()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00667">USB::CEndpoint::dBytesBuffered</a>, <a class="el" href="usb_framework_8hpp-source.html#l00666">USB::CEndpoint::dBytesRemaining</a>, <a class="el" href="usb_framework_8hpp-source.html#l00669">USB::CEndpoint::dBytesTransferred</a>, <a class="el" href="usb_framework_8hpp-source.html#l00683">USB::CEndpoint::dNumFIFO</a>, <a class="el" href="usb_framework_8hpp-source.html#l00684">USB::CEndpoint::dState</a>, <a class="el" href="usb_framework_8hpp-source.html#l00723">USB::CEndpoint::EndOfTransfer()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00231">GetPayload()</a>, <a class="el" href="common_8h-source.html#l00061">ISCLEARED</a>, <a class="el" href="common_8h-source.html#l00060">ISSET</a>, <a class="el" href="class_u_s_b_1_1_c_event_sink.html#877065d65cda66442879aa5c299856ad">USB::CEventSink::OnNewRequest()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, <a class="el" href="usb_framework_8hpp-source.html#l00766">USB::CUsbDriver::pEventSink</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00093">SetEndpointFlags()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00770">USB::CUsbDriver::sSetup</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, <a class="el" href="usb_framework_8hpp-source.html#l00179">USB::USB_DIR_DEVICE2HOST</a>, <a class="el" href="usb_framework_8hpp-source.html#l00203">USB_REQUEST_DIR</a>, <a class="el" href="usb_framework_8hpp-source.html#l00331">USB::USB_STATUS_SUCCESS</a>, <a class="el" href="usb_framework_8hpp-source.html#l00681">USB::CEndpoint::wMaxPacketSize</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l00182">WritePayload()</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00560"></a>00560 {
<a name="l00561"></a>00561     <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l00562"></a>00562     <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dCSR = <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_CSR[ bEndpoint ];
<a name="l00563"></a>00563 
<a name="l00564"></a>00564     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Ept%d "</span>, bEndpoint);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="comment">//-----------------------------------------------------------------------------------</span>
<a name="l00567"></a>00567     <span class="comment">// Handle interrupts</span>
<a name="l00568"></a>00568     <span class="comment">//-----------------------------------------------------------------------------------</span>
<a name="l00569"></a>00569     
<a name="l00570"></a>00570     <span class="comment">//-----------------------------------------------------------------------------------</span>
<a name="l00571"></a>00571     <span class="comment">// IN packet sent</span>
<a name="l00572"></a>00572     <span class="comment">//</span>
<a name="l00573"></a>00573     <span class="keywordflow">if</span> ( <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dCSR, AT91C_UDP_TXCOMP ) )
<a name="l00574"></a>00574     {
<a name="l00575"></a>00575         <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Wr "</span> );
<a name="l00576"></a>00576 
<a name="l00577"></a>00577         <span class="comment">// Check that endpoint was in Write state</span>
<a name="l00578"></a>00578         <span class="comment">//</span>
<a name="l00579"></a>00579         <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> == CEndpoint::StateWrite )
<a name="l00580"></a>00580         {
<a name="l00581"></a>00581             <span class="comment">// End of transfer ?</span>
<a name="l00582"></a>00582             <span class="comment">//</span>
<a name="l00583"></a>00583             <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a> &lt; pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#37b26a371a87c2e20a0cba903b4ec1a4" title="Maximum packet size for this endpoint.">wMaxPacketSize</a>
<a name="l00584"></a>00584                 || ( 
<a name="l00585"></a>00585                   ! pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b0ae95fcf8a933e9665ab69a481603d5">bCompletePacket</a>
<a name="l00586"></a>00586                   &amp;&amp; ! <a class="code" href="common_8h.html#586a31f567cc4aff5a205870e4933991">ISCLEARED</a>( dCSR, AT91C_UDP_EPTYPE )
<a name="l00587"></a>00587                   &amp;&amp; pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a> == 0
<a name="l00588"></a>00588                   &amp;&amp; pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a> == pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#37b26a371a87c2e20a0cba903b4ec1a4" title="Maximum packet size for this endpoint.">wMaxPacketSize</a>
<a name="l00589"></a>00589                   )
<a name="l00590"></a>00590                 )
<a name="l00591"></a>00591             {
<a name="l00592"></a>00592                 <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"%d "</span>, pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a> );
<a name="l00593"></a>00593 
<a name="l00594"></a>00594                 pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#2710027db99b5ab7b0fcd12a18de2c89">dBytesTransferred</a> += pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a>;
<a name="l00595"></a>00595                 pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a> = 0;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597                 <span class="comment">// Disable interrupt if this is not a control endpoint</span>
<a name="l00598"></a>00598                 <span class="comment">//</span>
<a name="l00599"></a>00599                 <span class="keywordflow">if</span> ( ! <a class="code" href="common_8h.html#586a31f567cc4aff5a205870e4933991">ISCLEARED</a>( dCSR, AT91C_UDP_EPTYPE ) )
<a name="l00600"></a>00600                 {
<a name="l00601"></a>00601                     <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IDR, 1 &lt;&lt; bEndpoint );
<a name="l00602"></a>00602                 }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604                 pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3bd504d483b3e015cee4d1ebbc02dc1f" title="Invokes the callback associated with a finished transfer on an endpoint.">EndOfTransfer</a>( <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB_STATUS_SUCCESS</a> );
<a name="l00605"></a>00605             }
<a name="l00606"></a>00606             <span class="keywordflow">else</span> 
<a name="l00607"></a>00607             {
<a name="l00608"></a>00608                 <span class="comment">// Transfer remaining data</span>
<a name="l00609"></a>00609                 <span class="comment">//</span>
<a name="l00610"></a>00610                 <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"%d "</span>, pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#37b26a371a87c2e20a0cba903b4ec1a4" title="Maximum packet size for this endpoint.">wMaxPacketSize</a> );
<a name="l00611"></a>00611 
<a name="l00612"></a>00612                 pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#2710027db99b5ab7b0fcd12a18de2c89">dBytesTransferred</a> += pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#37b26a371a87c2e20a0cba903b4ec1a4" title="Maximum packet size for this endpoint.">wMaxPacketSize</a>;
<a name="l00613"></a>00613                 pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a>    -= pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#37b26a371a87c2e20a0cba903b4ec1a4" title="Maximum packet size for this endpoint.">wMaxPacketSize</a>;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615                 <span class="comment">// Send next packet</span>
<a name="l00616"></a>00616                 <span class="comment">//</span>
<a name="l00617"></a>00617                 <span class="keywordflow">if</span>( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#c01021c63dda573b4df6fe57b6522045" title="Number of FIFO buffers defined for this endpoint.">dNumFIFO</a> == 1 )
<a name="l00618"></a>00618                 {
<a name="l00619"></a>00619                     <span class="comment">// No double buffering</span>
<a name="l00620"></a>00620                     <span class="comment">//</span>
<a name="l00621"></a>00621                     <a class="code" href="class_c_udp_driver.html#aa4e67dd65350793ee1db8fde2f5cb7b" title="Transfers a data payload from the current tranfer buffer to the endpoint FIFO.">WritePayload</a>( bEndpoint );
<a name="l00622"></a>00622                     <a class="code" href="class_c_udp_driver.html#6aa2661dfca334908398ec3a324f65f4" title="Set flags in the UDP_CSR register and waits for synchronization.">SetEndpointFlags</a>( bEndpoint, AT91C_UDP_TXPKTRDY );
<a name="l00623"></a>00623                 }
<a name="l00624"></a>00624                 <span class="keywordflow">else</span>
<a name="l00625"></a>00625                 {
<a name="l00626"></a>00626                     <span class="comment">// Double buffering</span>
<a name="l00627"></a>00627                     <span class="comment">//</span>
<a name="l00628"></a>00628                     <a class="code" href="class_c_udp_driver.html#6aa2661dfca334908398ec3a324f65f4" title="Set flags in the UDP_CSR register and waits for synchronization.">SetEndpointFlags</a>( bEndpoint, AT91C_UDP_TXPKTRDY );
<a name="l00629"></a>00629                     <a class="code" href="class_c_udp_driver.html#aa4e67dd65350793ee1db8fde2f5cb7b" title="Transfers a data payload from the current tranfer buffer to the endpoint FIFO.">WritePayload</a>( bEndpoint );
<a name="l00630"></a>00630                 }
<a name="l00631"></a>00631             }
<a name="l00632"></a>00632         }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         <span class="comment">// Acknowledge interrupt</span>
<a name="l00635"></a>00635         <span class="comment">//</span>
<a name="l00636"></a>00636         <a class="code" href="class_c_udp_driver.html#1c4166268dbce6fad2de3eeb89aaf82d" title="Clear flags in the UDP_CSR register and waits for synchronization.">ClearEndpointFlags</a>( bEndpoint, AT91C_UDP_TXCOMP );
<a name="l00637"></a>00637     }
<a name="l00638"></a>00638     
<a name="l00639"></a>00639     <span class="comment">//-----------------------------------------------------------------------------------</span>
<a name="l00640"></a>00640     <span class="comment">// OUT packet received</span>
<a name="l00641"></a>00641     <span class="comment">//</span>
<a name="l00642"></a>00642     <span class="keywordflow">if</span> ( <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dCSR, AT91C_UDP_RX_DATA_BK0 ) || <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dCSR, AT91C_UDP_RX_DATA_BK1 ) )
<a name="l00643"></a>00643     {
<a name="l00644"></a>00644         <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Rd "</span> );
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         <span class="comment">// Check that the endpoint is in Read state</span>
<a name="l00647"></a>00647         <span class="comment">//</span>
<a name="l00648"></a>00648         <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> != CEndpoint::StateRead )
<a name="l00649"></a>00649         {
<a name="l00650"></a>00650             <span class="comment">// Endpoint is NOT in Read state</span>
<a name="l00651"></a>00651             <span class="comment">//</span>
<a name="l00652"></a>00652             <span class="keywordflow">if</span> ( <a class="code" href="common_8h.html#586a31f567cc4aff5a205870e4933991">ISCLEARED</a>( dCSR, AT91C_UDP_EPTYPE ) &amp;&amp; <a class="code" href="common_8h.html#586a31f567cc4aff5a205870e4933991">ISCLEARED</a>( dCSR, 0xFFFF0000 )
<a name="l00653"></a>00653                 )
<a name="l00654"></a>00654             {
<a name="l00655"></a>00655                 <span class="comment">// Control endpoint, 0 bytes received</span>
<a name="l00656"></a>00656                 <span class="comment">// Acknowledge the data and finish the current transfer</span>
<a name="l00657"></a>00657                 <span class="comment">//</span>
<a name="l00658"></a>00658                 <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Ack "</span> );
<a name="l00659"></a>00659                 <a class="code" href="class_c_udp_driver.html#37b567c9205c8d3e2bdb3259123fcb05" title="Clears the correct RX flag in an endpoint status register.">ClearRXFlag</a>( bEndpoint );
<a name="l00660"></a>00660 
<a name="l00661"></a>00661                 pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3bd504d483b3e015cee4d1ebbc02dc1f" title="Invokes the callback associated with a finished transfer on an endpoint.">EndOfTransfer</a>( <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB_STATUS_SUCCESS</a> );
<a name="l00662"></a>00662             }
<a name="l00663"></a>00663             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dCSR, AT91C_UDP_FORCESTALL ) )
<a name="l00664"></a>00664             {
<a name="l00665"></a>00665                 <span class="comment">// Non-control endpoint</span>
<a name="l00666"></a>00666                 <span class="comment">// Discard stalled data</span>
<a name="l00667"></a>00667                 <span class="comment">//</span>
<a name="l00668"></a>00668                 <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Disc "</span> );
<a name="l00669"></a>00669                 <a class="code" href="class_c_udp_driver.html#37b567c9205c8d3e2bdb3259123fcb05" title="Clears the correct RX flag in an endpoint status register.">ClearRXFlag</a>( bEndpoint );
<a name="l00670"></a>00670             }
<a name="l00671"></a>00671             <span class="keywordflow">else</span>
<a name="l00672"></a>00672             {
<a name="l00673"></a>00673                 <span class="comment">// Non-control endpoint</span>
<a name="l00674"></a>00674                 <span class="comment">// Nak data</span>
<a name="l00675"></a>00675                 <span class="comment">//</span>
<a name="l00676"></a>00676                 <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Nak "</span> );
<a name="l00677"></a>00677                 <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IDR, 1 &lt;&lt; bEndpoint );
<a name="l00678"></a>00678             }
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680         <span class="keywordflow">else</span>
<a name="l00681"></a>00681         {
<a name="l00682"></a>00682             <span class="comment">// Endpoint is in Read state</span>
<a name="l00683"></a>00683             <span class="comment">// Retrieve data and store it into the current transfer buffer</span>
<a name="l00684"></a>00684             <span class="comment">//</span>
<a name="l00685"></a>00685             <a class="code" href="common_8h.html#b95f123a6c9bcfee6a343170ef8c5f69">ushort</a> wPacketSize = <a class="code" href="common_8h.html#b95f123a6c9bcfee6a343170ef8c5f69">ushort</a>( dCSR &gt;&gt; 16 );
<a name="l00686"></a>00686 
<a name="l00687"></a>00687             <a class="code" href="class_c_udp_driver.html#fe791e9ab368f8413d2323b95a409460" title="Transfers a data payload from an endpoint FIFO to the current transfer buffer.">GetPayload</a>( bEndpoint, wPacketSize );
<a name="l00688"></a>00688             
<a name="l00689"></a>00689             <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a> == 0
<a name="l00690"></a>00690                 || wPacketSize &lt; pEndpoint-&gt;wMaxPacketSize 
<a name="l00691"></a>00691                 )
<a name="l00692"></a>00692             {
<a name="l00693"></a>00693                 <span class="comment">// Disable interrupt if this is not a control endpoint</span>
<a name="l00694"></a>00694                 <span class="comment">//</span>
<a name="l00695"></a>00695                 <span class="keywordflow">if</span> ( ! <a class="code" href="common_8h.html#586a31f567cc4aff5a205870e4933991">ISCLEARED</a>( dCSR, AT91C_UDP_EPTYPE ) )
<a name="l00696"></a>00696                 {
<a name="l00697"></a>00697                     <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IDR, 1 &lt;&lt; bEndpoint );
<a name="l00698"></a>00698                 }
<a name="l00699"></a>00699             }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701             <span class="comment">// Maybe there is still data left in FIFO? Check pEndpoint-&gt;dBytesBuffered</span>
<a name="l00702"></a>00702             <span class="comment">// and clear RX flag (i.e. swap FIFO banks) if there is no data left in FIFO.</span>
<a name="l00703"></a>00703             <span class="comment">//</span>
<a name="l00704"></a>00704             <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a> == 0 )
<a name="l00705"></a>00705             {
<a name="l00706"></a>00706                 <a class="code" href="class_c_udp_driver.html#37b567c9205c8d3e2bdb3259123fcb05" title="Clears the correct RX flag in an endpoint status register.">ClearRXFlag</a>( bEndpoint );
<a name="l00707"></a>00707             }
<a name="l00708"></a>00708 
<a name="l00709"></a>00709             <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a> == 0
<a name="l00710"></a>00710                 || wPacketSize &lt; pEndpoint-&gt;wMaxPacketSize 
<a name="l00711"></a>00711                 )
<a name="l00712"></a>00712             {
<a name="l00713"></a>00713                 pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3bd504d483b3e015cee4d1ebbc02dc1f" title="Invokes the callback associated with a finished transfer on an endpoint.">EndOfTransfer</a>( <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB_STATUS_SUCCESS</a> );
<a name="l00714"></a>00714             }
<a name="l00715"></a>00715         }
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="comment">//-----------------------------------------------------------------------------------</span>
<a name="l00719"></a>00719     <span class="comment">// SETUP packet received</span>
<a name="l00720"></a>00720     <span class="comment">//</span>
<a name="l00721"></a>00721     <span class="keywordflow">if</span> ( <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dCSR, AT91C_UDP_RXSETUP ) )
<a name="l00722"></a>00722     {
<a name="l00723"></a>00723         <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Stp "</span> );
<a name="l00724"></a>00724 
<a name="l00725"></a>00725         <span class="comment">// If a transfer was pending, complete it</span>
<a name="l00726"></a>00726         <span class="comment">// Handle the case where during the status phase of a control write</span>
<a name="l00727"></a>00727         <span class="comment">// transfer, the host receives the device ZLP and ack it, but the ack</span>
<a name="l00728"></a>00728         <span class="comment">// is not received by the device</span>
<a name="l00729"></a>00729         <span class="comment">//</span>
<a name="l00730"></a>00730         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3bd504d483b3e015cee4d1ebbc02dc1f" title="Invokes the callback associated with a finished transfer on an endpoint.">EndOfTransfer</a>( <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB_STATUS_SUCCESS</a> );
<a name="l00731"></a>00731 
<a name="l00732"></a>00732         <span class="comment">// Transfers a received SETUP packet from endpoint 0 FIFO to the</span>
<a name="l00733"></a>00733         <span class="comment">// S_usb_request structure of an USB driver</span>
<a name="l00734"></a>00734         <span class="comment">//</span>
<a name="l00735"></a>00735         <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>* pData = (<a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#e291dea0fc434bbc3a6ce8e72c630e5e" title="Pointer to the last received SETUP packet.">sSetup</a>;
<a name="l00736"></a>00736         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> dCtr = 0; dCtr &lt; 8; dCtr++ ) 
<a name="l00737"></a>00737         {
<a name="l00738"></a>00738             *pData++ = <a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_FDR[0] );
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741         <span class="comment">// Set the DIR bit before clearing RXSETUP in Control IN sequence</span>
<a name="l00742"></a>00742         <span class="comment">//</span>
<a name="l00743"></a>00743         <span class="keywordflow">if</span> ( <a class="code" href="usb_framework_8hpp.html#58b5b26978be0ad1ec98293856940daa" title="Get the data transfer direction bits [4..0] from the bmRequestType.">USB_REQUEST_DIR</a>( <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#e291dea0fc434bbc3a6ce8e72c630e5e" title="Pointer to the last received SETUP packet.">sSetup</a>.<a class="code" href="struct_u_s_b_1_1_s__usb__request.html#f0ec7131e6973c1b3d5e57d51b356f4f" title="Characteristics of the request.">bmRequestType</a> ) == <a class="code" href="group__usb__std.html#ggd47e155425c464b8a03c7c56847be18bcb146c72cfadd54a8e5fdd0ce193c2df" title="Host to device data transfer direction.">USB_DIR_DEVICE2HOST</a> )
<a name="l00744"></a>00744         {
<a name="l00745"></a>00745             <a class="code" href="class_c_udp_driver.html#6aa2661dfca334908398ec3a324f65f4" title="Set flags in the UDP_CSR register and waits for synchronization.">SetEndpointFlags</a>( bEndpoint, AT91C_UDP_DIR );
<a name="l00746"></a>00746         }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         <a class="code" href="class_c_udp_driver.html#1c4166268dbce6fad2de3eeb89aaf82d" title="Clear flags in the UDP_CSR register and waits for synchronization.">ClearEndpointFlags</a>( bEndpoint, AT91C_UDP_RXSETUP );
<a name="l00749"></a>00749 
<a name="l00750"></a>00750         <span class="comment">// Forward the request to the upper layer</span>
<a name="l00751"></a>00751         <span class="comment">//</span>
<a name="l00752"></a>00752         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#fff7a79587118ff01493c7ad5aa922d1" title="Pointer to associated CEventSink instance.">pEventSink</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_event_sink.html#877065d65cda66442879aa5c299856ad" title="New Request callback function.">OnNewRequest</a> ();
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     <span class="comment">//-----------------------------------------------------------------------------------</span>
<a name="l00756"></a>00756     <span class="comment">// STALL sent</span>
<a name="l00757"></a>00757     <span class="comment">//</span>
<a name="l00758"></a>00758     <span class="keywordflow">if</span> ( <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dCSR, AT91C_UDP_STALLSENT ) )
<a name="l00759"></a>00759     {
<a name="l00760"></a>00760         <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Sta "</span> );
<a name="l00761"></a>00761 
<a name="l00762"></a>00762         <span class="comment">// Acknowledge the stall flag</span>
<a name="l00763"></a>00763         <span class="comment">//</span>
<a name="l00764"></a>00764         <a class="code" href="class_c_udp_driver.html#1c4166268dbce6fad2de3eeb89aaf82d" title="Clear flags in the UDP_CSR register and waits for synchronization.">ClearEndpointFlags</a>( bEndpoint, AT91C_UDP_STALLSENT );
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         <span class="comment">// If the endpoint is not halted, clear the stall condition</span>
<a name="l00767"></a>00767         <span class="comment">//</span>
<a name="l00768"></a>00768         <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> != CEndpoint::StateHalted )
<a name="l00769"></a>00769         {
<a name="l00770"></a>00770             <a class="code" href="class_c_udp_driver.html#1c4166268dbce6fad2de3eeb89aaf82d" title="Clear flags in the UDP_CSR register and waits for synchronization.">ClearEndpointFlags</a>( bEndpoint, AT91C_UDP_FORCESTALL );
<a name="l00771"></a>00771         }
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="42223dfccbe074e52aa7d479673fe2eb"></a><!-- doxytag: member="CUdpDriver::GetInterface" ref="42223dfccbe074e52aa7d479673fe2eb" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* CUdpDriver::GetInterface           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [inline, private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Returns a pointer to the UDP controller interface used by an <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver. The pointer is cast to the correct type (AT91PS_UDP). 
<p>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#b8613a7a4721ec152a2c191642051176">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00294">294</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00295"></a>00295     {
<a name="l00296"></a>00296         <span class="keywordflow">return</span> <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>;
<a name="l00297"></a>00297     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b079ba266637f6b00d017388ba2610df"></a><!-- doxytag: member="CUdpDriver::GetDriverID" ref="b079ba266637f6b00d017388ba2610df" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> CUdpDriver::GetDriverID           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [inline, private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Returns the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral ID of a <a class="el" href="class_c_udp_driver.html">CUdpDriver</a> instance. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd><a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral ID </dd></dl>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#1e0621b29740c428593c29bfc494b671">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00303">303</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00034">dID</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00304"></a>00304     {
<a name="l00305"></a>00305         <span class="keywordflow">return</span> <a class="code" href="class_c_udp_driver.html#6e21f491e8f4c50291fd14774509504c" title="ID of the USB controller peripheral.">dID</a>;
<a name="l00306"></a>00306     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="470ca17d526df70db31441ef23325dd4"></a><!-- doxytag: member="CUdpDriver::Init" ref="470ca17d526df70db31441ef23325dd4" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::Init           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initializes the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> API and the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller. 
<p>
Initializes the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> driver.<p>
This method must be called prior to using an other <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> method. Before finishing, it invokes the OnInit callback. <dl class="see" compact><dt><b>See also:</b></dt><dd>OnInit</dd></dl>
This function initializes the current FIFO bank of endpoints, configures the pull-up and VBus lines, disconnects the pull-up and then trigger the Init callback. 
<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#8283e8a401d26b00151ca4bdcf1d5347">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01531">1531</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00800">USB::CUsbDriver::ClearState()</a>, <a class="el" href="class_u_s_b_1_1_c_board.html#3fc039317e123bc616ee048b73009b77">USB::CBoard::ConfigurePullUp()</a>, <a class="el" href="class_u_s_b_1_1_c_board.html#e00e9e8fba98a80acb803a1923954fb1">USB::CBoard::ConfigureVBus()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01488">Connect()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00682">USB::CEndpoint::dFlag</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00128">DisableMCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00164">DisableTransceiver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01507">Disconnect()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00769">USB::CUsbDriver::dNumEndpoints</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00119">EnableMCK()</a>, <a class="el" href="class_u_s_b_1_1_c_event_sink.html#a56d9cef0c8a010d25ff5d09d019e4ab">USB::CEventSink::OnInit()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00767">USB::CUsbDriver::pBoard</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, <a class="el" href="usb_framework_8hpp-source.html#l00766">USB::CUsbDriver::pEventSink</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="usb_framework_8hpp-source.html#l00792">USB::CUsbDriver::SetState()</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, <a class="el" href="trace_8h-source.html#l00073">TRACE_ERROR</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00348">USB::USB_STATE_ATTACHED</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01532"></a>01532 {
<a name="l01533"></a>01533     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"CUdpDriver::Init()\n"</span> );
<a name="l01534"></a>01534     
<a name="l01535"></a>01535     <span class="keywordflow">if</span> ( ! <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#fff7a79587118ff01493c7ad5aa922d1" title="Pointer to associated CEventSink instance.">pEventSink</a> )
<a name="l01536"></a>01536     {
<a name="l01537"></a>01537         <a class="code" href="trace_8h.html#af9a5c67ad0ffd97cfca6d77c6af536f">TRACE_ERROR</a>( <span class="stringliteral">"CUdpDriver::Init: Event sink instance is not defined\n"</span> );
<a name="l01538"></a>01538         <span class="keywordflow">return</span>;
<a name="l01539"></a>01539     }
<a name="l01540"></a>01540 
<a name="l01541"></a>01541     <span class="comment">// Init data banks</span>
<a name="l01542"></a>01542     <span class="comment">//</span>
<a name="l01543"></a>01543     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> bEndpoint = 0; bEndpoint &lt; <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#0742d93f329309a1961871cca9d23ae0" title="Number of endpoints in list.">dNumEndpoints</a>; bEndpoint++ )
<a name="l01544"></a>01544     {
<a name="l01545"></a>01545         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ].<a class="code" href="class_u_s_b_1_1_c_endpoint.html#59ae4ebd161f62369e2fed8be64d6e4c" title="Hardware flag to clear upon data reception.">dFlag</a> = AT91C_UDP_RX_DATA_BK0;
<a name="l01546"></a>01546     }
<a name="l01547"></a>01547 
<a name="l01548"></a>01548     <span class="comment">// Configure external pull-up on D+</span>
<a name="l01549"></a>01549     <span class="comment">//</span>
<a name="l01550"></a>01550     <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#64525692d796e77f889bf02d32487d18" title="Pointer to associated CBoard instance.">pBoard</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_board.html#3fc039317e123bc616ee048b73009b77" title="Configures the external pull-up on the D+ line associated with the specified USB...">ConfigurePullUp</a> ();
<a name="l01551"></a>01551     
<a name="l01552"></a>01552     <span class="comment">// Configure VBus monitoring</span>
<a name="l01553"></a>01553     <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#64525692d796e77f889bf02d32487d18" title="Pointer to associated CBoard instance.">pBoard</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_board.html#e00e9e8fba98a80acb803a1923954fb1" title="Configures the VBus monitoring PIO associated with the specified USB controller.">ConfigureVBus</a> ();
<a name="l01554"></a>01554 
<a name="l01555"></a>01555     <span class="comment">// Disable</span>
<a name="l01556"></a>01556     <span class="comment">//</span>
<a name="l01557"></a>01557     <a class="code" href="class_c_udp_driver.html#a42ff5ccc0e5a31aee80d2d837ccf67f" title="Disconnects the device from the USB.">Disconnect</a> ();
<a name="l01558"></a>01558 
<a name="l01559"></a>01559     <span class="comment">// Device is in the Attached state</span>
<a name="l01560"></a>01560     <span class="comment">//</span>
<a name="l01561"></a>01561     <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#1aab07c6a713076a742c535c0dec3d38" title="Clear flag(s) in dStatus register. If the method is called without arguments, it...">ClearState</a> ();
<a name="l01562"></a>01562     <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#a64fb09dc12bfcd63241ed9f8cd282d9" title="Set flag(s) in dStatus register.">SetState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bdec7a37408848350c93bab719752d6bba" title="Attached state.">USB_STATE_ATTACHED</a> );
<a name="l01563"></a>01563 
<a name="l01564"></a>01564     <span class="comment">// Disable the UDP transceiver and interrupts</span>
<a name="l01565"></a>01565     <span class="comment">//</span>
<a name="l01566"></a>01566     <a class="code" href="class_c_udp_driver.html#57f192544cb44433586de297a23747ca" title="Enables the peripheral clock of the USB controller associated with the specified...">EnableMCK</a> ();
<a name="l01567"></a>01567     <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IDR, AT91C_UDP_RXRSM );
<a name="l01568"></a>01568     <a class="code" href="class_c_udp_driver.html#9721403973d6af1963a444ab7c8ca162" title="Connects the device to the USB.">Connect</a> ();
<a name="l01569"></a>01569     <a class="code" href="class_c_udp_driver.html#5e1d3b5c810e5a6cc75b8b0e5038ec43" title="Disables the transceiver of the USB controller associated with the specified USB...">DisableTransceiver</a> ();
<a name="l01570"></a>01570     <a class="code" href="class_c_udp_driver.html#649855193003a419cd39c5a66fa30503" title="Disables the peripheral clock of the USB controller associated with the specified...">DisableMCK</a> ();
<a name="l01571"></a>01571     <a class="code" href="class_c_udp_driver.html#a42ff5ccc0e5a31aee80d2d837ccf67f" title="Disconnects the device from the USB.">Disconnect</a> ();
<a name="l01572"></a>01572 
<a name="l01573"></a>01573     <span class="comment">// Configure interrupts</span>
<a name="l01574"></a>01574     <span class="comment">//</span>
<a name="l01575"></a>01575     <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#fff7a79587118ff01493c7ad5aa922d1" title="Pointer to associated CEventSink instance.">pEventSink</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_event_sink.html#a56d9cef0c8a010d25ff5d09d019e4ab" title="Callback API (usb_api_callbacks).">OnInit</a> ();
<a name="l01576"></a>01576 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="a7721b2c4e62455efceb0f3c29a24b2a"></a><!-- doxytag: member="CUdpDriver::Write" ref="a7721b2c4e62455efceb0f3c29a24b2a" args="(int bEndpoint, const void *pData, uint dLength, Callback_f fCallback, void *pArgument, const void *pDataLowerBound, const void *pDataUpperBound)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf">EnumStandardReturnValue</a> CUdpDriver::Write           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>pData</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td>
          <td class="paramname"> <em>dLength</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="common_8h.html#a2b4c1da14449a039464b0a1703fb21b">Callback_f</a>&nbsp;</td>
          <td class="paramname"> <em>fCallback</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>pArgument</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>pDataLowerBound</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>pDataUpperBound</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Sends data through an <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> endpoint. 
<p>
This method sends the specified amount of data through a particular endpoint. The transfer finishes either when the data has been completely sent, or an abnormal condition causes the API to abort this operation. An optional user-provided callback can be invoked once the transfer is complete. On control endpoints, this function automatically send a Zero-Length Packet (ZLP) if the data payload size is a multiple of the endpoint maximum packet size. This is not the case for bulk, interrupt or isochronous endpoints. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Number of the endpoint through which to send the data </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pData</em>&nbsp;</td><td>Pointer to a buffer containing the data to send </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dLength</em>&nbsp;</td><td>Size of the data buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>fCallback</em>&nbsp;</td><td>Callback function to invoke when the transfer finishes </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pArgument</em>&nbsp;</td><td>Optional parameter to pass to the callback function </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Result of operation </dd></dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd>EnumStandardReturnValue</dd></dl>
Sets up the transfer descriptor, write one or two data payloads (depending on the number of FIFO banks for the endpoint) and then starts the actual transfer. The operation is complete when all the data has been sent. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pData</em>&nbsp;</td><td>Pointer to a buffer containing the data to send </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dLength</em>&nbsp;</td><td>Length of the data buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>fCallback</em>&nbsp;</td><td>Optional function to invoke when the transfer finishes </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pArgument</em>&nbsp;</td><td>Optional argument for the callback function </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pDataLowerBound</em>&nbsp;</td><td>Lower bound of the circular buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pDataUpperBound</em>&nbsp;</td><td>Upper bound of the circular buffer </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Operation result code </dd></dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd>EnumStandardReturnValue <p>
<a class="el" href="common_8h.html#a2b4c1da14449a039464b0a1703fb21b">Callback_f</a> </dd></dl>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#4e5d4071c6c408307960ddd082ee7936">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01081">1081</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00671">USB::CEndpoint::bCompletePacket</a>, <a class="el" href="usb_framework_8hpp-source.html#l00667">USB::CEndpoint::dBytesBuffered</a>, <a class="el" href="usb_framework_8hpp-source.html#l00666">USB::CEndpoint::dBytesRemaining</a>, <a class="el" href="usb_framework_8hpp-source.html#l00669">USB::CEndpoint::dBytesTransferred</a>, <a class="el" href="usb_framework_8hpp-source.html#l00683">USB::CEndpoint::dNumFIFO</a>, <a class="el" href="usb_framework_8hpp-source.html#l00684">USB::CEndpoint::dState</a>, <a class="el" href="usb_framework_8hpp-source.html#l00674">USB::CEndpoint::fCallback</a>, <a class="el" href="usb_framework_8hpp-source.html#l00676">USB::CEndpoint::pArgument</a>, <a class="el" href="usb_framework_8hpp-source.html#l00662">USB::CEndpoint::pData</a>, <a class="el" href="usb_framework_8hpp-source.html#l00664">USB::CEndpoint::pDataLowerBound</a>, <a class="el" href="usb_framework_8hpp-source.html#l00665">USB::CEndpoint::pDataUpperBound</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00093">SetEndpointFlags()</a>, <a class="el" href="trace_8h-source.html#l00049">TRACE_DEBUG_M</a>, <a class="el" href="usb_framework_8hpp-source.html#l00332">USB::USB_STATUS_LOCKED</a>, <a class="el" href="usb_framework_8hpp-source.html#l00331">USB::USB_STATUS_SUCCESS</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l00182">WritePayload()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01087"></a>01087 {
<a name="l01088"></a>01088     <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l01089"></a>01089 
<a name="l01090"></a>01090     <span class="comment">// Check that the endpoint is in Idle state</span>
<a name="l01091"></a>01091     <span class="comment">//</span>
<a name="l01092"></a>01092     <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> != CEndpoint::StateIdle )
<a name="l01093"></a>01093     {
<a name="l01094"></a>01094         <span class="keywordflow">return</span> <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfa36c09a99061cf98307230aea69e4d4e">USB_STATUS_LOCKED</a>;
<a name="l01095"></a>01095     }
<a name="l01096"></a>01096 
<a name="l01097"></a>01097     <a class="code" href="trace_8h.html#e5a536c839faf35fa9396e29abf2a0ab">TRACE_DEBUG_M</a>( <span class="stringliteral">"Write%d%4d "</span>, bEndpoint, dLength );
<a name="l01098"></a>01098 
<a name="l01099"></a>01099     <span class="comment">// Setup the transfer descriptor</span>
<a name="l01100"></a>01100     <span class="comment">//</span>
<a name="l01101"></a>01101     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a>             = (<a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) pData;
<a name="l01102"></a>01102     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#1a44ff19f6522655c4dc65da06f1747c" title="Circular buffer lower bound; pData &amp;gt;= lower bound.">pDataLowerBound</a>   = (<a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) pDataLowerBound;
<a name="l01103"></a>01103     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#1b1dcbd2c7c13898ca682b10ddb755ea" title="Circular buffer upper bound; pData &amp;lt; upper bound.">pDataUpperBound</a>   = (<a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) pDataUpperBound;
<a name="l01104"></a>01104     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a>   = dLength;
<a name="l01105"></a>01105     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a>    = 0;
<a name="l01106"></a>01106     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#2710027db99b5ab7b0fcd12a18de2c89">dBytesTransferred</a> = 0;
<a name="l01107"></a>01107     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b0ae95fcf8a933e9665ab69a481603d5">bCompletePacket</a>   = <span class="keyword">true</span>;
<a name="l01108"></a>01108     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#6ad4c0c47c2f507cc8e5a011424af3cf">fCallback</a>         = fCallback;
<a name="l01109"></a>01109     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#81845347951e01a0a3cb70c07e2f6a34" title="Argument to pass to the callback function.">pArgument</a>         = pArgument;
<a name="l01110"></a>01110 
<a name="l01111"></a>01111     <span class="comment">// Send one packet</span>
<a name="l01112"></a>01112     <span class="comment">//</span>
<a name="l01113"></a>01113     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> = CEndpoint::StateWrite;
<a name="l01114"></a>01114     <a class="code" href="class_c_udp_driver.html#aa4e67dd65350793ee1db8fde2f5cb7b" title="Transfers a data payload from the current tranfer buffer to the endpoint FIFO.">WritePayload</a>( bEndpoint );
<a name="l01115"></a>01115     <a class="code" href="class_c_udp_driver.html#6aa2661dfca334908398ec3a324f65f4" title="Set flags in the UDP_CSR register and waits for synchronization.">SetEndpointFlags</a>( bEndpoint, AT91C_UDP_TXPKTRDY );
<a name="l01116"></a>01116 
<a name="l01117"></a>01117     <span class="comment">// If double buffering is enabled and there is data remaining,</span>
<a name="l01118"></a>01118     <span class="comment">// prepare another packet</span>
<a name="l01119"></a>01119     <span class="comment">//</span>
<a name="l01120"></a>01120     <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#c01021c63dda573b4df6fe57b6522045" title="Number of FIFO buffers defined for this endpoint.">dNumFIFO</a> &gt; 1 &amp;&amp; pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a> &gt; 0 )
<a name="l01121"></a>01121     {
<a name="l01122"></a>01122         <a class="code" href="class_c_udp_driver.html#aa4e67dd65350793ee1db8fde2f5cb7b" title="Transfers a data payload from the current tranfer buffer to the endpoint FIFO.">WritePayload</a>( bEndpoint );
<a name="l01123"></a>01123     }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     <span class="comment">// Enable interrupt on endpoint</span>
<a name="l01126"></a>01126     <span class="comment">//</span>
<a name="l01127"></a>01127     <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IER, 1 &lt;&lt; bEndpoint );
<a name="l01128"></a>01128 
<a name="l01129"></a>01129     <span class="keywordflow">return</span> <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB_STATUS_SUCCESS</a>;
<a name="l01130"></a>01130 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="26eb83a7a04131c8f7c529ee3fcad846"></a><!-- doxytag: member="CUdpDriver::Read" ref="26eb83a7a04131c8f7c529ee3fcad846" args="(int bEndpoint, void *pData, uint dLength, Callback_f fCallback, void *pArgument)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf">EnumStandardReturnValue</a> CUdpDriver::Read           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>pData</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&nbsp;</td>
          <td class="paramname"> <em>dLength</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="common_8h.html#a2b4c1da14449a039464b0a1703fb21b">Callback_f</a>&nbsp;</td>
          <td class="paramname"> <em>fCallback</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>pArgument</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Receives data on the specified <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> endpoint. 
<p>
Reads incoming data on an <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> endpoint.<p>
This functions receives data on a particular endpoint. It finishes either when the provided buffer is full, when a short packet (payload size inferior to the endpoint maximum packet size) is received, or if an abnormal condition causes a transfer abort. An optional user-provided callback can be invoked upon the transfer completion <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Number of the endpoint on which to receive the data </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pData</em>&nbsp;</td><td>Pointer to the buffer in which to store the received data </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dLength</em>&nbsp;</td><td>Size of the receive buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>fCallback</em>&nbsp;</td><td>Optional user-provided callback function invoked upon the transfer completion </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pArgument</em>&nbsp;</td><td>Optional parameter to pass to the callback function </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Result of operation </dd></dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd>EnumStandardReturnValue</dd></dl>
This methods sets the transfer descriptor and activate the endpoint interrupt. The actual transfer is then carried out by the endpoint interrupt handler. The Read operation finishes either when the buffer is full, or a short packet (inferior to endpoint maximum packet size) is received. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pData</em>&nbsp;</td><td>Pointer to a buffer to store the received data </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dLength</em>&nbsp;</td><td>Length of the receive buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>fCallback</em>&nbsp;</td><td>Optional callback function </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pArgument</em>&nbsp;</td><td>Optional callback argument </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Operation result code </dd></dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd><a class="el" href="common_8h.html#a2b4c1da14449a039464b0a1703fb21b">Callback_f</a> </dd></dl>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#01a59ea1ec36a6ba43ab64640425ad35">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01148">1148</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_u_d_p_8cpp-source.html#l00480">ClearRXFlag()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00667">USB::CEndpoint::dBytesBuffered</a>, <a class="el" href="usb_framework_8hpp-source.html#l00666">USB::CEndpoint::dBytesRemaining</a>, <a class="el" href="usb_framework_8hpp-source.html#l00669">USB::CEndpoint::dBytesTransferred</a>, <a class="el" href="usb_framework_8hpp-source.html#l00684">USB::CEndpoint::dState</a>, <a class="el" href="usb_framework_8hpp-source.html#l00723">USB::CEndpoint::EndOfTransfer()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00674">USB::CEndpoint::fCallback</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00231">GetPayload()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00676">USB::CEndpoint::pArgument</a>, <a class="el" href="usb_framework_8hpp-source.html#l00662">USB::CEndpoint::pData</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="trace_8h-source.html#l00049">TRACE_DEBUG_M</a>, <a class="el" href="usb_framework_8hpp-source.html#l00337">USB::USB_STATUS_IMMEDREAD</a>, <a class="el" href="usb_framework_8hpp-source.html#l00332">USB::USB_STATUS_LOCKED</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00331">USB::USB_STATUS_SUCCESS</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01153"></a>01153 {
<a name="l01154"></a>01154     <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l01155"></a>01155 
<a name="l01156"></a>01156     <span class="comment">// Return if the endpoint is not in IDLE state</span>
<a name="l01157"></a>01157     <span class="comment">//</span>
<a name="l01158"></a>01158     <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> != CEndpoint::StateIdle )
<a name="l01159"></a>01159     {
<a name="l01160"></a>01160         <span class="keywordflow">return</span> <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfa36c09a99061cf98307230aea69e4d4e">USB_STATUS_LOCKED</a>;
<a name="l01161"></a>01161     }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163     <a class="code" href="trace_8h.html#e5a536c839faf35fa9396e29abf2a0ab">TRACE_DEBUG_M</a>( <span class="stringliteral">"Read%d%5d "</span>, bEndpoint, dLength );
<a name="l01164"></a>01164 
<a name="l01165"></a>01165     <span class="comment">// Remember if there is some data left in FIFO buffer</span>
<a name="l01166"></a>01166     <span class="comment">//</span>
<a name="l01167"></a>01167     <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dBytesInBuffer = pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a>;
<a name="l01168"></a>01168     
<a name="l01169"></a>01169     <span class="comment">// Endpoint enters Read state</span>
<a name="l01170"></a>01170     <span class="comment">//</span>
<a name="l01171"></a>01171     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> = CEndpoint::StateRead;
<a name="l01172"></a>01172 
<a name="l01173"></a>01173     <span class="comment">// Set the transfer descriptor</span>
<a name="l01174"></a>01174     <span class="comment">//</span>
<a name="l01175"></a>01175     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#b894a1a3929491c380db77298452f93c">pData</a>             = (<a class="code" href="common_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a>*) pData;
<a name="l01176"></a>01176     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3d83c0c22f4f11c8a8adff529ed8a257" title="Number of remaining bytes to transfer.">dBytesRemaining</a>   = dLength;
<a name="l01177"></a>01177     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a>    = 0;
<a name="l01178"></a>01178     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#2710027db99b5ab7b0fcd12a18de2c89">dBytesTransferred</a> = 0;
<a name="l01179"></a>01179     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#6ad4c0c47c2f507cc8e5a011424af3cf">fCallback</a>         = fCallback;
<a name="l01180"></a>01180     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#81845347951e01a0a3cb70c07e2f6a34" title="Argument to pass to the callback function.">pArgument</a>         = pArgument;
<a name="l01181"></a>01181 
<a name="l01182"></a>01182     <span class="comment">// If there is data left earlier in FIFO buffer, get it and exit immediatelly.</span>
<a name="l01183"></a>01183     <span class="comment">//</span>
<a name="l01184"></a>01184     <span class="keywordflow">if</span> ( dBytesInBuffer &gt; 0 )
<a name="l01185"></a>01185     {
<a name="l01186"></a>01186         <a class="code" href="trace_8h.html#e5a536c839faf35fa9396e29abf2a0ab">TRACE_DEBUG_M</a>( <span class="stringliteral">"Immed "</span> );
<a name="l01187"></a>01187 
<a name="l01188"></a>01188         <a class="code" href="class_c_udp_driver.html#fe791e9ab368f8413d2323b95a409460" title="Transfers a data payload from an endpoint FIFO to the current transfer buffer.">GetPayload</a>( bEndpoint, dBytesInBuffer );
<a name="l01189"></a>01189 
<a name="l01190"></a>01190         <span class="comment">// Maybe there is still data left in FIFO? Check pEndpoint-&gt;dBytesBuffered</span>
<a name="l01191"></a>01191         <span class="comment">// and clear RX flag (i.e. swap FIFO banks) if there is no data left in FIFO.</span>
<a name="l01192"></a>01192         <span class="comment">//</span>
<a name="l01193"></a>01193         <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3033534d65e774515931970c7aec4b2a">dBytesBuffered</a> == 0 )
<a name="l01194"></a>01194         {
<a name="l01195"></a>01195             <a class="code" href="class_c_udp_driver.html#37b567c9205c8d3e2bdb3259123fcb05" title="Clears the correct RX flag in an endpoint status register.">ClearRXFlag</a>( bEndpoint );
<a name="l01196"></a>01196         }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198         <span class="comment">// Note that end-of-read callback will not be called in interrupt context!</span>
<a name="l01199"></a>01199         <span class="comment">// Callback will receive special bStatus to now that.</span>
<a name="l01200"></a>01200         <span class="comment">//</span>
<a name="l01201"></a>01201         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3bd504d483b3e015cee4d1ebbc02dc1f" title="Invokes the callback associated with a finished transfer on an endpoint.">EndOfTransfer</a>( <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf559ef442426e3d388d43f11e453ac54e">USB_STATUS_IMMEDREAD</a> );
<a name="l01202"></a>01202         <span class="keywordflow">return</span> <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB_STATUS_SUCCESS</a>;
<a name="l01203"></a>01203     }
<a name="l01204"></a>01204 
<a name="l01205"></a>01205     <span class="comment">// Enable interrupt on endpoint</span>
<a name="l01206"></a>01206     <span class="comment">//</span>
<a name="l01207"></a>01207     <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IER, 1 &lt;&lt; bEndpoint );
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     <span class="keywordflow">return</span> <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB_STATUS_SUCCESS</a>;
<a name="l01210"></a>01210 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="cf2898cdd641b3c522a0f2c40b72206f"></a><!-- doxytag: member="CUdpDriver::Stall" ref="cf2898cdd641b3c522a0f2c40b72206f" args="(int bEndpoint)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf">EnumStandardReturnValue</a> CUdpDriver::Stall           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Sends a STALL handshake for the next received packet. 
<p>
Causes the endpoint to acknowledge the next received packet with a STALL handshake. Further packets are then handled normally.<p>
This function only send one STALL handshake, and only if the next packet is not a SETUP packet (when using this function on a control endpoint). <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Number of endpoint on which to send the STALL </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Result of operation </dd></dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd>EnumStandardReturnValue <p>
CUsbDriver::Halt</dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Operation result code </dd></dl>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#7d6336a5dae2af83cacbc06b23e012c9">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01284">1284</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00684">USB::CEndpoint::dState</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00093">SetEndpointFlags()</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, <a class="el" href="trace_8h-source.html#l00067">TRACE_WARNING</a>, <a class="el" href="usb_framework_8hpp-source.html#l00332">USB::USB_STATUS_LOCKED</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00331">USB::USB_STATUS_SUCCESS</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01285"></a>01285 {
<a name="l01286"></a>01286     <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l01287"></a>01287 
<a name="l01288"></a>01288     <span class="comment">// Check that endpoint is in Idle state</span>
<a name="l01289"></a>01289     <span class="comment">//</span>
<a name="l01290"></a>01290     <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> != CEndpoint::StateIdle )
<a name="l01291"></a>01291     {
<a name="l01292"></a>01292         <a class="code" href="trace_8h.html#72b9761add7486364dba449091cd2579">TRACE_WARNING</a>( <span class="stringliteral">"W: CUdpDriver::Stall: Endpoint%d locked\n"</span>, bEndpoint );
<a name="l01293"></a>01293         <span class="keywordflow">return</span> <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfa36c09a99061cf98307230aea69e4d4e">USB_STATUS_LOCKED</a>;
<a name="l01294"></a>01294     }
<a name="l01295"></a>01295 
<a name="l01296"></a>01296     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Stall%d "</span>, bEndpoint );
<a name="l01297"></a>01297 
<a name="l01298"></a>01298     <a class="code" href="class_c_udp_driver.html#6aa2661dfca334908398ec3a324f65f4" title="Set flags in the UDP_CSR register and waits for synchronization.">SetEndpointFlags</a>( bEndpoint, AT91C_UDP_FORCESTALL );
<a name="l01299"></a>01299 
<a name="l01300"></a>01300     <span class="keywordflow">return</span> <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfaaaf695d69c89cb078bf5046502004a0" title="Last method has completed successfully.">USB_STATUS_SUCCESS</a>;
<a name="l01301"></a>01301 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="731233a0654277219ef0148319c0761e"></a><!-- doxytag: member="CUdpDriver::Halt" ref="731233a0654277219ef0148319c0761e" args="(int bEndpoint, int bRequest)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="common_8h.html#f6a258d8f3ee5206d682d799316314b1">bool</a> CUdpDriver::Halt           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bEndpoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bRequest</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Clears, sets or retrieves the halt state of the specified endpoint. 
<p>
Clears, sets or returns the Halt state on specified endpoint.<p>
While an endpoint is in Halt state, it acknowledges every received packet with a STALL handshake. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Number of the endpoint to alter </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>bRequest</em>&nbsp;</td><td>The operation to perform (set, clear or get) </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>true if the endpoint is halted, false otherwise</dd></dl>
When in Halt state, an endpoint acknowledges every received packet with a STALL handshake. This continues until the endpoint is manually put out of the Halt state by calling this function. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bEndpoint</em>&nbsp;</td><td>Index of endpoint </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>bRequest</em>&nbsp;</td><td>Request to perform -&gt; USB_SET_FEATURE, USB_CLEAR_FEATURE, USB_GET_STATUS </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>true if the endpoint is currently Halted, false otherwise </dd></dl>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#3109e130f7d149e66b9a75fb650736e2">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01222">1222</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="common_8h-source.html#l00057">CLEAR</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00066">ClearEndpointFlags()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00684">USB::CEndpoint::dState</a>, <a class="el" href="usb_framework_8hpp-source.html#l00723">USB::CEndpoint::EndOfTransfer()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00093">SetEndpointFlags()</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, <a class="el" href="usb_framework_8hpp-source.html#l00038">USB::USB_CLEAR_FEATURE</a>, <a class="el" href="usb_framework_8hpp-source.html#l00042">USB::USB_SET_FEATURE</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00334">USB::USB_STATUS_ABORTED</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01223"></a>01223 {
<a name="l01224"></a>01224     <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l01225"></a>01225 
<a name="l01226"></a>01226     <span class="comment">// Clear the Halt feature of the endpoint if it is enabled</span>
<a name="l01227"></a>01227     <span class="comment">//</span>
<a name="l01228"></a>01228     <span class="keywordflow">if</span> ( bRequest == <a class="code" href="group__usb__std.html#gga0a25c6e4fdae93c28d791ac803b0c99e0943d2bd672b0bfcd44a97199451dea">USB_CLEAR_FEATURE</a> 
<a name="l01229"></a>01229         &amp;&amp; pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> == CEndpoint::StateHalted
<a name="l01230"></a>01230         )
<a name="l01231"></a>01231     {
<a name="l01232"></a>01232         <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Unhalt %02X "</span>, bEndpoint );
<a name="l01233"></a>01233 
<a name="l01234"></a>01234         <span class="comment">// Return endpoint to Idle state</span>
<a name="l01235"></a>01235         <span class="comment">//</span>
<a name="l01236"></a>01236         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> = CEndpoint::StateIdle;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238         <span class="comment">// Clear FORCESTALL flag</span>
<a name="l01239"></a>01239         <span class="comment">//</span>
<a name="l01240"></a>01240         <a class="code" href="class_c_udp_driver.html#1c4166268dbce6fad2de3eeb89aaf82d" title="Clear flags in the UDP_CSR register and waits for synchronization.">ClearEndpointFlags</a>( bEndpoint, AT91C_UDP_FORCESTALL );
<a name="l01241"></a>01241 
<a name="l01242"></a>01242         <span class="comment">// Reset Endpoint FIFOs, beware this is a 2 steps operation</span>
<a name="l01243"></a>01243         <span class="comment">//</span>
<a name="l01244"></a>01244         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_RSTEP, 1 &lt;&lt; bEndpoint );
<a name="l01245"></a>01245         <a class="code" href="common_8h.html#e427fe9ee3c2843715dfbdb7d4c6cadc">CLEAR</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_RSTEP, 1 &lt;&lt; bEndpoint );
<a name="l01246"></a>01246     }
<a name="l01247"></a>01247     <span class="comment">//</span>
<a name="l01248"></a>01248     <span class="comment">// Set the Halt feature on the endpoint if it is not already enabled</span>
<a name="l01249"></a>01249     <span class="comment">// and the endpoint is not disabled</span>
<a name="l01250"></a>01250     <span class="comment">//</span>
<a name="l01251"></a>01251     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( bRequest == <a class="code" href="group__usb__std.html#gga0a25c6e4fdae93c28d791ac803b0c99bee9b307d3f99537eee60ea54a2f3530">USB_SET_FEATURE</a>
<a name="l01252"></a>01252              &amp;&amp; pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> != CEndpoint::StateHalted
<a name="l01253"></a>01253              &amp;&amp; pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> != CEndpoint::StateDisabled
<a name="l01254"></a>01254              )
<a name="l01255"></a>01255     {
<a name="l01256"></a>01256         <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Halt %02X "</span>, bEndpoint );
<a name="l01257"></a>01257 
<a name="l01258"></a>01258         <span class="comment">// Abort the current transfer if necessary</span>
<a name="l01259"></a>01259         <span class="comment">//</span>
<a name="l01260"></a>01260         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3bd504d483b3e015cee4d1ebbc02dc1f" title="Invokes the callback associated with a finished transfer on an endpoint.">EndOfTransfer</a>( <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdf7201cca4c6fe2ac04a449c4a3c9310dc" title="Method was aborted because of abnormal status.">USB_STATUS_ABORTED</a> );
<a name="l01261"></a>01261 
<a name="l01262"></a>01262         <span class="comment">// Put endpoint into Halt state</span>
<a name="l01263"></a>01263         <span class="comment">//</span>
<a name="l01264"></a>01264         <a class="code" href="class_c_udp_driver.html#6aa2661dfca334908398ec3a324f65f4" title="Set flags in the UDP_CSR register and waits for synchronization.">SetEndpointFlags</a>( bEndpoint, AT91C_UDP_FORCESTALL );
<a name="l01265"></a>01265         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> = CEndpoint::StateHalted;
<a name="l01266"></a>01266 
<a name="l01267"></a>01267         <span class="comment">// Enable the endpoint interrupt</span>
<a name="l01268"></a>01268         <span class="comment">//</span>
<a name="l01269"></a>01269         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IER, 1 &lt;&lt; bEndpoint );
<a name="l01270"></a>01270     }
<a name="l01271"></a>01271 
<a name="l01272"></a>01272     <span class="comment">// Return the endpoint halt status</span>
<a name="l01273"></a>01273     <span class="comment">//</span>
<a name="l01274"></a>01274     <span class="keywordflow">return</span> pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> == CEndpoint::StateHalted;
<a name="l01275"></a>01275 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="e433e33b63d698c98ebbe7f97c4b4b11"></a><!-- doxytag: member="CUdpDriver::RemoteWakeUp" ref="e433e33b63d698c98ebbe7f97c4b4b11" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::RemoteWakeUp           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Starts a remote wakeup procedure. 
<p>
Activates a remote wakeup procedure. 
<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#c059e12d22e2468fa00f5e3031560f5b">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01306">1306</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="common_8h-source.html#l00057">CLEAR</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00119">EnableMCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00155">EnableTransceiver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00137">EnableUDPCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, and <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01307"></a>01307 {
<a name="l01308"></a>01308     <a class="code" href="class_c_udp_driver.html#57f192544cb44433586de297a23747ca" title="Enables the peripheral clock of the USB controller associated with the specified...">EnableMCK</a> ();
<a name="l01309"></a>01309     <a class="code" href="class_c_udp_driver.html#473b05382c7ea862fdc3f195deed2f76" title="Enables the 48MHz clock of the USB controller associated with the specified USB driver...">EnableUDPCK</a> ();
<a name="l01310"></a>01310     <a class="code" href="class_c_udp_driver.html#7780c2dd587f40f5b4749b8de3e9cb16" title="Enables the transceiver of the USB controller associated with the specified USB driver...">EnableTransceiver</a> ();
<a name="l01311"></a>01311 
<a name="l01312"></a>01312     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Remote WakeUp "</span> );
<a name="l01313"></a>01313 
<a name="l01314"></a>01314     <span class="comment">// Activates a remote wakeup (edge on ESR)</span>
<a name="l01315"></a>01315     <span class="comment">//</span>
<a name="l01316"></a>01316     <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_GLBSTATE, AT91C_UDP_ESR );
<a name="l01317"></a>01317 
<a name="l01318"></a>01318     <span class="comment">// Then clear ESR</span>
<a name="l01319"></a>01319     <span class="comment">//</span>
<a name="l01320"></a>01320     <a class="code" href="common_8h.html#e427fe9ee3c2843715dfbdb7d4c6cadc">CLEAR</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_GLBSTATE, AT91C_UDP_ESR );
<a name="l01321"></a>01321 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f4d41ab77f6c6c68dbb0af8c548c726f"></a><!-- doxytag: member="CUdpDriver::ConfigureEndpoint" ref="f4d41ab77f6c6c68dbb0af8c548c726f" args="(const S_usb_endpoint_descriptor *pEpDesc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="common_8h.html#f6a258d8f3ee5206d682d799316314b1">bool</a> CUdpDriver::ConfigureEndpoint           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="struct_u_s_b_1_1_s__usb__endpoint__descriptor.html">S_usb_endpoint_descriptor</a> *&nbsp;</td>
          <td class="paramname"> <em>pEpDesc</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Configures the specified endpoint using the provided endpoint descriptor. 
<p>
Configure an endpoint with the provided endpoint descriptor.<p>
An endpoint must be configured prior to being used. This is not necessary for control endpoint 0, as this operation is automatically performed during initialization. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pEpDesc</em>&nbsp;</td><td>Pointer to an endpoint descriptor </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>true if the endpoint has been configured, false otherwise </dd></dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd>S_usb_endpoint_descriptor</dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pEpDesc</em>&nbsp;</td><td>Pointer to the endpoint descriptor </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>true if the endpoint is now configured, false otherwise </dd></dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd>S_usb_endpoint_descriptor </dd></dl>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#e1226551977f53cc3a9e8411c7264e13">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00785">785</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00457">USB::S_usb_endpoint_descriptor::bEndpointAddress</a>, <a class="el" href="usb_framework_8hpp-source.html#l00459">USB::S_usb_endpoint_descriptor::bmAttributes</a>, <a class="el" href="common_8h-source.html#l00057">CLEAR</a>, <a class="el" href="usb_framework_8hpp-source.html#l00769">USB::CUsbDriver::dNumEndpoints</a>, <a class="el" href="usb_framework_8hpp-source.html#l00684">USB::CEndpoint::dState</a>, <a class="el" href="usb_framework_8hpp-source.html#l00723">USB::CEndpoint::EndOfTransfer()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00160">USB::ENDPOINT_TYPE_CONTROL</a>, <a class="el" href="usb_framework_8hpp-source.html#l00768">USB::CUsbDriver::pEndpoints</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00024">UDP_EPDIR_INDEX</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00023">UDP_EPTYPE_INDEX</a>, <a class="el" href="usb_framework_8hpp-source.html#l00220">USB_ENDPOINT_DIRECTION</a>, <a class="el" href="usb_framework_8hpp-source.html#l00217">USB_ENDPOINT_NUMBER</a>, <a class="el" href="usb_framework_8hpp-source.html#l00167">USB_ENDPOINT_TYPE</a>, <a class="el" href="usb_framework_8hpp-source.html#l00335">USB::USB_STATUS_RESET</a>, <a class="el" href="usb_framework_8hpp-source.html#l00460">USB::S_usb_endpoint_descriptor::wMaxPacketSize</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00681">USB::CEndpoint::wMaxPacketSize</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00786"></a>00786 {
<a name="l00787"></a>00787     <span class="comment">// Default for NULL descriptor -&gt; Control endpoint 0</span>
<a name="l00788"></a>00788     <span class="comment">//</span>
<a name="l00789"></a>00789     <span class="keywordtype">int</span>  bEndpoint    = 0;
<a name="l00790"></a>00790     <span class="keywordtype">int</span>  bEpType      = <a class="code" href="namespace_u_s_b.html#a6a4f5955b7840458ecee0cff6cd129cdac9fe352383bb4e961f31055018bba9" title="Defines a CONTROL endpoint.">ENDPOINT_TYPE_CONTROL</a>;
<a name="l00791"></a>00791     <span class="keywordtype">bool</span> isINEndpoint = <span class="keyword">false</span>;
<a name="l00792"></a>00792 
<a name="l00793"></a>00793     <span class="keywordflow">if</span> ( pEpDesc )
<a name="l00794"></a>00794     {
<a name="l00795"></a>00795         bEndpoint    = <a class="code" href="group__usb__std.html#g9d242914619f48689be5fa49edb84677" title="Endpoint Descriptor - Macros.">USB_ENDPOINT_NUMBER</a>( pEpDesc-&gt;<a class="code" href="struct_u_s_b_1_1_s__usb__endpoint__descriptor.html#3fffe71a60da88e7cb77a5bf80a87f95">bEndpointAddress</a> );
<a name="l00796"></a>00796         bEpType      = <a class="code" href="usb_framework_8hpp.html#ca301ef9b53674d78fcb2fde7f0d792b" title="Get the endpoint type from bmAttributes field.">USB_ENDPOINT_TYPE</a>( pEpDesc-&gt;<a class="code" href="struct_u_s_b_1_1_s__usb__endpoint__descriptor.html#6811dcf5ed0097197c29d915a06f99fc" title="Endpoint attributes when configured.">bmAttributes</a> );
<a name="l00797"></a>00797         isINEndpoint = <a class="code" href="usb_framework_8hpp.html#8bc3457a657b95317beb03558cbb1a94" title="Returns an endpoint direction (IN or OUT).">USB_ENDPOINT_DIRECTION</a>( pEpDesc-&gt;<a class="code" href="struct_u_s_b_1_1_s__usb__endpoint__descriptor.html#3fffe71a60da88e7cb77a5bf80a87f95">bEndpointAddress</a> ) != 0;
<a name="l00798"></a>00798     }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     <span class="comment">// Get pointer on endpoint</span>
<a name="l00801"></a>00801     <span class="comment">//</span>
<a name="l00802"></a>00802     <span class="keywordflow">if</span> ( bEndpoint &gt;= <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#0742d93f329309a1961871cca9d23ae0" title="Number of endpoints in list.">dNumEndpoints</a> || bEndpoint &lt; 0 )
<a name="l00803"></a>00803     {
<a name="l00804"></a>00804         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00805"></a>00805     }
<a name="l00806"></a>00806     <a class="code" href="class_u_s_b_1_1_c_endpoint.html" title="This class is used to track the current status of an endpoint, i.e. the current transfer...">CEndpoint</a>* pEndpoint = &amp;<a class="code" href="class_u_s_b_1_1_c_usb_driver.html#095c0170800f07cb60bb86218553933c" title="Endpoints list.">pEndpoints</a>[ bEndpoint ];
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     <span class="comment">// Configure wMaxPacketSize</span>
<a name="l00809"></a>00809     <span class="comment">//</span>
<a name="l00810"></a>00810     <span class="keywordflow">if</span> ( pEpDesc != 0 )
<a name="l00811"></a>00811     {
<a name="l00812"></a>00812         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#37b26a371a87c2e20a0cba903b4ec1a4" title="Maximum packet size for this endpoint.">wMaxPacketSize</a> = pEpDesc-&gt;<a class="code" href="struct_u_s_b_1_1_s__usb__endpoint__descriptor.html#034846d331e10f391b851ebea0675c9d">wMaxPacketSize</a>;
<a name="l00813"></a>00813     }
<a name="l00814"></a>00814     <span class="keywordflow">else</span>
<a name="l00815"></a>00815     {
<a name="l00816"></a>00816         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#37b26a371a87c2e20a0cba903b4ec1a4" title="Maximum packet size for this endpoint.">wMaxPacketSize</a> = USB_ENDPOINT0_MAXPACKETSIZE;
<a name="l00817"></a>00817     }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="comment">// Abort the current transfer is the endpoint was configured and in</span>
<a name="l00820"></a>00820     <span class="comment">// Write or Read state</span>
<a name="l00821"></a>00821     <span class="comment">//</span>
<a name="l00822"></a>00822     <span class="keywordflow">if</span> ( pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> == CEndpoint::StateRead
<a name="l00823"></a>00823         || pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> == CEndpoint::StateWrite 
<a name="l00824"></a>00824         )
<a name="l00825"></a>00825     {
<a name="l00826"></a>00826         pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#3bd504d483b3e015cee4d1ebbc02dc1f" title="Invokes the callback associated with a finished transfer on an endpoint.">EndOfTransfer</a>( <a class="code" href="namespace_u_s_b.html#70e8bfc29952edb58ad9672bcb778bdfdd5309c830cdf5d2c3d1e507448d25aa">USB_STATUS_RESET</a> );
<a name="l00827"></a>00827     }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829     <span class="comment">// Enter IDLE state</span>
<a name="l00830"></a>00830     <span class="comment">//</span>
<a name="l00831"></a>00831     pEndpoint-&gt;<a class="code" href="class_u_s_b_1_1_c_endpoint.html#9e439ae7cae433a0676e1240dfc80aec" title="Endpoint internal state.">dState</a> = CEndpoint::StateIdle;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="comment">// Reset Endpoint FIFOs, beware this is a 2 steps operation</span>
<a name="l00834"></a>00834     <span class="comment">//</span>
<a name="l00835"></a>00835     <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_RSTEP, 1 &lt;&lt; bEndpoint );
<a name="l00836"></a>00836     <a class="code" href="common_8h.html#e427fe9ee3c2843715dfbdb7d4c6cadc">CLEAR</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_RSTEP, 1 &lt;&lt; bEndpoint );
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="comment">// Configure endpoint</span>
<a name="l00839"></a>00839     <span class="comment">// Do not use SetEndpointFlags() here!</span>
<a name="l00840"></a>00840     <span class="comment">//</span>
<a name="l00841"></a>00841     AT91_REG&amp; UDP_CSR = <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_CSR[ bEndpoint ];
<a name="l00842"></a>00842     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"CfgEpt%d(%08X-&gt;"</span>, bEndpoint, UDP_CSR );
<a name="l00843"></a>00843     
<a name="l00844"></a>00844     <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dNewCSR = AT91C_UDP_EPEDS;
<a name="l00845"></a>00845     <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( dNewCSR, bEpType &lt;&lt; <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7e7b0f1ed0d0742f3e9dfec61eeb9ab69b">UDP_EPTYPE_INDEX</a> );
<a name="l00846"></a>00846 
<a name="l00847"></a>00847     <span class="keywordflow">if</span> ( isINEndpoint )
<a name="l00848"></a>00848     {
<a name="l00849"></a>00849         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( dNewCSR, 1 &lt;&lt; <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7ee7df67f50474e5dbb9a7c3b1e3175849">UDP_EPDIR_INDEX</a> );
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     <span class="keywordflow">if</span> ( bEpType == <a class="code" href="namespace_u_s_b.html#a6a4f5955b7840458ecee0cff6cd129cdac9fe352383bb4e961f31055018bba9" title="Defines a CONTROL endpoint.">ENDPOINT_TYPE_CONTROL</a> )
<a name="l00853"></a>00853     {
<a name="l00854"></a>00854         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IER, 1 &lt;&lt; bEndpoint );
<a name="l00855"></a>00855     }
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <span class="keywordflow">while</span> ( UDP_CSR != dNewCSR )
<a name="l00858"></a>00858         UDP_CSR = dNewCSR;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"%08X) "</span>, UDP_CSR );
<a name="l00861"></a>00861     
<a name="l00862"></a>00862     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00863"></a>00863 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="39943265011f48c86d097afb2d1cf285"></a><!-- doxytag: member="CUdpDriver::Attach" ref="39943265011f48c86d097afb2d1cf285" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="common_8h.html#f6a258d8f3ee5206d682d799316314b1">bool</a> CUdpDriver::Attach           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Handles the attachment or detachment of the device to or from the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a>. 
<p>
Handles attachment or detachment from the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> when the VBus power line status changes.<p>
This method should be called whenever the VBus power line changes state, i.e. the device becomes powered/unpowered. Alternatively, it can also be called to poll the status of the device. When the device is detached from the bus, the OnSuspend callback is invoked. Conversely, when the device is attached, the OnResume callback is triggered. <dl class="return" compact><dt><b>Returns:</b></dt><dd>true if the device is currently attached, false otherwise </dd></dl>
<dl class="see" compact><dt><b>See also:</b></dt><dd>OnSuspend <p>
OnResume <p>
usb_api_callbacks</dd></dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>true if VBus is present, false otherwise </dd></dl>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#39a3359cccdcedde01052f3b7ecd9a16">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">1328</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00800">USB::CUsbDriver::ClearState()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01488">Connect()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00541">DisableEndpoints()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00128">DisableMCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00164">DisableTransceiver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00146">DisableUDPCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01507">Disconnect()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00119">EnableMCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00137">EnableUDPCK()</a>, <a class="el" href="usb_framework_8hpp-source.html#l01017">USB::CUsbDriver::IsStateSet()</a>, <a class="el" href="class_u_s_b_1_1_c_board.html#297c9c1af35a42a7af02db149f37f098">USB::CBoard::IsVBusConnected()</a>, <a class="el" href="class_u_s_b_1_1_c_event_sink.html#8fc43e92b17a2f78210d5589dc5fd5aa">USB::CEventSink::OnResume()</a>, <a class="el" href="class_u_s_b_1_1_c_event_sink.html#0a3d24d72b781f87e39d873cfda6dd9c">USB::CEventSink::OnSuspend()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00767">USB::CUsbDriver::pBoard</a>, <a class="el" href="usb_framework_8hpp-source.html#l00766">USB::CUsbDriver::pEventSink</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="usb_framework_8hpp-source.html#l00792">USB::CUsbDriver::SetState()</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00022">UDP_STATE_SHOULD_RECONNECT</a>, <a class="el" href="usb_framework_8hpp-source.html#l00351">USB::USB_STATE_ADDRESS</a>, <a class="el" href="usb_framework_8hpp-source.html#l00352">USB::USB_STATE_CONFIGURED</a>, <a class="el" href="usb_framework_8hpp-source.html#l00350">USB::USB_STATE_DEFAULT</a>, <a class="el" href="usb_framework_8hpp-source.html#l00349">USB::USB_STATE_POWERED</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00353">USB::USB_STATE_SUSPENDED</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01329"></a>01329 {
<a name="l01330"></a>01330     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Attach( "</span> );
<a name="l01331"></a>01331 
<a name="l01332"></a>01332     <span class="comment">// Check if VBus is present</span>
<a name="l01333"></a>01333     <span class="comment">//</span>
<a name="l01334"></a>01334     <span class="keywordflow">if</span> ( ! <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3a9bc888354edfd6d7e8f504d85c23d5" title="Powered state.">USB_STATE_POWERED</a> )
<a name="l01335"></a>01335         &amp;&amp; <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#64525692d796e77f889bf02d32487d18" title="Pointer to associated CBoard instance.">pBoard</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_board.html#297c9c1af35a42a7af02db149f37f098" title="Indicates the state of the VBus power line associated with the specified interface...">IsVBusConnected</a> () 
<a name="l01336"></a>01336         )
<a name="l01337"></a>01337     {
<a name="l01338"></a>01338         <span class="comment">// Powered state:</span>
<a name="l01339"></a>01339         <span class="comment">//      MCK + UDPCK must be on</span>
<a name="l01340"></a>01340         <span class="comment">//      Pull-Up must be connected</span>
<a name="l01341"></a>01341         <span class="comment">//      Transceiver must be disabled</span>
<a name="l01342"></a>01342 
<a name="l01343"></a>01343         <span class="comment">// Invoke the Resume callback</span>
<a name="l01344"></a>01344         <span class="comment">//</span>
<a name="l01345"></a>01345         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#fff7a79587118ff01493c7ad5aa922d1" title="Pointer to associated CEventSink instance.">pEventSink</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_event_sink.html#8fc43e92b17a2f78210d5589dc5fd5aa" title="Resume callback function.">OnResume</a> ();
<a name="l01346"></a>01346 
<a name="l01347"></a>01347         <a class="code" href="class_c_udp_driver.html#57f192544cb44433586de297a23747ca" title="Enables the peripheral clock of the USB controller associated with the specified...">EnableMCK</a> ();
<a name="l01348"></a>01348         <a class="code" href="class_c_udp_driver.html#473b05382c7ea862fdc3f195deed2f76" title="Enables the 48MHz clock of the USB controller associated with the specified USB driver...">EnableUDPCK</a> ();
<a name="l01349"></a>01349 
<a name="l01350"></a>01350         <span class="comment">// Reconnect the pull-up if needed</span>
<a name="l01351"></a>01351         <span class="comment">//</span>
<a name="l01352"></a>01352         <span class="keywordflow">if</span> ( <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7e57cce2ad51b07679e039e128b2aa2ba5">UDP_STATE_SHOULD_RECONNECT</a> ) )
<a name="l01353"></a>01353         {
<a name="l01354"></a>01354             <a class="code" href="class_c_udp_driver.html#9721403973d6af1963a444ab7c8ca162" title="Connects the device to the USB.">Connect</a> ();
<a name="l01355"></a>01355             <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#1aab07c6a713076a742c535c0dec3d38" title="Clear flag(s) in dStatus register. If the method is called without arguments, it...">ClearState</a>( <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7e57cce2ad51b07679e039e128b2aa2ba5">UDP_STATE_SHOULD_RECONNECT</a> );
<a name="l01356"></a>01356         }
<a name="l01357"></a>01357 
<a name="l01358"></a>01358         <span class="comment">// Clear the Suspend and Resume interrupts</span>
<a name="l01359"></a>01359         <span class="comment">//</span>
<a name="l01360"></a>01360         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_ICR,
<a name="l01361"></a>01361              AT91C_UDP_WAKEUP | AT91C_UDP_RXRSM | AT91C_UDP_RXSUSP );
<a name="l01362"></a>01362 
<a name="l01363"></a>01363         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IER, AT91C_UDP_RXSUSP );
<a name="l01364"></a>01364 
<a name="l01365"></a>01365         <span class="comment">// The device is in Powered state</span>
<a name="l01366"></a>01366         <span class="comment">//</span>
<a name="l01367"></a>01367         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#a64fb09dc12bfcd63241ed9f8cd282d9" title="Set flag(s) in dStatus register.">SetState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3a9bc888354edfd6d7e8f504d85c23d5" title="Powered state.">USB_STATE_POWERED</a> );
<a name="l01368"></a>01368 
<a name="l01369"></a>01369     }
<a name="l01370"></a>01370     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3a9bc888354edfd6d7e8f504d85c23d5" title="Powered state.">USB_STATE_POWERED</a> )
<a name="l01371"></a>01371          &amp;&amp; ! <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#64525692d796e77f889bf02d32487d18" title="Pointer to associated CBoard instance.">pBoard</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_board.html#297c9c1af35a42a7af02db149f37f098" title="Indicates the state of the VBus power line associated with the specified interface...">IsVBusConnected</a> ()
<a name="l01372"></a>01372          )
<a name="l01373"></a>01373     {
<a name="l01374"></a>01374         <span class="comment">// Attached state:</span>
<a name="l01375"></a>01375         <span class="comment">//      MCK + UDPCK off</span>
<a name="l01376"></a>01376         <span class="comment">//      Pull-Up must be disconnected</span>
<a name="l01377"></a>01377         <span class="comment">//      Transceiver must be disabled</span>
<a name="l01378"></a>01378 
<a name="l01379"></a>01379         <span class="comment">// Warning: MCK must be enabled to be able to write in UDP registers</span>
<a name="l01380"></a>01380         <span class="comment">// It may have been disabled by the Suspend interrupt, so re-enable it</span>
<a name="l01381"></a>01381         <span class="comment">//</span>
<a name="l01382"></a>01382         <a class="code" href="class_c_udp_driver.html#57f192544cb44433586de297a23747ca" title="Enables the peripheral clock of the USB controller associated with the specified...">EnableMCK</a> ();
<a name="l01383"></a>01383 
<a name="l01384"></a>01384         <span class="comment">// Disable interrupts</span>
<a name="l01385"></a>01385         <span class="comment">//</span>
<a name="l01386"></a>01386         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IDR, 
<a name="l01387"></a>01387             AT91C_UDP_WAKEUP | AT91C_UDP_RXRSM | AT91C_UDP_RXSUSP | AT91C_UDP_SOFINT );
<a name="l01388"></a>01388 
<a name="l01389"></a>01389         <a class="code" href="class_c_udp_driver.html#0054634921075da975122a537e1b6bca" title="Disable all endpoints (except control endpoint 0), aborting current transfers if...">DisableEndpoints</a> ();
<a name="l01390"></a>01390         <a class="code" href="class_c_udp_driver.html#5e1d3b5c810e5a6cc75b8b0e5038ec43" title="Disables the transceiver of the USB controller associated with the specified USB...">DisableTransceiver</a> ();
<a name="l01391"></a>01391 
<a name="l01392"></a>01392         <span class="comment">// Disconnect the pull-up if needed</span>
<a name="l01393"></a>01393         <span class="comment">//</span>
<a name="l01394"></a>01394         <span class="keywordflow">if</span> ( <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd686dab2643f401ba95c901e7343a4d01" title="Default state.">USB_STATE_DEFAULT</a> ) )
<a name="l01395"></a>01395         {
<a name="l01396"></a>01396             <a class="code" href="class_c_udp_driver.html#a42ff5ccc0e5a31aee80d2d837ccf67f" title="Disconnects the device from the USB.">Disconnect</a> ();
<a name="l01397"></a>01397             <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#a64fb09dc12bfcd63241ed9f8cd282d9" title="Set flag(s) in dStatus register.">SetState</a>( <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7e57cce2ad51b07679e039e128b2aa2ba5">UDP_STATE_SHOULD_RECONNECT</a> );
<a name="l01398"></a>01398         }
<a name="l01399"></a>01399 
<a name="l01400"></a>01400         <a class="code" href="class_c_udp_driver.html#649855193003a419cd39c5a66fa30503" title="Disables the peripheral clock of the USB controller associated with the specified...">DisableMCK</a> ();
<a name="l01401"></a>01401         <a class="code" href="class_c_udp_driver.html#7bff10dc4515c32a205d274728ed7681" title="Disables the 48MHz clock of the USB controller associated with the specified USB...">DisableUDPCK</a> ();
<a name="l01402"></a>01402 
<a name="l01403"></a>01403         <span class="comment">// The device leaves the all states except Attached</span>
<a name="l01404"></a>01404         <span class="comment">//</span>
<a name="l01405"></a>01405         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#1aab07c6a713076a742c535c0dec3d38" title="Clear flag(s) in dStatus register. If the method is called without arguments, it...">ClearState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3a9bc888354edfd6d7e8f504d85c23d5" title="Powered state.">USB_STATE_POWERED</a> | <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd686dab2643f401ba95c901e7343a4d01" title="Default state.">USB_STATE_DEFAULT</a>
<a name="l01406"></a>01406               | <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3b5cd328969f6ceffd29d5ee70b0c03e" title="Address state.">USB_STATE_ADDRESS</a> | <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd989613f0858adc2fb4eeee083efa06b8" title="Configured state.">USB_STATE_CONFIGURED</a> | <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd60c8608e8150741f47d495e6c95416b6" title="Suspended state.">USB_STATE_SUSPENDED</a> );
<a name="l01407"></a>01407 
<a name="l01408"></a>01408         <span class="comment">// Invoke the Suspend callback</span>
<a name="l01409"></a>01409         <span class="comment">//</span>
<a name="l01410"></a>01410         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#fff7a79587118ff01493c7ad5aa922d1" title="Pointer to associated CEventSink instance.">pEventSink</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_event_sink.html#0a3d24d72b781f87e39d873cfda6dd9c" title="Suspend callback function.">OnSuspend</a> ();
<a name="l01411"></a>01411     }
<a name="l01412"></a>01412 
<a name="l01413"></a>01413     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"%d) "</span>, <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3a9bc888354edfd6d7e8f504d85c23d5" title="Powered state.">USB_STATE_POWERED</a> ) );
<a name="l01414"></a>01414 
<a name="l01415"></a>01415     <span class="keywordflow">return</span> <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3a9bc888354edfd6d7e8f504d85c23d5" title="Powered state.">USB_STATE_POWERED</a> );
<a name="l01416"></a>01416 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="292d51e33ec7a054206e69b3b9395ef4"></a><!-- doxytag: member="CUdpDriver::SetAddress" ref="292d51e33ec7a054206e69b3b9395ef4" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::SetAddress           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Sets the device address using the last received SETUP packet. This method must only be called after a SET_ADDRESS standard request has been received. This is because it uses the last received SETUP packet stored in the sSetup structure to determine which address the device should use. 
<p>
Sets or unsets the device address.<p>
<dl class="see" compact><dt><b>See also:</b></dt><dd>EnumStandardDeviceRequests</dd></dl>
This function directly accesses the S_usb_request instance located in the sSetup structure to extract its new address. 
<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#4ac664ad2530ff764689a0f8eb7210d2">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01423">1423</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00800">USB::CUsbDriver::ClearState()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="usb_framework_8hpp-source.html#l00792">USB::CUsbDriver::SetState()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00770">USB::CUsbDriver::sSetup</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, <a class="el" href="usb_framework_8hpp-source.html#l00351">USB::USB_STATE_ADDRESS</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00376">USB::S_usb_request::wValue</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01424"></a>01424 {
<a name="l01425"></a>01425     <a class="code" href="common_8h.html#b95f123a6c9bcfee6a343170ef8c5f69">ushort</a> wAddress = <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#e291dea0fc434bbc3a6ce8e72c630e5e" title="Pointer to the last received SETUP packet.">sSetup</a>.<a class="code" href="struct_u_s_b_1_1_s__usb__request.html#7054b00f8fb4f5e1f2fe33c24d04bc1c" title="Request-specific parameter.">wValue</a>;
<a name="l01426"></a>01426 
<a name="l01427"></a>01427     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"SetAddr(%d) "</span>, wAddress);
<a name="l01428"></a>01428 
<a name="l01429"></a>01429     <span class="comment">// Set address</span>
<a name="l01430"></a>01430     <span class="comment">//</span>
<a name="l01431"></a>01431     <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_FADDR, AT91C_UDP_FEN | wAddress );
<a name="l01432"></a>01432 
<a name="l01433"></a>01433     <span class="keywordflow">if</span> ( wAddress == 0 )
<a name="l01434"></a>01434     {
<a name="l01435"></a>01435         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_GLBSTATE, 0 );
<a name="l01436"></a>01436 
<a name="l01437"></a>01437         <span class="comment">// Device enters the Default state</span>
<a name="l01438"></a>01438         <span class="comment">//</span>
<a name="l01439"></a>01439         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#1aab07c6a713076a742c535c0dec3d38" title="Clear flag(s) in dStatus register. If the method is called without arguments, it...">ClearState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3b5cd328969f6ceffd29d5ee70b0c03e" title="Address state.">USB_STATE_ADDRESS</a> );
<a name="l01440"></a>01440     }
<a name="l01441"></a>01441     <span class="keywordflow">else</span>
<a name="l01442"></a>01442     {
<a name="l01443"></a>01443         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>(<a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_GLBSTATE, AT91C_UDP_FADDEN );
<a name="l01444"></a>01444 
<a name="l01445"></a>01445         <span class="comment">// The device enters the Address state</span>
<a name="l01446"></a>01446         <span class="comment">//</span>
<a name="l01447"></a>01447         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#a64fb09dc12bfcd63241ed9f8cd282d9" title="Set flag(s) in dStatus register.">SetState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3b5cd328969f6ceffd29d5ee70b0c03e" title="Address state.">USB_STATE_ADDRESS</a> );
<a name="l01448"></a>01448     }
<a name="l01449"></a>01449 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="53ff5988e2dc0f5e780d056e55e28283"></a><!-- doxytag: member="CUdpDriver::SetConfiguration" ref="53ff5988e2dc0f5e780d056e55e28283" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::SetConfiguration           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Sets the device configuration using the last received SETUP packet. 
<p>
Changes the device state from Address to Configured, or from Configured to Address.<p>
This method must only be called after a SET_CONFIGURATION standard request has been received. This is necessary because it uses the last received SETUP packet (stored in the sSetup structure) to determine which configuration it should adopt. <dl class="see" compact><dt><b>See also:</b></dt><dd>EnumStandardDeviceRequests</dd></dl>
This method directly access the last received SETUP packet to decide on what to do. 
<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#5ae347a153c69dc160eba2e1e8d4a0a8">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01457">1457</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="usb_framework_8hpp-source.html#l00800">USB::CUsbDriver::ClearState()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00541">DisableEndpoints()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="usb_framework_8hpp-source.html#l00792">USB::CUsbDriver::SetState()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00770">USB::CUsbDriver::sSetup</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, <a class="el" href="usb_framework_8hpp-source.html#l00352">USB::USB_STATE_CONFIGURED</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00376">USB::S_usb_request::wValue</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01458"></a>01458 {
<a name="l01459"></a>01459     <a class="code" href="common_8h.html#b95f123a6c9bcfee6a343170ef8c5f69">ushort</a> wValue = <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#e291dea0fc434bbc3a6ce8e72c630e5e" title="Pointer to the last received SETUP packet.">sSetup</a>.<a class="code" href="struct_u_s_b_1_1_s__usb__request.html#7054b00f8fb4f5e1f2fe33c24d04bc1c" title="Request-specific parameter.">wValue</a>;
<a name="l01460"></a>01460 
<a name="l01461"></a>01461     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"SetCfg() "</span> );
<a name="l01462"></a>01462 
<a name="l01463"></a>01463     <span class="comment">// Check the request</span>
<a name="l01464"></a>01464     <span class="comment">//</span>
<a name="l01465"></a>01465     <span class="keywordflow">if</span> ( wValue != 0 ) 
<a name="l01466"></a>01466     {
<a name="l01467"></a>01467         <span class="comment">// Enter Configured state</span>
<a name="l01468"></a>01468         <span class="comment">//</span>
<a name="l01469"></a>01469         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#a64fb09dc12bfcd63241ed9f8cd282d9" title="Set flag(s) in dStatus register.">SetState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd989613f0858adc2fb4eeee083efa06b8" title="Configured state.">USB_STATE_CONFIGURED</a> );
<a name="l01470"></a>01470         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_GLBSTATE, AT91C_UDP_CONFG );
<a name="l01471"></a>01471     }
<a name="l01472"></a>01472     <span class="keywordflow">else</span> 
<a name="l01473"></a>01473     {
<a name="l01474"></a>01474         <span class="comment">// Go back to Address state</span>
<a name="l01475"></a>01475         <span class="comment">//</span>
<a name="l01476"></a>01476         <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#1aab07c6a713076a742c535c0dec3d38" title="Clear flag(s) in dStatus register. If the method is called without arguments, it...">ClearState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd989613f0858adc2fb4eeee083efa06b8" title="Configured state.">USB_STATE_CONFIGURED</a> );
<a name="l01477"></a>01477         <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_GLBSTATE, AT91C_UDP_FADDEN );
<a name="l01478"></a>01478 
<a name="l01479"></a>01479         <span class="comment">// Abort all transfers</span>
<a name="l01480"></a>01480         <span class="comment">//</span>
<a name="l01481"></a>01481         <a class="code" href="class_c_udp_driver.html#0054634921075da975122a537e1b6bca" title="Disable all endpoints (except control endpoint 0), aborting current transfers if...">DisableEndpoints</a> ();
<a name="l01482"></a>01482     }
<a name="l01483"></a>01483 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="df47754ef8128230c4cefa247265a305"></a><!-- doxytag: member="CUdpDriver::EventHandler" ref="df47754ef8128230c4cefa247265a305" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::EventHandler           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Event handler for the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral. 
<p>
UDP interrupt handler.<p>
This function handles low-level events comming from the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral. It then dispatches those events through the user-provided callbacks. The following callbacks can be triggered:<ol type=1>
<li>OnReset</li><li>OnSuspend</li><li>OnResume</li><li>OnNewRequest <dl class="see" compact><dt><b>See also:</b></dt><dd>usb_api_callbacks</dd></dl>
Manages device resume, suspend, end of bus reset. Forwards endpoint interrupts to the appropriate handler. </li></ol>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#bf134a2c91076fdae5d9d3ba640965b4">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">870</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="common_8h-source.html#l00057">CLEAR</a>, <a class="el" href="usb_framework_8hpp-source.html#l00800">USB::CUsbDriver::ClearState()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00785">ConfigureEndpoint()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00541">DisableEndpoints()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00128">DisableMCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00164">DisableTransceiver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00146">DisableUDPCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00119">EnableMCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00155">EnableTransceiver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00137">EnableUDPCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00559">EndpointHandler()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00026">ISR_MASK</a>, <a class="el" href="common_8h-source.html#l00060">ISSET</a>, <a class="el" href="usb_framework_8hpp-source.html#l01017">USB::CUsbDriver::IsStateSet()</a>, <a class="el" href="common_8h-source.html#l00113">lastSetBit()</a>, <a class="el" href="board_8h-source.html#l00036">LED_PIO</a>, <a class="el" href="board_8h-source.html#l00035">LED_USB</a>, <a class="el" href="class_u_s_b_1_1_c_event_sink.html#23985c2758a4fd2b82000c035102aee5">USB::CEventSink::OnReset()</a>, <a class="el" href="class_u_s_b_1_1_c_event_sink.html#8fc43e92b17a2f78210d5589dc5fd5aa">USB::CEventSink::OnResume()</a>, <a class="el" href="class_u_s_b_1_1_c_event_sink.html#2f8f76e4c945640741d41b98743a7a00">USB::CEventSink::OnStartOfFrame()</a>, <a class="el" href="class_u_s_b_1_1_c_event_sink.html#0a3d24d72b781f87e39d873cfda6dd9c">USB::CEventSink::OnSuspend()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00766">USB::CUsbDriver::pEventSink</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00511">ResetEndpoints()</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, <a class="el" href="usb_framework_8hpp-source.html#l00792">USB::CUsbDriver::SetState()</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, <a class="el" href="usb_framework_8hpp-source.html#l00351">USB::USB_STATE_ADDRESS</a>, <a class="el" href="usb_framework_8hpp-source.html#l00352">USB::USB_STATE_CONFIGURED</a>, <a class="el" href="usb_framework_8hpp-source.html#l00350">USB::USB_STATE_DEFAULT</a>, <a class="el" href="usb_framework_8hpp-source.html#l00349">USB::USB_STATE_POWERED</a>, <a class="el" href="usb_framework_8hpp-source.html#l00353">USB::USB_STATE_SUSPENDED</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00772">USB::CUsbDriver::useSOFCallback</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00871"></a>00871 {
<a name="l00872"></a>00872 <span class="preprocessor">#ifdef LED_USB</span>
<a name="l00873"></a>00873 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd60c8608e8150741f47d495e6c95416b6" title="Suspended state.">USB_STATE_SUSPENDED</a> ) &amp;&amp; <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3a9bc888354edfd6d7e8f504d85c23d5" title="Powered state.">USB_STATE_POWERED</a> ) )
<a name="l00874"></a>00874     {
<a name="l00875"></a>00875         AT91F_PIO_ClearOutput( <a class="code" href="board_8h.html#1582be10c5c2c9cd8e68c5cc0854605c">LED_PIO</a>, <a class="code" href="board_8h.html#3b8254f78b4b200381597a437d0bcfcc">LED_USB</a> ); <span class="comment">// LED on</span>
<a name="l00876"></a>00876     }
<a name="l00877"></a>00877 <span class="preprocessor">#endif</span>
<a name="l00878"></a>00878 <span class="preprocessor"></span>
<a name="l00879"></a>00879     <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Hlr "</span> );
<a name="l00880"></a>00880 
<a name="l00881"></a>00881     <span class="comment">// Get interrupts status</span>
<a name="l00882"></a>00882     <span class="comment">//</span>
<a name="l00883"></a>00883     <a class="code" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> dISR = <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_ISR &amp; <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IMR &amp; <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7ee4f8d15de5dc5195c6f80bf890a0d212">ISR_MASK</a>;
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="comment">// Handle all UDP interrupts</span>
<a name="l00886"></a>00886     <span class="comment">//</span>
<a name="l00887"></a>00887     <span class="keywordflow">while</span>( dISR != 0 )
<a name="l00888"></a>00888     {
<a name="l00889"></a>00889         <span class="comment">//----------------------</span>
<a name="l00890"></a>00890         <span class="comment">// Start Of Frame (SOF)?</span>
<a name="l00891"></a>00891         <span class="comment">//----------------------</span>
<a name="l00892"></a>00892         <span class="keywordflow">if</span>( <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dISR, AT91C_UDP_SOFINT ) )
<a name="l00893"></a>00893         {
<a name="l00894"></a>00894             <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"SOF "</span> );
<a name="l00895"></a>00895 
<a name="l00896"></a>00896             <span class="comment">// Invoke the SOF callback</span>
<a name="l00897"></a>00897             <span class="comment">//</span>
<a name="l00898"></a>00898             <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#fff7a79587118ff01493c7ad5aa922d1" title="Pointer to associated CEventSink instance.">pEventSink</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_event_sink.html#2f8f76e4c945640741d41b98743a7a00" title="Interrupt SOF callback function Invoked when a SOF interrupt is received.">OnStartOfFrame</a> ();
<a name="l00899"></a>00899 
<a name="l00900"></a>00900             <span class="comment">// Acknowledge interrupt</span>
<a name="l00901"></a>00901             <span class="comment">//</span>
<a name="l00902"></a>00902             <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_ICR, AT91C_UDP_SOFINT );
<a name="l00903"></a>00903             <a class="code" href="common_8h.html#e427fe9ee3c2843715dfbdb7d4c6cadc">CLEAR</a>( dISR, AT91C_UDP_SOFINT );
<a name="l00904"></a>00904         }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906         <span class="comment">//----------</span>
<a name="l00907"></a>00907         <span class="comment">// Suspend?</span>
<a name="l00908"></a>00908         <span class="comment">//----------</span>
<a name="l00909"></a>00909         <span class="keywordflow">if</span>( dISR == AT91C_UDP_RXSUSP )
<a name="l00910"></a>00910         {
<a name="l00911"></a>00911             <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Susp "</span> );
<a name="l00912"></a>00912 
<a name="l00913"></a>00913             <span class="keywordflow">if</span> ( ! <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd60c8608e8150741f47d495e6c95416b6" title="Suspended state.">USB_STATE_SUSPENDED</a> ) )
<a name="l00914"></a>00914             {
<a name="l00915"></a>00915                 <span class="comment">// The device enters the Suspended state</span>
<a name="l00916"></a>00916                 <span class="comment">//      MCK + UDPCK must be off</span>
<a name="l00917"></a>00917                 <span class="comment">//      Pull-Up must be connected</span>
<a name="l00918"></a>00918                 <span class="comment">//      Transceiver must be disabled</span>
<a name="l00919"></a>00919 
<a name="l00920"></a>00920                 <span class="comment">// Enable wakeup</span>
<a name="l00921"></a>00921                 <span class="comment">//</span>
<a name="l00922"></a>00922                 <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IER, AT91C_UDP_WAKEUP | AT91C_UDP_RXRSM );
<a name="l00923"></a>00923 
<a name="l00924"></a>00924                 <span class="comment">// Acknowledge interrupt</span>
<a name="l00925"></a>00925                 <span class="comment">//</span>
<a name="l00926"></a>00926                 <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_ICR, AT91C_UDP_RXSUSP );
<a name="l00927"></a>00927 
<a name="l00928"></a>00928                 <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#a64fb09dc12bfcd63241ed9f8cd282d9" title="Set flag(s) in dStatus register.">SetState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd60c8608e8150741f47d495e6c95416b6" title="Suspended state.">USB_STATE_SUSPENDED</a> );
<a name="l00929"></a>00929                 <a class="code" href="class_c_udp_driver.html#5e1d3b5c810e5a6cc75b8b0e5038ec43" title="Disables the transceiver of the USB controller associated with the specified USB...">DisableTransceiver</a> ();
<a name="l00930"></a>00930                 <a class="code" href="class_c_udp_driver.html#649855193003a419cd39c5a66fa30503" title="Disables the peripheral clock of the USB controller associated with the specified...">DisableMCK</a> ();
<a name="l00931"></a>00931                 <a class="code" href="class_c_udp_driver.html#7bff10dc4515c32a205d274728ed7681" title="Disables the 48MHz clock of the USB controller associated with the specified USB...">DisableUDPCK</a> ();
<a name="l00932"></a>00932 
<a name="l00933"></a>00933                 <span class="comment">// Invoke the Suspend callback</span>
<a name="l00934"></a>00934                 <span class="comment">//</span>
<a name="l00935"></a>00935                 <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#fff7a79587118ff01493c7ad5aa922d1" title="Pointer to associated CEventSink instance.">pEventSink</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_event_sink.html#0a3d24d72b781f87e39d873cfda6dd9c" title="Suspend callback function.">OnSuspend</a> ();
<a name="l00936"></a>00936             }
<a name="l00937"></a>00937         }
<a name="l00938"></a>00938         <span class="comment">//---------</span>
<a name="l00939"></a>00939         <span class="comment">// Resume?</span>
<a name="l00940"></a>00940         <span class="comment">//---------</span>
<a name="l00941"></a>00941         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dISR, AT91C_UDP_WAKEUP )
<a name="l00942"></a>00942                || <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dISR, AT91C_UDP_RXRSM )
<a name="l00943"></a>00943                )
<a name="l00944"></a>00944         {
<a name="l00945"></a>00945             <span class="comment">// Invoke the Resume callback</span>
<a name="l00946"></a>00946             <span class="comment">//</span>
<a name="l00947"></a>00947             <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#fff7a79587118ff01493c7ad5aa922d1" title="Pointer to associated CEventSink instance.">pEventSink</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_event_sink.html#8fc43e92b17a2f78210d5589dc5fd5aa" title="Resume callback function.">OnResume</a> ();
<a name="l00948"></a>00948 
<a name="l00949"></a>00949             <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"Res "</span> );
<a name="l00950"></a>00950 
<a name="l00951"></a>00951             <span class="comment">// The device enters Configured state</span>
<a name="l00952"></a>00952             <span class="comment">//      MCK + UDPCK must be on</span>
<a name="l00953"></a>00953             <span class="comment">//      Pull-Up must be connected</span>
<a name="l00954"></a>00954             <span class="comment">//      Transceiver must be enabled</span>
<a name="l00955"></a>00955 
<a name="l00956"></a>00956             <span class="keywordflow">if</span> ( <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd60c8608e8150741f47d495e6c95416b6" title="Suspended state.">USB_STATE_SUSPENDED</a> ) )
<a name="l00957"></a>00957             {
<a name="l00958"></a>00958                 <span class="comment">// Powered state</span>
<a name="l00959"></a>00959                 <a class="code" href="class_c_udp_driver.html#57f192544cb44433586de297a23747ca" title="Enables the peripheral clock of the USB controller associated with the specified...">EnableMCK</a> ();
<a name="l00960"></a>00960                 <a class="code" href="class_c_udp_driver.html#473b05382c7ea862fdc3f195deed2f76" title="Enables the 48MHz clock of the USB controller associated with the specified USB driver...">EnableUDPCK</a> ();
<a name="l00961"></a>00961 
<a name="l00962"></a>00962                 <span class="comment">// Default state</span>
<a name="l00963"></a>00963                 <span class="keywordflow">if</span> ( <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd686dab2643f401ba95c901e7343a4d01" title="Default state.">USB_STATE_DEFAULT</a> ) )
<a name="l00964"></a>00964                 {
<a name="l00965"></a>00965                     <a class="code" href="class_c_udp_driver.html#7780c2dd587f40f5b4749b8de3e9cb16" title="Enables the transceiver of the USB controller associated with the specified USB driver...">EnableTransceiver</a> ();
<a name="l00966"></a>00966                 }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968                 <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#1aab07c6a713076a742c535c0dec3d38" title="Clear flag(s) in dStatus register. If the method is called without arguments, it...">ClearState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd60c8608e8150741f47d495e6c95416b6" title="Suspended state.">USB_STATE_SUSPENDED</a> );
<a name="l00969"></a>00969             }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971             <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_ICR,
<a name="l00972"></a>00972                 AT91C_UDP_WAKEUP | AT91C_UDP_RXRSM | AT91C_UDP_RXSUSP );
<a name="l00973"></a>00973 
<a name="l00974"></a>00974             <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IDR, AT91C_UDP_WAKEUP | AT91C_UDP_RXRSM );
<a name="l00975"></a>00975         }
<a name="l00976"></a>00976         <span class="comment">//-------------------</span>
<a name="l00977"></a>00977         <span class="comment">// End of bus reset?</span>
<a name="l00978"></a>00978         <span class="comment">//-------------------</span>
<a name="l00979"></a>00979         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="common_8h.html#0c7779daa8274056a6abd444c2089ade">ISSET</a>( dISR, AT91C_UDP_ENDBUSRES ) )
<a name="l00980"></a>00980         {
<a name="l00981"></a>00981             <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"EoBRes "</span> );
<a name="l00982"></a>00982 
<a name="l00983"></a>00983             <span class="comment">// The device enters the Default state:</span>
<a name="l00984"></a>00984             <span class="comment">//</span>
<a name="l00985"></a>00985             <span class="comment">//   -  MCK + UDPCK are already enabled</span>
<a name="l00986"></a>00986             <span class="comment">//   -  Pull-Up is already connected</span>
<a name="l00987"></a>00987             <span class="comment">//   -  Transceiver must be enabled</span>
<a name="l00988"></a>00988             <span class="comment">//   -  Endpoint 0 must be enabled</span>
<a name="l00989"></a>00989             <span class="comment">//</span>
<a name="l00990"></a>00990             <span class="comment">// Note: Each time an ENDBUSRES interrupt is triggered, </span>
<a name="l00991"></a>00991             <span class="comment">// the Interrupt Mask Register and UDP_CSR registers have been reset.</span>
<a name="l00992"></a>00992             <span class="comment">//</span>
<a name="l00993"></a>00993             <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#a64fb09dc12bfcd63241ed9f8cd282d9" title="Set flag(s) in dStatus register.">SetState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd686dab2643f401ba95c901e7343a4d01" title="Default state.">USB_STATE_DEFAULT</a> );
<a name="l00994"></a>00994             <a class="code" href="class_c_udp_driver.html#7780c2dd587f40f5b4749b8de3e9cb16" title="Enables the transceiver of the USB controller associated with the specified USB driver...">EnableTransceiver</a> ();
<a name="l00995"></a>00995 
<a name="l00996"></a>00996             <span class="comment">// The device leaves the Address and Configured states</span>
<a name="l00997"></a>00997             <span class="comment">//</span>
<a name="l00998"></a>00998             <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#1aab07c6a713076a742c535c0dec3d38" title="Clear flag(s) in dStatus register. If the method is called without arguments, it...">ClearState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3b5cd328969f6ceffd29d5ee70b0c03e" title="Address state.">USB_STATE_ADDRESS</a> | <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd989613f0858adc2fb4eeee083efa06b8" title="Configured state.">USB_STATE_CONFIGURED</a> );
<a name="l00999"></a>00999             <a class="code" href="class_c_udp_driver.html#2f1608a989f65367307faabb5e44f892" title="This function reset all endpoint transfer descriptors.">ResetEndpoints</a> ();
<a name="l01000"></a>01000             <a class="code" href="class_c_udp_driver.html#0054634921075da975122a537e1b6bca" title="Disable all endpoints (except control endpoint 0), aborting current transfers if...">DisableEndpoints</a> ();
<a name="l01001"></a>01001             <a class="code" href="class_c_udp_driver.html#f4d41ab77f6c6c68dbb0af8c548c726f" title="Configures the specified endpoint using the provided endpoint descriptor.">ConfigureEndpoint</a>( 0 );
<a name="l01002"></a>01002 
<a name="l01003"></a>01003             <span class="comment">// Flush and enable the Suspend interrupt</span>
<a name="l01004"></a>01004             <span class="comment">//</span>
<a name="l01005"></a>01005             <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_ICR,
<a name="l01006"></a>01006                 AT91C_UDP_WAKEUP | AT91C_UDP_RXRSM | AT91C_UDP_RXSUSP );
<a name="l01007"></a>01007 
<a name="l01008"></a>01008             <span class="comment">// Enable the Start Of Frame (SOF) interrupt if needed</span>
<a name="l01009"></a>01009             <span class="comment">//</span>
<a name="l01010"></a>01010             <span class="keywordflow">if</span> ( <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#6a49f7a52fb84e6a7054c66c6d4a9f21" title="Indicates wether to forward StartOfFrame events.">useSOFCallback</a> ) 
<a name="l01011"></a>01011             {
<a name="l01012"></a>01012                 <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IER, AT91C_UDP_SOFINT );
<a name="l01013"></a>01013             }
<a name="l01014"></a>01014 
<a name="l01015"></a>01015             <span class="comment">// Invoke the Reset callback</span>
<a name="l01016"></a>01016             <span class="comment">//</span>
<a name="l01017"></a>01017             <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#fff7a79587118ff01493c7ad5aa922d1" title="Pointer to associated CEventSink instance.">pEventSink</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_event_sink.html#23985c2758a4fd2b82000c035102aee5" title="Reset callback function.">OnReset</a> ();
<a name="l01018"></a>01018 
<a name="l01019"></a>01019             <span class="comment">// Acknowledge end of bus reset interrupt</span>
<a name="l01020"></a>01020             <span class="comment">//</span>
<a name="l01021"></a>01021             <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_ICR, AT91C_UDP_ENDBUSRES );
<a name="l01022"></a>01022         }
<a name="l01023"></a>01023         <span class="comment">//---------------------</span>
<a name="l01024"></a>01024         <span class="comment">// Endpoint interrupts</span>
<a name="l01025"></a>01025         <span class="comment">//---------------------</span>
<a name="l01026"></a>01026         <span class="keywordflow">else</span>
<a name="l01027"></a>01027         {
<a name="l01028"></a>01028             <span class="keywordflow">while</span> ( dISR != 0 )
<a name="l01029"></a>01029             {
<a name="l01030"></a>01030                 <span class="comment">// Get endpoint index</span>
<a name="l01031"></a>01031                 <span class="comment">//</span>
<a name="l01032"></a>01032                 <span class="keywordtype">int</span> bEndpoint = <a class="code" href="common_8h.html#73d1e216f1d6afab09f5afa70cce823f">lastSetBit</a>( dISR );
<a name="l01033"></a>01033                 <a class="code" href="class_c_udp_driver.html#2654684e8906700c508d3f10d133404a" title="Endpoint interrupt handler. Handle IN/OUT transfers, received SETUP packets and STALLing...">EndpointHandler</a>( bEndpoint );
<a name="l01034"></a>01034 
<a name="l01035"></a>01035                 <a class="code" href="common_8h.html#e427fe9ee3c2843715dfbdb7d4c6cadc">CLEAR</a>( dISR, 1 &lt;&lt; bEndpoint );
<a name="l01036"></a>01036 
<a name="l01037"></a>01037                 <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( dISR != 0 ? <span class="stringliteral">"\n  + "</span> : <span class="stringliteral">""</span> );
<a name="l01038"></a>01038             }
<a name="l01039"></a>01039         }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041         <span class="comment">// Retrieve new interrupt status</span>
<a name="l01042"></a>01042         <span class="comment">//</span>
<a name="l01043"></a>01043         dISR = <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_ISR &amp; <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_IMR &amp; <a class="code" href="class_c_udp_driver.html#866f20c0f18912bec3c108d133b60a7ee4f8d15de5dc5195c6f80bf890a0d212">ISR_MASK</a>;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045         <span class="comment">// Mask unneeded interrupts</span>
<a name="l01046"></a>01046         <span class="comment">//</span>
<a name="l01047"></a>01047         <span class="keywordflow">if</span> ( ! <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd686dab2643f401ba95c901e7343a4d01" title="Default state.">USB_STATE_DEFAULT</a> ) )
<a name="l01048"></a>01048         {
<a name="l01049"></a>01049             dISR &amp;= ( AT91C_UDP_ENDBUSRES | AT91C_UDP_SOFINT );
<a name="l01050"></a>01050         }
<a name="l01051"></a>01051 
<a name="l01052"></a>01052         <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( dISR != 0 ? <span class="stringliteral">"\n  - "</span> : <span class="stringliteral">"\n"</span> );
<a name="l01053"></a>01053     }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055 <span class="preprocessor">#ifdef LED_USB</span>
<a name="l01056"></a>01056 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd60c8608e8150741f47d495e6c95416b6" title="Suspended state.">USB_STATE_SUSPENDED</a> ) &amp;&amp; <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#ba060d49b6d1b7150245405dec92a2e2" title="Poll the status of flags in dStatus register.">IsStateSet</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd3a9bc888354edfd6d7e8f504d85c23d5" title="Powered state.">USB_STATE_POWERED</a> ) )
<a name="l01057"></a>01057     {
<a name="l01058"></a>01058         AT91F_PIO_SetOutput( <a class="code" href="board_8h.html#1582be10c5c2c9cd8e68c5cc0854605c">LED_PIO</a>, <a class="code" href="board_8h.html#3b8254f78b4b200381597a437d0bcfcc">LED_USB</a> ); <span class="comment">// LED off</span>
<a name="l01059"></a>01059     }
<a name="l01060"></a>01060 <span class="preprocessor">#endif</span>
<a name="l01061"></a>01061 <span class="preprocessor"></span>}
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="9721403973d6af1963a444ab7c8ca162"></a><!-- doxytag: member="CUdpDriver::Connect" ref="9721403973d6af1963a444ab7c8ca162" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::Connect           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Connects the device to the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a>. 
<p>
Enables the pull-up on the D+ line to connect the device to the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a>.<p>
This method enables the pull-up resistor on the D+ line, notifying the host that the device wishes to connect to the bus. <dl class="see" compact><dt><b>See also:</b></dt><dd>USB_Disconnect </dd></dl>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#ad2cf37511b7f5cd6c27b799fd7c20eb">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01488">1488</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="class_u_s_b_1_1_c_board.html#5550fe5459fe574a081e2a9169902855">USB::CBoard::ConnectPullUp()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00767">USB::CUsbDriver::pBoard</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="common_8h-source.html#l00056">SET</a>, and <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">Attach()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01531">Init()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01489"></a>01489 {
<a name="l01490"></a>01490 <span class="preprocessor">#if defined(UDP_INTERNAL_PULLUP)</span>
<a name="l01491"></a>01491 <span class="preprocessor"></span>    <a class="code" href="common_8h.html#39117f457da20eccda8a38bdc5db3e83">SET</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_TXVC, AT91C_UDP_PUON );
<a name="l01492"></a>01492 
<a name="l01493"></a>01493 <span class="preprocessor">#elif defined(UDP_INTERNAL_PULLUP_BY_MATRIX)</span>
<a name="l01494"></a>01494 <span class="preprocessor"></span>    <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"PUON 1\n"</span> );
<a name="l01495"></a>01495     AT91C_BASE_MATRIX-&gt;MATRIX_USBPCR |= AT91C_MATRIX_USBPCR_PUON;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497 <span class="preprocessor">#else</span>
<a name="l01498"></a>01498 <span class="preprocessor"></span>    <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#64525692d796e77f889bf02d32487d18" title="Pointer to associated CBoard instance.">pBoard</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_board.html#5550fe5459fe574a081e2a9169902855" title="Enables the external pull-up on D+ associated with the specified USB controller.">ConnectPullUp</a> ();
<a name="l01499"></a>01499 
<a name="l01500"></a>01500 <span class="preprocessor">#endif</span>
<a name="l01501"></a>01501 <span class="preprocessor"></span>}
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="a42ff5ccc0e5a31aee80d2d837ccf67f"></a><!-- doxytag: member="CUdpDriver::Disconnect" ref="a42ff5ccc0e5a31aee80d2d837ccf67f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CUdpDriver::Disconnect           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [private, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Disconnects the device from the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a>. 
<p>
Disables the pull-up on the D+ line to disconnect the device from the bus.<p>
This method disables the pull-up resistor on the D+ line, notifying the host that the device wishes to disconnect from the bus. <dl class="see" compact><dt><b>See also:</b></dt><dd>USB_Connect </dd></dl>

<p>Implements <a class="el" href="class_u_s_b_1_1_c_usb_driver.html#cc9e26b895ca0b9b491a6357bf337514">USB::CUsbDriver</a>.</p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l01507">1507</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>References <a class="el" href="common_8h-source.html#l00057">CLEAR</a>, <a class="el" href="usb_framework_8hpp-source.html#l00800">USB::CUsbDriver::ClearState()</a>, <a class="el" href="class_u_s_b_1_1_c_board.html#da0b27b342d2be38a79afae503469d69">USB::CBoard::DisconnectPullUp()</a>, <a class="el" href="usb_framework_8hpp-source.html#l00767">USB::CUsbDriver::pBoard</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">pInterface</a>, <a class="el" href="trace_8h-source.html#l00055">TRACE_DEBUG_L</a>, and <a class="el" href="usb_framework_8hpp-source.html#l00350">USB::USB_STATE_DEFAULT</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">Attach()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l01531">Init()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01508"></a>01508 {
<a name="l01509"></a>01509 <span class="preprocessor">#if defined(UDP_INTERNAL_PULLUP)</span>
<a name="l01510"></a>01510 <span class="preprocessor"></span>    <a class="code" href="common_8h.html#e427fe9ee3c2843715dfbdb7d4c6cadc">CLEAR</a>( <a class="code" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6" title="Pointer to the USB controller peripheral.">pInterface</a>-&gt;UDP_TXVC, AT91C_UDP_PUON );
<a name="l01511"></a>01511 
<a name="l01512"></a>01512 <span class="preprocessor">#elif defined(UDP_INTERNAL_PULLUP_BY_MATRIX)</span>
<a name="l01513"></a>01513 <span class="preprocessor"></span>    <a class="code" href="trace_8h.html#1fbe8d4d788b8f5ce7fa7df444057d1b">TRACE_DEBUG_L</a>( <span class="stringliteral">"PUON 0\n"</span> );
<a name="l01514"></a>01514     AT91C_BASE_MATRIX-&gt;MATRIX_USBPCR &amp;= ~AT91C_MATRIX_USBPCR_PUON;
<a name="l01515"></a>01515 
<a name="l01516"></a>01516 <span class="preprocessor">#else</span>
<a name="l01517"></a>01517 <span class="preprocessor"></span>    <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#64525692d796e77f889bf02d32487d18" title="Pointer to associated CBoard instance.">pBoard</a>-&gt;<a class="code" href="class_u_s_b_1_1_c_board.html#da0b27b342d2be38a79afae503469d69" title="Disables the external pull-up on D+ associated with the specified USB controller...">DisconnectPullUp</a> ();
<a name="l01518"></a>01518 
<a name="l01519"></a>01519 <span class="preprocessor">#endif</span>
<a name="l01520"></a>01520 <span class="preprocessor"></span>    <span class="comment">// Device leaves the Default state</span>
<a name="l01521"></a>01521     <span class="comment">//</span>
<a name="l01522"></a>01522     <a class="code" href="class_u_s_b_1_1_c_usb_driver.html#1aab07c6a713076a742c535c0dec3d38" title="Clear flag(s) in dStatus register. If the method is called without arguments, it...">ClearState</a>( <a class="code" href="namespace_u_s_b.html#4b424fb02cb835b833b701f65aaa38bd686dab2643f401ba95c901e7343a4d01" title="Default state.">USB_STATE_DEFAULT</a> );
<a name="l01523"></a>01523 }
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Member Data Documentation</h2>
<a class="anchor" name="7b61d216dd49652668d71bdb2b3c95d6"></a><!-- doxytag: member="CUdpDriver::pInterface" ref="7b61d216dd49652668d71bdb2b3c95d6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">AT91PS_UDP <a class="el" href="class_c_udp_driver.html#7b61d216dd49652668d71bdb2b3c95d6">CUdpDriver::pInterface</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Pointer to the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00033">33</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l01328">Attach()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00066">ClearEndpointFlags()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00785">ConfigureEndpoint()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01488">Connect()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00048">CUdpDriver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00164">DisableTransceiver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01507">Disconnect()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00155">EnableTransceiver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00559">EndpointHandler()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00870">EventHandler()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00294">GetInterface()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00231">GetPayload()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01222">Halt()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01531">Init()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01148">Read()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01306">RemoteWakeUp()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01423">SetAddress()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01457">SetConfiguration()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00093">SetEndpointFlags()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l01081">Write()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l00182">WritePayload()</a>.</p>

</div>
</div><p>
<a class="anchor" name="6e21f491e8f4c50291fd14774509504c"></a><!-- doxytag: member="CUdpDriver::dID" ref="6e21f491e8f4c50291fd14774509504c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="el" href="class_c_udp_driver.html#6e21f491e8f4c50291fd14774509504c">CUdpDriver::dID</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
ID of the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00034">34</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00048">CUdpDriver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00128">DisableMCK()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00119">EnableMCK()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l00303">GetDriverID()</a>.</p>

</div>
</div><p>
<a class="anchor" name="18f89c2f3a4637bd9b4f1cfdfcd2301e"></a><!-- doxytag: member="CUdpDriver::dPMC" ref="18f89c2f3a4637bd9b4f1cfdfcd2301e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="common_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="el" href="class_c_udp_driver.html#18f89c2f3a4637bd9b4f1cfdfcd2301e">CUdpDriver::dPMC</a><code> [private]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
ID to enable the <a class="el" href="namespace_u_s_b.html" title="USB Framework namespace.">USB</a> controller peripheral clock. 
<p>

<p>Definition at line <a class="el" href="usb_u_d_p_8cpp-source.html#l00035">35</a> of file <a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a>.</p>

<p>Referenced by <a class="el" href="usb_u_d_p_8cpp-source.html#l00048">CUdpDriver()</a>, <a class="el" href="usb_u_d_p_8cpp-source.html#l00146">DisableUDPCK()</a>, and <a class="el" href="usb_u_d_p_8cpp-source.html#l00137">EnableUDPCK()</a>.</p>

</div>
</div><p>
<hr>The documentation for this class was generated from the following file:<ul>
<li>src/usb/<a class="el" href="usb_u_d_p_8cpp-source.html">usbUDP.cpp</a></ul>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Mar 10 02:42:34 2008 for XPU-DSAM7S by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
